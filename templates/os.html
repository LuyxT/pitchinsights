<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <!-- Cache Busting -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>PitchInsights OS</title>
    <link rel="manifest" href="/static/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #10b981;
            --primary-green-dark: #059669;
            --bg-light: #f5f5f7;
            --bg-dark: #1d1d1f;
            --text-light: #1d1d1f;
            --text-dark: #f5f5f7;
            --card-light: #ffffff;
            --card-dark: #2a2a2e;
            --border-light: #e5e5ea;
            --border-dark: #424245;

            /* ========================================
               APPLE-STYLE ANIMATION TOKENS
               Zentral anpassbare Animations-Dauern
               ======================================== */
            --anim-duration-fast: 120ms;
            /* Interaktions-Feedback */
            --anim-duration-normal: 220ms;
            /* Zustandswechsel */
            --anim-duration-slow: 280ms;
            /* Screen-Transitions */
            --anim-duration-stagger: 50ms;
            /* Staffelung zwischen Elementen */
            --anim-easing: cubic-bezier(0.25, 0.1, 0.25, 1);
            /* Apple-typisches Easing */
            --anim-easing-out: cubic-bezier(0, 0, 0.2, 1);
            /* Für Exits */
            --anim-slide-distance: 10px;
            /* Maximale Slide-Distanz */
        }

        /* ========================================
           APPLE-STYLE SKELETON LOADER
           Ruhige Platzhalter für Ladezustände
           ======================================== */
        .skeleton {
            background: linear-gradient(90deg,
                    rgba(128, 128, 128, 0.1) 0%,
                    rgba(128, 128, 128, 0.15) 50%,
                    rgba(128, 128, 128, 0.1) 100%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeletonShimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 20px;
            width: 60%;
            margin-bottom: 12px;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* Apple-Style: Reduzierte Bewegung für Accessibility */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color var(--anim-duration-slow) var(--anim-easing),
                color var(--anim-duration-slow) var(--anim-easing);
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
            --card-light: #2a2a2e;
            --border-light: #424245;
            --text-light: #f5f5f7;
            --bg-light: #1c1c1e;
            --video-thumb-bg: linear-gradient(135deg, #1a1a2e, #16213e);
        }

        .menubar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }

        body.dark-mode .menubar {
            background: rgba(29, 29, 31, 0.8);
            border-bottom-color: var(--border-dark);
        }

        .menu-logo {
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-green);
        }

        .menu-icons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .menu-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .menu-icon:hover {
            opacity: 1;
        }

        .os-container {
            display: flex;
            height: calc(100vh - 44px);
            width: 100%;
            margin-top: 44px;
            box-sizing: border-box;
        }

        .sidebar {
            width: 280px;
            min-width: 280px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            overflow-y: auto;
        }

        body.dark-mode .sidebar {
            background: rgba(29, 29, 31, 0.95);
            border-right-color: var(--border-dark);
        }

        .sidebar-section {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-mode .sidebar-section {
            border-bottom-color: var(--border-dark);
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.6;
            padding: 0 8px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .app-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            /* Apple-Style Sidebar Item Transition */
            transition: background var(--anim-duration-normal) var(--anim-easing),
                transform var(--anim-duration-fast) var(--anim-easing),
                color var(--anim-duration-normal) var(--anim-easing);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .app-item:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: translateX(4px);
        }

        /* Apple-Style: Tap/Click Feedback für Sidebar */
        .app-item:active {
            transform: scale(0.98) translateX(2px);
        }

        .app-item.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            color: var(--primary-green);
            font-weight: 600;
            border-left: 4px solid var(--primary-green);
            padding-left: 12px;
        }

        .app-icon-small {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .app-label {
            flex: 1;
        }

        .premium-badge {
            width: 20px;
            height: 20px;
            background: #ef4444;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: 700;
        }

        .app-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .app-item.locked:hover {
            background: transparent;
            transform: none;
        }

        .locked-badge {
            position: absolute;
            right: 10px;
            top: -8px;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
            white-space: nowrap;
        }

        .app-item.locked .premium-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-left: 10px;
            z-index: 100;
        }

        .app-item.locked .premium-tooltip::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.85);
        }

        .app-item.locked:hover .premium-tooltip {
            opacity: 1;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
            min-width: 0;
            position: relative;
        }

        .app-view {
            padding: 30px 40px;
            padding-bottom: 150px;
            display: none;
            width: 100%;
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(var(--anim-slide-distance));
            position: relative;
            min-height: 100%;
        }

        .app-view.active {
            display: block;
            animation: viewFadeSlideIn var(--anim-duration-slow) var(--anim-easing) forwards;
        }

        /* Apple-Style View Transition: Fade + subtle slide */
        @keyframes viewFadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(var(--anim-slide-distance));
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .subtitle {
            opacity: 0.7;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-light);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-light);
        }

        body.dark-mode .stat-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-green);
            margin: 8px 0;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .list-container {
            background: var(--card-light);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        body.dark-mode .list-container {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .list-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            /* Apple-Style List Item Transition */
            transition: background var(--anim-duration-normal) var(--anim-easing),
                transform var(--anim-duration-fast) var(--anim-easing);
        }

        /* Apple-Style: Tap/Click Feedback für List Items */
        .list-item:active {
            transform: scale(0.99);
            background: rgba(16, 185, 129, 0.08);
        }

        body.dark-mode .list-item {
            border-bottom-color: var(--border-dark);
        }

        .list-item:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .upload-area {
            background: var(--card-light);
            border: 2px dashed var(--primary-green);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 30px;
        }

        body.dark-mode .upload-area {
            background: var(--card-dark);
        }

        .upload-area:hover {
            background: rgba(16, 185, 129, 0.05);
            border-color: var(--primary-green-dark);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .heatmap-container {
            background: var(--card-light);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            padding: 20px;
            margin-bottom: 20px;
        }

        body.dark-mode .heatmap-container {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .heatmap-container img {
            width: 100%;
            border-radius: 8px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        body.dark-mode ::-webkit-scrollbar-thumb {
            background: var(--border-dark);
        }

        /* HOME SCREEN */
        .app-grid {
            position: relative;
            width: 100%;
            height: calc(100vh - 180px);
            min-height: 500px;
            background-image:
                linear-gradient(rgba(16, 185, 129, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.05) 1px, transparent 1px);
            background-size: 60px 60px;
            border-radius: 16px;
            overflow: hidden;
        }

        body.dark-mode .app-grid {
            background-image:
                linear-gradient(rgba(16, 185, 129, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.08) 1px, transparent 1px);
        }

        .app-tile {
            position: absolute;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100px;
            height: 100px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .app-tile:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }

        .app-tile:active {
            cursor: grabbing;
        }

        .app-tile.dragging {
            opacity: 0.8;
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
            z-index: 1000;
        }

        body.dark-mode .app-tile {
            background: var(--card-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .app-tile .app-icon {
            font-size: 36px;
            line-height: 1;
        }

        .app-tile .app-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-color);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90px;
        }

        .add-widget {
            position: absolute;
            background: var(--card-bg);
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100px;
            height: 100px;
        }

        .add-widget:hover {
            border-color: var(--primary-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .add-widget .add-icon {
            font-size: 28px;
            color: var(--secondary-text);
        }

        .add-widget .add-text {
            font-size: 10px;
            color: var(--secondary-text);
            text-align: center;
        }

        body.dark-mode .add-widget {
            border-color: var(--border-dark);
            background: var(--card-dark);
        }

        body.dark-mode .add-widget:hover {
            border-color: var(--primary-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .app-card {}

        .app-card {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: grab;
            padding: 16px;
            border-radius: 16px;
            /* Apple-Style Card Transition */
            transition: transform var(--anim-duration-normal) var(--anim-easing),
                box-shadow var(--anim-duration-normal) var(--anim-easing),
                background var(--anim-duration-normal) var(--anim-easing),
                opacity var(--anim-duration-normal) var(--anim-easing);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 140px;
            justify-content: center;
        }

        body.dark-mode .app-card {
            width: 140px;
            justify-content: center;
        }

        body.dark-mode .app-card {
            background: rgba(42, 42, 46, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .app-card:active {
            cursor: grabbing;
            /* Apple-Style: Tap Feedback */
            transform: scale(0.97);
        }

        .app-card.dragging {
            opacity: 0.8;
            transform: scale(1.05);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
            background: rgba(16, 185, 129, 0.15);
            z-index: 1000;
        }

        .app-card.drag-over {
            opacity: 0.9;
            background: rgba(16, 185, 129, 0.1);
            border: 2px dashed var(--primary-green);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        body.dark-mode .app-card {
            background: rgba(29, 29, 31, 0.5);
        }

        .app-card:hover {
            transform: scale(1.05);
            background: rgba(16, 185, 129, 0.1);
        }

        .app-card.coming-soon {
            opacity: 0.6;
            cursor: not-allowed !important;
            position: relative;
        }

        .app-card.coming-soon:hover {
            transform: scale(1);
            background: rgba(255, 255, 255, 0.8);
        }

        .coming-soon-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f59e0b;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .app-card.coming-soon::after {
            content: 'Coming Soon';
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        .app-card.coming-soon:hover::after {
            opacity: 1;
        }

        .app-icon-large {
            width: 100px;
            height: 100px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-green-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
            transition: transform 0.3s;
        }

        .app-card:hover .app-icon-large {
            transform: scale(1.1);
            box-shadow: 0 12px 24px rgba(16, 185, 129, 0.4);
        }

        .app-icon-large.premium {
            position: relative;
        }

        .app-icon-large.premium::after {
            content: "Noch nicht freigeschaltet";
            position: absolute;
            top: -8px;
            right: -10px;
            font-size: 9px;
            font-weight: bold;
            background: #ef4444;
            color: white;
            border-radius: 8px;
            padding: 3px 8px;
            white-space: nowrap;
        }

        .app-name {
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            max-width: 120px;
            word-wrap: break-word;
        }

        /* WIDGET SYSTEM */
        .widget-container {
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            transition: box-shadow 0.2s;
            min-width: 180px;
        }

        body.dark-mode .widget-container {
            background: rgba(42, 42, 46, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .widget-container:active {
            cursor: grabbing;
        }

        .widget-container.dragging {
            opacity: 0.8;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-light);
        }

        body.dark-mode .widget-header {
            color: var(--text-dark);
        }

        .widget-delete {
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            color: #ef4444;
            font-size: 18px;
            line-height: 1;
        }

        .widget-delete:hover {
            opacity: 1;
        }

        .widget-content {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-light);
        }

        body.dark-mode .widget-content {
            color: var(--text-dark);
        }

        .widget-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .widget-stat-label {
            opacity: 0.7;
        }

        .widget-stat-value {
            font-weight: 600;
            color: var(--primary-green);
        }

        .widget-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .widget-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .widget-item-icon {
            font-size: 18px;
        }

        /* Widget Week Grid (für Kalender Widget) */
        .widget-week-grid {
            display: flex;
            justify-content: space-between;
            gap: 4px;
        }

        .widget-week-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .widget-day-label {
            font-size: 10px;
            font-weight: 600;
            opacity: 0.6;
        }

        .widget-day-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-light);
        }

        .widget-day-dot.has-event {
            background: var(--primary-green);
        }

        .widget-day-dot.has-match {
            background: #ef4444;
        }

        body.dark-mode .widget-day-dot {
            background: var(--border-dark);
        }

        body.dark-mode .widget-day-dot.has-event {
            background: var(--primary-green);
        }

        /* Widget Clickable */
        .widget-container[data-app-id] {
            cursor: pointer;
        }

        .widget-container[data-app-id]:hover {
            transform: scale(1.02);
        }

        /* Status Dots für Widgets */
        .widget-content .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .widget-content .status-dot.fit {
            background: #22c55e;
        }

        .widget-content .status-dot.training {
            background: #3b82f6;
        }

        .widget-content .status-dot.reha {
            background: #f59e0b;
        }

        .widget-content .status-dot.ausfall {
            background: #ef4444;
        }

        .add-widget-btn {
            position: fixed !important;
            bottom: 30px !important;
            right: 30px !important;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none;
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5);
            transition: all 0.3s;
            display: none !important;
            align-items: center;
            justify-content: center;
            z-index: 99999 !important;
        }

        .add-widget-btn.is-visible {
            display: flex !important;
        }

        .add-widget-btn:hover {
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
            transform: scale(1.1);
        }

        .add-widget-btn:active {
            transform: scale(0.95);
        }

        /* CALENDAR STYLES */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .calendar-nav {
            display: flex;
            gap: 12px;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: rgba(16, 185, 129, 0.2);
            transform: scale(1.1);
        }

        .calendar-title {
            font-size: 20px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .calendar-grid {
            background: var(--card-light);
            border-radius: 16px;
            border: 1px solid var(--border-light);
            padding: 20px;
            margin-bottom: 30px;
        }

        body.dark-mode .calendar-grid {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .weekday {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.7;
            padding: 8px 0;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(16, 185, 129, 0.05);
            font-size: 14px;
            padding: 4px;
            position: relative;
            border: 1px solid transparent;
        }

        .day:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--primary-green);
        }

        .day-add-btn {
            position: absolute;
            bottom: 2px;
            width: 14px;
            height: 14px;
            padding: 0;
            font-size: 11px;
            font-weight: bold;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day:hover .day-add-btn {
            opacity: 1;
        }

        .day-add-btn:hover {
            transform: scale(1.2);
        }

        .day.today {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-green-dark));
            color: white;
            font-weight: 600;
        }

        .day.other-month {
            opacity: 0.3;
            cursor: default;
        }

        .day.other-month:hover {
            background: rgba(16, 185, 129, 0.05);
            border-color: transparent;
        }

        .day-event-dot {
            width: 5px;
            height: 5px;
            background: var(--primary-green);
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
            display: none;
        }

        .day.has-event .day-event-dot {
            display: block;
        }

        .events-container {
            margin-top: 30px;
        }

        .event-card {
            background: var(--card-light);
            border-radius: 12px;
            border-left: 4px solid var(--primary-green);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .event-card {
            background: var(--card-dark);
        }

        .event-card:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
            transform: translateX(4px);
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .event-date {
            font-size: 12px;
            opacity: 0.7;
        }

        .event-type {
            display: inline-block;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
            font-weight: 600;
            margin-top: 4px;
        }

        .event-type.match {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .event-type.training {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        /* VIEW BUTTONS */
        .view-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        body.dark-mode .view-btn {
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .view-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--primary-green);
        }

        .view-btn.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        /* WEEK VIEW */
        .week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .week-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(16, 185, 129, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            padding: 8px;
            position: relative;
        }

        .week-day:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--primary-green);
        }

        .week-day-add-btn {
            position: absolute;
            bottom: 2px;
            width: 16px;
            height: 16px;
            padding: 0;
            font-size: 12px;
            font-weight: bold;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .week-day:hover .week-day-add-btn {
            opacity: 1;
        }

        .week-day-add-btn:hover {
            transform: scale(1.2);
        }

        .week-day.today {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-green-dark));
            color: white;
        }

        /* YEAR VIEW */
        .year-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .year-month {
            background: var(--card-light);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            padding: 12px;
        }

        body.dark-mode .year-month {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .year-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .year-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            border-radius: 6px;
            background: rgba(16, 185, 129, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .year-day:hover {
            background: rgba(16, 185, 129, 0.15);
        }

        .year-day.has-event {
            background: var(--primary-green);
            color: white;
            font-weight: 600;
        }

        /* Day View Styles */
        .day-view {
            padding: 20px;
        }

        .day-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-green);
            color: var(--primary-green);
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
        }

        .time-slot {
            display: grid;
            grid-template-columns: 50px 1fr;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            min-height: 80px;
            align-items: flex-start;
            position: relative;
            z-index: 1;
        }

        body.dark-mode .time-slot {
            border-bottom-color: var(--border-dark);
        }

        .time-label {
            min-width: 50px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0.7;
            text-align: right;
            padding-right: 12px;
            padding-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        .time-slot:hover .time-label {
            opacity: 1;
        }

        .time-add-btn {
            min-width: 20px;
            height: 20px;
            padding: 0;
            font-size: 16px;
            font-weight: bold;
            background: transparent;
            color: var(--primary-green);
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-slot:hover .time-add-btn {
            opacity: 1;
        }

        .time-add-btn:hover {
            transform: scale(1.3);
        }

        .slot-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .timeline-event {
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--primary-green);
            cursor: grab;
            transition: all 0.2s;
            font-size: 14px;
            position: absolute;
            user-select: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 100;
            left: 62px;
            right: 12px;
            width: auto;
        }

        .timeline-event:active {
            cursor: grabbing;
        }

        .timeline-event:hover {
            background: rgba(16, 185, 129, 0.2);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .timeline-event.match {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .timeline-event.match:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .timeline-event.training {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .timeline-event.training:hover {
            background: rgba(245, 158, 11, 0.2);
        }

        .event-resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
            background: linear-gradient(180deg, transparent, rgba(16, 185, 129, 0.4));
            border-radius: 0 0 8px 8px;
            pointer-events: auto;
        }

        .timeline-event:hover .event-resize-handle {
            background: linear-gradient(180deg, transparent, rgba(16, 185, 129, 0.8));
        }

        .event-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            display: none;
            gap: 4px;
            flex-direction: row;
            z-index: 101;
        }

        .timeline-event:hover .event-actions {
            display: flex;
        }

        .event-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: rgba(16, 185, 129, 0.8);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .event-btn:hover {
            background: var(--primary-green);
            transform: scale(1.1);
        }

        .event-delete-btn {
            background: rgba(239, 68, 68, 0.8) !important;
        }

        .event-delete-btn:hover {
            background: #ef4444 !important;
        }

        .event-time {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 600;
        }

        .event-name {
            font-size: 13px;
            font-weight: 500;
        }

        .year-day.other-month {
            opacity: 0.2;
            cursor: default;
        }

        .year-day.other-month:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        /* GOODNOTES STYLE DRAWING TOOLS */
        .draw-tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .draw-tool-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .draw-tool-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .color-swatch:hover {
            transform: scale(1.15);
        }

        .color-swatch.active {
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .size-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .size-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .size-btn.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Hide native video fullscreen button */
        video::-webkit-media-controls-fullscreen-button {
            display: none !important;
        }

        video::-moz-full-screen-button {
            display: none !important;
        }

        /* Fullscreen styles */
        #videoContainer:fullscreen,
        #videoContainer:-webkit-full-screen {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #videoContainer:fullscreen #videoPreview,
        #videoContainer:-webkit-full-screen #videoPreview {
            max-height: 100vh !important;
            max-width: 100vw !important;
        }

        #videoContainer:fullscreen #drawCanvas,
        #videoContainer:-webkit-full-screen #drawCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #videoContainer:fullscreen #drawToolbar,
        #videoContainer:-webkit-full-screen #drawToolbar {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
        }

        #videoContainer:fullscreen #drawToggleSmall,
        #videoContainer:-webkit-full-screen #drawToggleSmall {
            position: fixed;
            bottom: 40px;
            right: 20px;
            z-index: 10000;
        }

        #videoContainer:fullscreen #fullscreenBtn,
        #videoContainer:-webkit-full-screen #fullscreenBtn {
            position: fixed;
            bottom: 40px;
            right: 72px;
            z-index: 10000;
        }

        /* WIDGET SELECTION MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            /* Apple-Style Modal Background Transition */
            opacity: 0;
            transition: opacity var(--anim-duration-slow) var(--anim-easing);
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--card-light);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            /* Apple-Style Modal Content Animation */
            transform: scale(0.95) translateY(8px);
            opacity: 0;
            transition: transform var(--anim-duration-slow) var(--anim-easing),
                opacity var(--anim-duration-slow) var(--anim-easing);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        body.dark-mode .modal-content {
            background: var(--card-dark);
        }

        /* Verwaltung Styles */
        .verwaltung-tab {
            padding: 10px 20px;
            background: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .verwaltung-tab:hover {
            background: var(--primary-color);
            color: white;
        }

        .verwaltung-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            /* Apple-Style Button Transition */
            transition: transform var(--anim-duration-fast) var(--anim-easing),
                opacity var(--anim-duration-fast) var(--anim-easing),
                box-shadow var(--anim-duration-normal) var(--anim-easing);
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Apple-Style: Tap/Click Feedback */
        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.85;
        }

        .btn-secondary {
            background: var(--card-light);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            /* Apple-Style Button Transition */
            transition: transform var(--anim-duration-fast) var(--anim-easing),
                background var(--anim-duration-normal) var(--anim-easing);
        }

        .btn-secondary:hover {
            background: var(--border-light);
        }

        /* Apple-Style: Tap/Click Feedback */
        .btn-secondary:active {
            transform: scale(0.98);
        }
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-light);
        }

        body.dark-mode .modal-title {
            color: var(--text-dark);
        }

        .widget-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .widget-option {
            padding: 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            /* Apple-Style Widget Option Transition */
            transition: border-color var(--anim-duration-normal) var(--anim-easing),
                background var(--anim-duration-normal) var(--anim-easing),
                transform var(--anim-duration-fast) var(--anim-easing);
        }

        /* Apple-Style: Tap/Click Feedback */
        .widget-option:active {
            transform: scale(0.98);
        }

        body.dark-mode .widget-option {
            border-color: var(--border-dark);
        }

        .widget-option:hover {
            border-color: var(--primary-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .widget-option-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-light);
        }

        body.dark-mode .widget-option-title {
            color: var(--text-dark);
        }

        .widget-option-desc {
            font-size: 12px;
            opacity: 0.7;
        }

        /* ========== APPLE-STYLE DASHBOARD ========== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 8px 0;
        }

        .dashboard-card {
            background: var(--card-light);
            border-radius: 16px;
            padding: 20px 24px;
            cursor: pointer;
            /* Apple-Style Dashboard Card Transition */
            transition: transform var(--anim-duration-normal) var(--anim-easing),
                box-shadow var(--anim-duration-normal) var(--anim-easing),
                opacity var(--anim-duration-normal) var(--anim-easing);
            border: 1px solid var(--border-light);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            /* Apple-Style Initial Load Animation */
            animation: cardFadeIn var(--anim-duration-slow) var(--anim-easing) forwards;
        }

        /* Apple-Style Stagger Animation für Dashboard Cards */
        .dashboard-card:nth-child(1) {
            animation-delay: 0ms;
        }

        .dashboard-card:nth-child(2) {
            animation-delay: calc(var(--anim-duration-stagger) * 1);
        }

        .dashboard-card:nth-child(3) {
            animation-delay: calc(var(--anim-duration-stagger) * 2);
        }

        .dashboard-card:nth-child(4) {
            animation-delay: calc(var(--anim-duration-stagger) * 3);
        }

        .dashboard-card:nth-child(5) {
            animation-delay: calc(var(--anim-duration-stagger) * 4);
        }

        .dashboard-card:nth-child(6) {
            animation-delay: calc(var(--anim-duration-stagger) * 5);
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        /* Apple-Style: Tap/Click Feedback */
        .dashboard-card:active {
            transform: scale(0.99);
        }

        body.dark-mode .dashboard-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        body.dark-mode .dashboard-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .dashboard-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .dashboard-card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #86868b;
        }

        body.dark-mode .dashboard-card-title {
            color: #a1a1a6;
        }

        .dashboard-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard-card-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .dashboard-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .dashboard-card-stat {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-light);
            line-height: 1.2;
        }

        body.dark-mode .dashboard-card-stat {
            color: var(--text-dark);
        }

        .dashboard-card-label {
            font-size: 14px;
            color: #86868b;
            margin-top: 4px;
        }

        body.dark-mode .dashboard-card-label {
            color: #a1a1a6;
        }

        .dashboard-card-preview {
            font-size: 13px;
            color: var(--text-light);
            opacity: 0.8;
            line-height: 1.5;
        }

        body.dark-mode .dashboard-card-preview {
            color: var(--text-dark);
        }

        .dashboard-stat-row {
            display: flex;
            gap: 24px;
            margin-top: 8px;
        }

        .dashboard-stat-item {
            display: flex;
            flex-direction: column;
        }

        .dashboard-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .dashboard-stat-value {
            color: var(--text-dark);
        }

        .dashboard-stat-label {
            font-size: 12px;
            color: #86868b;
            margin-top: 2px;
        }

        body.dark-mode .dashboard-stat-label {
            color: #a1a1a6;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-dot.fit {
            background: #34c759;
        }

        .status-dot.limited {
            background: #ff9500;
        }

        .status-dot.injured {
            background: #ff3b30;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 8px;
            width: 100%;
        }

        .week-day {
            text-align: center;
            font-size: 11px;
            color: #86868b;
            padding: 6px 2px;
            min-width: 0;
            background: rgba(128, 128, 128, 0.1);
            border-radius: 8px;
        }

        .week-day.today {
            background: rgba(0, 122, 255, 0.2);
            color: #007aff;
        }

        body.dark-mode .week-day {
            color: #a1a1a6;
        }

        body.dark-mode .week-day.today {
            color: #007aff;
        }

        .week-day-label {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 10px;
        }

        /* Premium cards - hidden by default, shown when purchased */
        .dashboard-card.premium-module {
            display: none;
        }

        .dashboard-card.premium-module.unlocked {
            display: flex;
        }

        .week-day-events {
            min-height: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #007aff;
        }

        .event-dot.training {
            background: #34c759;
        }

        .event-dot.match {
            background: #ff3b30;
        }

        .message-preview {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-top: 8px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-sender {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .message-sender {
            color: var(--text-dark);
        }

        .message-text {
            font-size: 13px;
            color: #86868b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        body.dark-mode .message-text {
            color: #a1a1a6;
        }

        .message-time {
            font-size: 12px;
            color: #86868b;
            flex-shrink: 0;
        }

        body.dark-mode .message-time {
            color: #a1a1a6;
        }

        .dashboard-placeholder {
            color: #86868b;
            font-size: 13px;
            font-style: italic;
        }

        body.dark-mode .dashboard-placeholder {
            color: #a1a1a6;
        }

        /* ========== RESPONSIVE DESIGN - ALLE GERÄTE ========== */

        /* iPad Pro Landscape & große Tablets (1024px - 1366px) */
        @media (max-width: 1366px) {
            .sidebar {
                width: 240px;
                min-width: 240px;
            }

            .app-view {
                padding: 24px 40px;
                padding-bottom: 150px;
            }
        }

        /* iPad & Tablets (768px - 1024px) */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
                min-width: 200px;
            }

            .app-view {
                padding: 20px 30px;
                padding-bottom: 150px;
            }

            .dashboard-card {
                min-width: 180px;
            }
        }

        /* iPad Portrait & große Handys (600px - 768px) */
        @media (max-width: 768px) {
            .os-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--border-light);
                padding: 10px 0;
                display: none;
            }

            .sidebar.mobile-open {
                display: flex;
            }

            .sidebar-section {
                padding: 10px 8px;
            }

            .app-item {
                padding: 10px 12px;
                font-size: 13px;
            }

            .app-view {
                padding: 16px 20px;
                padding-bottom: 150px;
            }

            /* Kader Charts Mobile - Stack vertikal */
            #kader>div[style*="display: grid"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
            }

            .kader-card {
                width: 100% !important;
            }

            /* Messenger Mobile - Stack vertikal */
            #messenger>div[style*="display: flex"][style*="gap: 20px"] {
                flex-direction: column !important;
                height: auto !important;
            }

            #messenger>div[style*="display: flex"]>div:first-child {
                flex: none !important;
                width: 100% !important;
                max-height: 300px !important;
            }

            #messenger>div[style*="display: flex"]>div:last-child {
                min-height: 400px !important;
            }

            /* Kalender Header Mobile */
            .calendar-header {
                flex-wrap: wrap !important;
                gap: 10px !important;
            }

            .calendar-nav {
                order: 1;
            }

            .calendar-title {
                order: 2;
                min-width: 150px !important;
                font-size: 16px !important;
            }

            .view-toggle {
                order: 3;
                width: 100%;
                justify-content: center;
            }

            .view-btn {
                flex: 1;
                max-width: 100px;
            }

            /* Home Grid Mobile */
            .app-grid {
                display: flex !important;
                flex-wrap: wrap;
                gap: 12px;
                padding: 16px;
                justify-content: center;
                align-content: flex-start;
                height: auto !important;
                min-height: 200px !important;
                overflow: visible !important;
            }

            .app-tile,
            .add-widget {
                position: static !important;
                width: 90px;
                height: 90px;
                left: auto !important;
                top: auto !important;
                cursor: pointer !important;
            }

            .app-tile .app-icon {
                font-size: 28px;
            }

            .app-tile .app-name {
                font-size: 10px;
            }

            .menubar {
                padding: 0 12px;
            }

            .menu-logo {
                font-size: 14px;
            }

            /* Mobile Menu Button */
            .mobile-menu-btn {
                display: flex !important;
            }

            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .dashboard-card {
                min-width: unset;
            }
        }

        /* Handys (425px - 600px) */
        @media (max-width: 600px) {
            .app-view {
                padding: 12px 16px;
                padding-bottom: 150px;
            }

            /* Kader: Charts kleinere Höhe */
            .kader-card>div[style*="height: 300px"] {
                height: 200px !important;
            }

            /* Kalender Grid kleiner */
            .calendar-grid {
                padding: 12px !important;
            }

            .day-cell {
                min-height: 36px !important;
                font-size: 12px !important;
            }

            .weekday {
                font-size: 10px !important;
            }

            .app-grid {
                display: flex !important;
                flex-wrap: wrap;
                gap: 10px;
                padding: 12px;
                height: auto !important;
                min-height: 150px !important;
            }

            .app-tile,
            .add-widget {
                position: static !important;
                width: 80px;
                height: 80px;
                padding: 12px;
                left: auto !important;
                top: auto !important;
            }

            .app-tile .app-icon {
                font-size: 24px;
            }

            .app-tile .app-name {
                font-size: 9px;
                max-width: 70px;
            }

            .sidebar {
                max-height: 60vh;
            }

            .sidebar-title {
                font-size: 10px;
                padding: 0 6px;
            }

            .app-item {
                padding: 8px 10px;
                gap: 8px;
            }

            .app-icon-small {
                font-size: 16px;
                width: 20px;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .menubar {
                height: 48px;
                padding: 0 10px;
            }

            .os-container {
                padding-top: 48px;
            }

            .menu-icons {
                gap: 8px;
            }

            .menu-icon {
                width: 22px;
                height: 22px;
            }
        }

        /* Kleine Handys (375px und kleiner) */
        @media (max-width: 375px) {
            .app-view {
                padding: 10px 12px;
                padding-bottom: 150px;
            }

            .menu-logo span:not(.logo-icon) {
                display: none;
            }

            .sidebar-section {
                padding: 8px 6px;
            }

            .app-item {
                padding: 8px;
                font-size: 12px;
            }

            .app-label {
                font-size: 12px;
            }
        }

        /* Touch-optimierte Elemente */
        @media (hover: none) and (pointer: coarse) {
            .app-item {
                min-height: 44px;
            }

            .menu-icon {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            button,
            .btn,
            [role="button"] {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Landscape-Modus für Handys */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar {
                max-height: 100vh;
                width: 180px;
            }

            .os-container {
                flex-direction: row;
            }

            .sidebar.mobile-open {
                position: fixed;
                left: 0;
                top: 44px;
                bottom: 0;
                z-index: 999;
            }

            .app-item {
                padding: 6px 10px;
            }
        }

        /* PWA Standalone Mode */
        @media (display-mode: standalone) {
            .menubar {
                padding-top: env(safe-area-inset-top);
                height: calc(44px + env(safe-area-inset-top));
            }

            .os-container {
                padding-top: calc(44px + env(safe-area-inset-top));
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Mobile Menu Button (hidden by default) */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--text-light);
        }

        body.dark-mode .mobile-menu-btn {
            color: var(--text-dark);
        }

        /* ========== TAKTIK-TAFEL STYLES ========== */
        :root {
            --team-own: #3a7bd5;
            --team-opponent: #e85d4c;
        }

        .taktik-content {
            display: flex;
            flex-direction: column;
            padding: 24px;
            gap: 16px;
            overflow-y: auto;
            height: 100%;
            box-sizing: border-box;
        }

        .taktik-toolbar {
            background: var(--card-light);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-label {
            font-size: 13px;
            opacity: 0.6;
            font-weight: 500;
        }

        .taktik-switch {
            position: relative;
            width: 51px;
            height: 31px;
            cursor: pointer;
        }

        .taktik-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .taktik-switch-slider {
            position: absolute;
            inset: 0;
            background: #e9e9eb;
            border-radius: 31px;
            transition: background 0.3s;
        }

        .taktik-switch-slider::before {
            content: '';
            position: absolute;
            width: 27px;
            height: 27px;
            left: 2px;
            top: 2px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .taktik-switch input:checked+.taktik-switch-slider {
            background: #34c759;
        }

        .taktik-switch input:checked+.taktik-switch-slider::before {
            transform: translateX(20px);
        }

        .taktik-segmented-control {
            display: flex;
            background: #e9e9eb;
            border-radius: 8px;
            padding: 2px;
        }

        body.dark-mode .taktik-segmented-control {
            background: #3a3a3c;
        }

        .taktik-segment {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: inherit;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .taktik-segment.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .taktik-segment.active {
            background: #5a5a5c;
        }

        .taktik-btn-action {
            background: #e9e9eb;
        }

        body.dark-mode .taktik-btn-action {
            background: #3a3a3c;
        }

        .taktik-btn-delete {
            background: #e9e9eb;
            color: #ff3b30;
        }

        body.dark-mode .taktik-btn-delete {
            background: #3a3a3c;
            color: #ff453a;
        }

        .canvas-container {
            flex: 1 1 auto;
            background: var(--card-light);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            min-height: 400px;
            position: relative;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 1000px;
            aspect-ratio: 16/10;
        }

        #fieldCanvas,
        #drawCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        #fieldCanvas {
            z-index: 1;
        }

        #drawCanvas {
            z-index: 2;
            pointer-events: none;
        }

        .player-marker {
            position: absolute;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            cursor: grab;
            user-select: none;
            z-index: 20;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            touch-action: none;
        }

        .player-marker:hover {
            transform: scale(1.1);
        }

        .player-marker.dragging {
            cursor: grabbing;
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
            z-index: 100;
        }

        .player-marker.own-team {
            background: var(--team-own);
        }

        .player-marker.opponent-team {
            background: var(--team-opponent);
        }

        .player-marker .player-name {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            color: var(--text-light);
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .draw-toggle-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .draw-toggle-btn:hover {
            transform: scale(1.05);
        }

        .draw-toggle-btn.active {
            background: #10b981;
        }

        .draw-toggle-btn svg {
            color: white;
        }

        .draw-toolbar {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .draw-toolbar.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .draw-tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.15s;
        }

        .draw-tool-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .draw-tool-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .color-swatch:hover {
            transform: scale(1.15);
        }

        .color-swatch.active {
            border-color: white;
        }

        .size-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .size-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .size-btn.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Video Marker Styles */
        .video-marker-item:hover {
            background: var(--card-light) !important;
            transform: translateX(4px);
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 4px;
        }
    </style>
</head>

<body>
    <div class="menubar">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menü öffnen">☰</button>
        <div class="menu-logo" id="appLogo">⚽ PitchInsights</div>
        <div class="menu-icons">
            <svg class="menu-icon" onclick="toggleTheme()" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="5" />
                <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" />
                <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" />
            </svg>
        </div>
    </div>

    <div class="os-container">
        <div class="sidebar" id="mobileSidebar">
            <!-- DYNAMIC SIDEBAR - Rendered by JS -->
            <div id="sidebarModules">
                <!-- Wird dynamisch gefüllt -->
            </div>

            <!-- SETTINGS & STORE -->
            <div class="sidebar-section" style="margin-top: auto;">
                <div class="app-item" onclick="switchApp('store')">
                    <div class="app-icon-small">🛒</div>
                    <div class="app-label">App Store</div>
                </div>
                <div class="app-item" onclick="switchApp('settings')">
                    <div class="app-icon-small">⚙️</div>
                    <div class="app-label">Einstellungen</div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <!-- APP STORE -->
            <div id="store" class="app-view">
                <h1>🛒 App Store</h1>
                <p class="subtitle">Wähle die Apps für deine Sidebar & Home</p>

                <div style="margin-top: 20px;">
                    <h2 style="font-size: 18px; margin-bottom: 16px; color: var(--text-color);">📱 Kostenlose Apps
                    </h2>
                    <div id="storeAppsGrid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h2 style="font-size: 18px; margin-bottom: 16px; color: #8b5cf6;">💎 Premium Apps</h2>
                    <div id="storePremiumGrid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h2 style="font-size: 18px; margin-bottom: 16px; color: #f59e0b;">🚀 Bald verfügbar</h2>
                    <div id="storeComingSoonGrid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                </div>
            </div>

            <!-- HOME SCREEN -->
            <div id="home" class="app-view active">
                <h1>Home</h1>
                <p class="subtitle">Deine Apps & Widgets</p>

                <!-- NO TEAM NOTICE -->
                <div id="noTeamNotice"
                    style="display: none; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 30px; margin-bottom: 24px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">⚽</div>
                    <h2 style="font-size: 22px; margin-bottom: 8px;">Noch kein Team</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Erstelle dein Team um loszulegen!
                    </p>
                    <button onclick="showCreateTeamModal()"
                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 14px 28px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                        Team erstellen
                    </button>
                </div>

                <!-- CREATE TEAM MODAL -->
                <div id="createTeamModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                    <div
                        style="background: var(--card-light); border-radius: 20px; padding: 30px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h2 style="margin-bottom: 8px; font-size: 22px;">Team erstellen</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px;">Pro Account
                            ist nur ein Team erlaubt.</p>

                        <div style="margin-bottom: 16px;">
                            <label
                                style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Vereinsname</label>
                            <input type="text" id="createTeamVerein" placeholder="z.B. FC Beispiel"
                                style="width: 100%; padding: 12px 14px; border: 1px solid var(--border-light); border-radius: 10px; font-size: 16px; background: var(--bg-light); color: var(--text-light);">
                        </div>

                        <div style="margin-bottom: 24px;">
                            <label
                                style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Mannschaft</label>
                            <input type="text" id="createTeamMannschaft" placeholder="z.B. 1. Herren"
                                style="width: 100%; padding: 12px 14px; border: 1px solid var(--border-light); border-radius: 10px; font-size: 16px; background: var(--bg-light); color: var(--text-light);">
                        </div>

                        <div id="createTeamError"
                            style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 10px 14px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;">
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button onclick="hideCreateTeamModal()"
                                style="flex: 1; padding: 14px; border: 1px solid var(--border-light); background: transparent; border-radius: 10px; font-size: 16px; cursor: pointer; color: var(--text-light);">Abbrechen</button>
                            <button onclick="submitCreateTeam()"
                                style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">Erstellen</button>
                        </div>
                    </div>
                </div>

                <!-- ADD MANNSCHAFT PREMIUM MODAL -->
                <div id="addMannschaftModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
                    <div
                        style="background: var(--card-light); border-radius: 24px; padding: 40px; width: 90%; max-width: 480px; box-shadow: 0 25px 80px rgba(0,0,0,0.4); text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">⭐</div>
                        <h2
                            style="margin-bottom: 12px; font-size: 26px; background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            PitchInsights Pro</h2>
                        <p
                            style="color: var(--text-secondary); margin-bottom: 28px; font-size: 16px; line-height: 1.6;">
                            Verwalte mehrere Mannschaften mit einem Account. Perfekt für Vereine mit verschiedenen
                            Teams!</p>

                        <div
                            style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 28px;">
                            <div style="font-size: 36px; font-weight: 700; color: #f59e0b; margin-bottom: 4px;">
                                20€<span
                                    style="font-size: 16px; font-weight: 400; color: var(--text-secondary);">/Monat</span>
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary);">pro zusätzlicher Mannschaft
                            </div>
                        </div>

                        <ul style="text-align: left; margin-bottom: 28px; font-size: 15px; color: var(--text-light);">
                            <li style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;"><span
                                    style="color: #22c55e;">✓</span> Unbegrenzte Spieler pro Mannschaft</li>
                            <li style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;"><span
                                    style="color: #22c55e;">✓</span> Separate Kalender & Statistiken</li>
                            <li style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;"><span
                                    style="color: #22c55e;">✓</span> Eigene Mannschaftskasse</li>
                            <li style="display: flex; align-items: center; gap: 10px;"><span
                                    style="color: #22c55e;">✓</span> Prioritäts-Support</li>
                        </ul>

                        <div style="display: flex; gap: 12px;">
                            <button onclick="hideAddMannschaftModal()"
                                style="flex: 1; padding: 16px; border: 1px solid var(--border-light); background: transparent; border-radius: 12px; font-size: 16px; cursor: pointer; color: var(--text-light);">Später</button>
                            <button onclick="startProUpgrade()"
                                style="flex: 1.5; padding: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>Jetzt upgraden</span>
                                <span style="font-size: 18px;">→</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="app-grid" id="appGrid">
                    <!-- Wird dynamisch durch renderHomeGrid() gefüllt -->
                </div>
            </div>

            <!-- MEIN PROFIL -->
            <style>
                .profil-card {
                    background: var(--card-light);
                    border: 1px solid var(--border-light);
                    border-radius: 16px;
                    padding: 24px;
                    /* Apple-Style Profil Card Transition */
                    transition: transform var(--anim-duration-normal) var(--anim-easing),
                        box-shadow var(--anim-duration-normal) var(--anim-easing),
                        border-color var(--anim-duration-normal) var(--anim-easing);
                }

                .profil-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
                }

                body.dark-mode .profil-card {
                    background: var(--card-dark);
                    border-color: var(--border-dark);
                }

                body.dark-mode .profil-card:hover {
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
                }

                .profil-avatar {
                    width: 120px;
                    height: 120px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 48px;
                    color: white;
                    margin: 0 auto 20px;
                    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
                    /* Apple-Style Avatar Transition */
                    transition: transform var(--anim-duration-normal) var(--anim-easing),
                        box-shadow var(--anim-duration-normal) var(--anim-easing);
                }

                .profil-avatar:hover {
                    transform: scale(1.03);
                    box-shadow: 0 6px 24px rgba(59, 130, 246, 0.4);
                }

                .profil-field {
                    margin-bottom: 16px;
                }

                .profil-field label {
                    display: block;
                    font-size: 12px;
                    color: var(--text-light);
                    opacity: 0.7;
                    margin-bottom: 6px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }

                .profil-field input,
                .profil-field select {
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid var(--border-light);
                    border-radius: 8px;
                    background: var(--card-light);
                    color: var(--text-light);
                    font-size: 15px;
                    box-sizing: border-box;
                    transition: border-color 0.2s;
                }

                body.dark-mode .profil-field input,
                body.dark-mode .profil-field select {
                    background: var(--bg-dark);
                    border-color: var(--border-dark);
                    color: var(--text-dark);
                }

                .profil-field input:focus,
                .profil-field select:focus {
                    outline: none;
                    border-color: #3b82f6;
                }

                .profil-field input:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                }

                .profil-team-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
                    border: 1px solid rgba(16, 185, 129, 0.3);
                    padding: 12px 20px;
                    border-radius: 12px;
                    font-size: 14px;
                }

                .profil-kader-link {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 16px;
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
                    border: 1px solid rgba(59, 130, 246, 0.3);
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s;
                }

                .profil-kader-link:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
                }
            </style>
            <div id="profil" class="app-view">
                <h1>👤 Mein Profil</h1>
                <p class="subtitle">Deine persönlichen Daten verwalten</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1000px;">
                    <!-- Linke Spalte: Basis-Profil -->
                    <div class="profil-card">
                        <div class="profil-avatar" id="profilAvatar">👤</div>
                        <h3 style="text-align: center; margin-bottom: 24px; font-size: 18px;">Persönliche Daten</h3>

                        <div class="profil-field">
                            <label>Email</label>
                            <input type="email" id="profilEmail" disabled>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="profil-field">
                                <label>Vorname</label>
                                <input type="text" id="profilVorname" placeholder="Dein Vorname">
                            </div>
                            <div class="profil-field">
                                <label>Nachname</label>
                                <input type="text" id="profilNachname" placeholder="Dein Nachname">
                            </div>
                        </div>

                        <div class="profil-field">
                            <label>Telefon</label>
                            <input type="tel" id="profilTelefon" placeholder="+49 123 456789">
                        </div>

                        <div class="profil-field">
                            <label>Geburtsdatum</label>
                            <input type="date" id="profilGeburtsdatum">
                        </div>

                        <div class="profil-field">
                            <label>Werdegang / Beschreibung</label>
                            <textarea id="profilWerdegang" placeholder="Beschreibe deinen fußballerischen Werdegang..."
                                style="width: 100%; min-height: 100px; padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                        </div>
                    </div>

                    <!-- Rechte Spalte: Rollenspezifische Daten -->
                    <div>
                        <!-- TEAM MANAGER (nur Hauptadmin) -->
                        <div class="profil-card" id="teamManagerCard" style="margin-bottom: 20px; display: none;">
                            <h3 style="margin-bottom: 12px; font-size: 18px;">🏟️ Mannschaften</h3>
                            <div id="teamList"
                                style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                                <span style="opacity: 0.7; font-size: 13px;">Lade Mannschaften...</span>
                            </div>
                            <div id="teamCreateSection">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Neue Mannschaft</label>
                                <input type="text" id="newMannschaftName" class="input-field"
                                    placeholder="z.B. U19 / 2. Herren">
                                <button class="btn-primary" style="margin-top: 12px;"
                                    onclick="createAdditionalTeam()">Mannschaft anlegen</button>
                                <div id="teamCreateError"
                                    style="margin-top: 10px; font-size: 12px; color: #ef4444; display: none;"></div>
                            </div>
                        </div>

                        <!-- PROFIL-TYP WÄHLER (für Admin sichtbar) -->
                        <div class="profil-card" id="profilTypWaehler" style="margin-bottom: 20px; display: none;">
                            <h3 style="margin-bottom: 16px; font-size: 18px;">🎭 Profil-Typ</h3>
                            <p style="font-size: 13px; opacity: 0.7; margin-bottom: 12px;">
                                Als Admin kannst du wählen, welche Profilfelder du bearbeiten möchtest:
                            </p>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="setProfilTyp('trainer')" id="btnProfilTrainer"
                                    style="flex: 1; padding: 12px; border: 2px solid var(--border-light); border-radius: 10px; background: transparent; color: var(--text-light); cursor: pointer; font-size: 14px; transition: all 0.2s;">
                                    🎯 Trainer
                                </button>
                                <button onclick="setProfilTyp('spieler')" id="btnProfilSpieler"
                                    style="flex: 1; padding: 12px; border: 2px solid var(--border-light); border-radius: 10px; background: transparent; color: var(--text-light); cursor: pointer; font-size: 14px; transition: all 0.2s;">
                                    ⚽ Spieler
                                </button>
                            </div>
                        </div>

                        <!-- SPIELER-PROFIL (nur für Spieler sichtbar) -->
                        <div class="profil-card spieler-profil" id="spielerProfilCard"
                            style="margin-bottom: 20px; display: none;">
                            <h3 style="margin-bottom: 20px; font-size: 18px;">⚽ Spieler-Daten</h3>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="profil-field">
                                    <label>Größe (cm)</label>
                                    <input type="number" id="profilGroesse" placeholder="z.B. 180" min="100" max="250">
                                </div>
                                <div class="profil-field">
                                    <label>Gewicht (kg)</label>
                                    <input type="number" id="profilGewicht" placeholder="z.B. 75" min="30" max="200">
                                </div>
                            </div>

                            <div class="profil-field">
                                <label>Position</label>
                                <select id="profilPosition">
                                    <option value="">Bitte wählen</option>
                                    <option value="Torwart">Torwart</option>
                                    <option value="Innenverteidiger">Innenverteidiger</option>
                                    <option value="Außenverteidiger">Außenverteidiger</option>
                                    <option value="Defensives Mittelfeld">Defensives Mittelfeld</option>
                                    <option value="Zentrales Mittelfeld">Zentrales Mittelfeld</option>
                                    <option value="Offensives Mittelfeld">Offensives Mittelfeld</option>
                                    <option value="Flügelspieler">Flügelspieler</option>
                                    <option value="Stürmer">Stürmer</option>
                                </select>
                            </div>

                            <div class="profil-field">
                                <label>Nebenpositionen</label>
                                <input type="text" id="profilNebenpositionen" placeholder="z.B. Rechtsaußen, Stürmer">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="profil-field">
                                    <label>Starker Fuß</label>
                                    <select id="profilStarkerFuss">
                                        <option value="">Bitte wählen</option>
                                        <option value="rechts">Rechts</option>
                                        <option value="links">Links</option>
                                        <option value="beidfuessig">Beidfüßig</option>
                                    </select>
                                </div>
                                <div class="profil-field">
                                    <label>Jahrgang</label>
                                    <input type="number" id="profilJahrgang" placeholder="z.B. 2005" min="1950"
                                        max="2025">
                                </div>
                            </div>
                        </div>

                        <!-- TRAINER-PROFIL (nur für Trainer sichtbar) -->
                        <div class="profil-card trainer-profil" id="trainerProfilCard"
                            style="margin-bottom: 20px; display: none;">
                            <h3 style="margin-bottom: 20px; font-size: 18px;">🎯 Trainer-Daten</h3>

                            <div class="profil-field">
                                <label>Bevorzugtes Spielsystem</label>
                                <select id="profilSpielsystem">
                                    <option value="">Bitte wählen</option>
                                    <option value="4-4-2">4-4-2</option>
                                    <option value="4-3-3">4-3-3</option>
                                    <option value="4-2-3-1">4-2-3-1</option>
                                    <option value="3-5-2">3-5-2</option>
                                    <option value="3-4-3">3-4-3</option>
                                    <option value="5-3-2">5-3-2</option>
                                    <option value="4-1-4-1">4-1-4-1</option>
                                    <option value="Flexibel">Flexibel</option>
                                </select>
                            </div>

                            <div class="profil-field">
                                <label>Taktische Grundidee</label>
                                <textarea id="profilTaktischeGrundidee"
                                    placeholder="Beschreibe deine taktische Philosophie..."
                                    style="width: 100%; min-height: 80px; padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                            </div>

                            <div class="profil-field">
                                <label>Trainingsschwerpunkte</label>
                                <input type="text" id="profilTrainingsschwerpunkte"
                                    placeholder="z.B. Pressing, Spielaufbau, Standards">
                            </div>

                            <div class="profil-field">
                                <label>Bisherige Stationen</label>
                                <textarea id="profilBisherigeStationen"
                                    placeholder="Deine bisherigen Vereine als Trainer..."
                                    style="width: 100%; min-height: 80px; padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                            </div>

                            <div class="profil-field">
                                <label>Lizenzen / Ausbildung</label>
                                <input type="text" id="profilLizenzen"
                                    placeholder="z.B. B-Lizenz, DFB-Elite-Jugend-Lizenz">
                            </div>
                        </div>

                        <!-- Team-Zugehörigkeit -->
                        <div class="profil-card" style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 20px; font-size: 18px;">⚽ Team-Zugehörigkeit</h3>

                            <div id="profilTeamInfo">
                                <p style="color: var(--text-light); opacity: 0.7;">Laden...</p>
                            </div>
                        </div>

                        <!-- Speichern-Button -->
                        <button onclick="saveProfile()"
                            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; margin-bottom: 20px;">
                            💾 Profil speichern
                        </button>

                        <!-- Gefahrenzone -->
                        <div class="profil-card" style="border-color: rgba(239, 68, 68, 0.3);">
                            <h3 style="margin-bottom: 16px; font-size: 18px; color: #ef4444;">⚠️ Gefahrenzone</h3>
                            <p style="font-size: 13px; color: var(--text-light); opacity: 0.7; margin-bottom: 16px;">
                                Wenn du dein Konto löschst, werden alle deine Daten unwiderruflich entfernt.
                            </p>
                            <button onclick="confirmDeleteAccount()"
                                style="padding: 10px 20px; background: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                Account löschen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDGET SELECTION MODAL -->
            <div class="modal-overlay" id="widgetModal">
                <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
                    <div class="modal-title">Widget hinzufügen</div>
                    <p style="font-size: 13px; opacity: 0.7; margin-bottom: 16px;">Wähle ein Widget für deinen
                        Homescreen</p>

                    <h4
                        style="font-size: 12px; text-transform: uppercase; opacity: 0.6; margin: 16px 0 8px; letter-spacing: 1px;">
                        📱 App Widgets</h4>
                    <div class="widget-options">
                        <div class="widget-option" onclick="addWidget('kader')">
                            <div class="widget-option-title">👥 Kader</div>
                            <div class="widget-option-desc">Spieler-Status auf einen Blick</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('kalender')">
                            <div class="widget-option-title">📅 Kalender</div>
                            <div class="widget-option-desc">Wochenübersicht der Events</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('messenger')">
                            <div class="widget-option-title">💬 Messenger</div>
                            <div class="widget-option-desc">Letzte Nachrichten</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('kasse')">
                            <div class="widget-option-title">💵 Mannschaftskasse</div>
                            <div class="widget-option-desc">Aktueller Kontostand</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('taktik')">
                            <div class="widget-option-title">⚽ Taktik</div>
                            <div class="widget-option-desc">Schnellzugriff auf Taktik-Tafel</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('upload')">
                            <div class="widget-option-title">📹 Videos</div>
                            <div class="widget-option-desc">Hochgeladene Videos</div>
                        </div>
                    </div>

                    <h4
                        style="font-size: 12px; text-transform: uppercase; opacity: 0.6; margin: 20px 0 8px; letter-spacing: 1px;">
                        💎 Premium Widgets</h4>
                    <div class="widget-options">
                        <div class="widget-option" onclick="addWidget('analyse')">
                            <div class="widget-option-title">📈 Analyse</div>
                            <div class="widget-option-desc">Video-Analyse Ergebnisse</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('training')">
                            <div class="widget-option-title">🏋️ Training</div>
                            <div class="widget-option-desc">Nächste Trainingseinheiten</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('medizin')">
                            <div class="widget-option-title">⚕️ Medizin</div>
                            <div class="widget-option-desc">Verletzungsübersicht</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('finanzen')">
                            <div class="widget-option-title">💰 Finanzen</div>
                            <div class="widget-option-desc">Finanzübersicht</div>
                        </div>
                    </div>

                    <h4
                        style="font-size: 12px; text-transform: uppercase; opacity: 0.6; margin: 20px 0 8px; letter-spacing: 1px;">
                        🔧 Utility Widgets</h4>
                    <div class="widget-options">
                        <div class="widget-option" onclick="addWidget('quick_links')">
                            <div class="widget-option-title">🔗 Schnellzugriffe</div>
                            <div class="widget-option-desc">Schnelle Links zu deinen Apps</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('stats')">
                            <div class="widget-option-title">📊 Statistiken</div>
                            <div class="widget-option-desc">Videos, Spieler und Matches</div>
                        </div>
                        <div class="widget-option" onclick="addWidget('upcoming')">
                            <div class="widget-option-title">📅 Nächste Spiele</div>
                            <div class="widget-option-desc">Deine kommenden Matches</div>
                        </div>
                    </div>

                    <button onclick="closeWidgetModal()"
                        style="width: 100%; margin-top: 20px; padding: 12px; background: var(--border-light); border: none; border-radius: 10px; cursor: pointer; font-size: 14px; color: var(--text-light);">Abbrechen</button>
                </div>
            </div>

            <!-- KADER -->
            <style>
                .kader-card {
                    background: var(--card-light) !important;
                    color: var(--text-light) !important;
                }

                body.dark-mode .kader-card {
                    background: var(--card-dark) !important;
                    color: var(--text-dark) !important;
                }

                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                }

                .modal-overlay.active {
                    display: flex;
                }

                .modal-window {
                    background: var(--card-light);
                    color: var(--text-light);
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                }

                body.dark-mode .modal-window {
                    background: var(--card-dark);
                    color: var(--text-dark);
                }

                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 24px;
                    border-bottom: 1px solid var(--border-light);
                    padding-bottom: 16px;
                }

                .modal-header h2 {
                    margin: 0;
                    font-size: 24px;
                }

                .modal-close {
                    background: none;
                    border: none;
                    font-size: 28px;
                    cursor: pointer;
                    color: var(--text-light);
                    padding: 0;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                body.dark-mode .modal-close {
                    color: var(--text-dark);
                }

                .modal-close:hover {
                    opacity: 0.7;
                }
            </style>
            <div id="kader" class="app-view">
                <h1>Kader</h1>
                <p class="subtitle">Team Verwaltung & Spielerliste</p>

                <!-- MANNSCHAFTS-AUSWAHL -->
                <div style="margin-bottom: 24px;">
                    <label
                        style="font-size: 14px; color: var(--text-light); margin-right: 12px; font-weight: 600;">Mannschaft
                        auswählen:</label>
                    <select id="kaderTeamSelect" onchange="filterPlayersByTeam()"
                        style="padding: 10px 16px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); font-size: 14px; min-width: 200px; cursor: pointer;">
                        <option value="all">Alle Mannschaften</option>
                        <!-- Dynamisch befüllt -->
                    </select>
                    <span id="kaderPlayerCount"
                        style="margin-left: 16px; font-size: 14px; color: var(--text-light); opacity: 0.7;"></span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                    <!-- Status Chart -->
                    <div class="kader-card" style="border-radius: 16px; padding: 24px; transition: all 0.3s;">
                        <h3 style="margin-bottom: 20px; text-align: center;">Spieler Status</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div
                            style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 3px;">
                                </div>
                                <span>Fit: <strong id="stat-fit">0</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 3px;">
                                </div>
                                <span>Training: <strong id="stat-training">0</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #06b6d4; border-radius: 3px;">
                                </div>
                                <span>Reha: <strong id="stat-reha">0</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 3px;">
                                </div>
                                <span>Ausfall: <strong id="stat-ausfall">0</strong></span>
                            </div>
                        </div>
                    </div>

                    <!-- Position Chart -->
                    <div class="kader-card" style="border-radius: 16px; padding: 24px; transition: all 0.3s;">
                        <h3 style="margin-bottom: 20px; text-align: center;">Positionen</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="positionChart"></canvas>
                        </div>
                        <div
                            style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 3px;">
                                </div>
                                <span>Torwart: <strong id="pos-torwart">0</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 3px;">
                                </div>
                                <span>Abwehr: <strong id="pos-abwehr">0</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #ec4899; border-radius: 3px;">
                                </div>
                                <span>Mittelfeld: <strong id="pos-mittelfeld">0</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #f97316; border-radius: 3px;">
                                </div>
                                <span>Sturm: <strong id="pos-sturm">0</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <h2 style="margin-bottom: 20px; font-size: 20px; color: var(--text-light);">Aktuelle Spieler
                </h2>

                <button onclick="openAddPlayerModal()"
                    style="margin-bottom: 20px; padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">+
                    Spieler hinzufügen</button>

                <div class="list-container" id="kader-list"
                    style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-light); border-radius: 8px; padding: 0;">
                    <div class="list-item">
                        <span>Keine Spieler hinzugefügt</span>
                        <span style="opacity: 0.7;">--</span>
                    </div>
                </div>
            </div>

            <!-- ADD PLAYER MODAL -->
            <div id="addPlayerModal" class="modal-overlay">
                <div class="modal-window" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>Spieler hinzufügen</h2>
                        <button class="modal-close" onclick="closeAddPlayerModal()">✕</button>
                    </div>

                    <!-- Name -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <input type="text" id="playerFirstname" placeholder="Vorname"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                        <input type="text" id="playerLastname" placeholder="Nachname"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                    </div>

                    <!-- Geburtsdatum & Land -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label
                                style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Geburtsdatum</label>
                            <input type="date" id="playerBirthdate"
                                style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box; width: 100%;">
                        </div>
                        <div>
                            <label
                                style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Nationalität</label>
                            <select id="playerCountry"
                                style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box; width: 100%;">
                                <option value="DE">🇩🇪 Deutschland</option>
                                <option value="AT">🇦🇹 Österreich</option>
                                <option value="CH">🇨🇭 Schweiz</option>
                                <option value="FR">🇫🇷 Frankreich</option>
                                <option value="ES">🇪🇸 Spanien</option>
                                <option value="IT">🇮🇹 Italien</option>
                                <option value="NL">🇳🇱 Niederlande</option>
                                <option value="BE">🇧🇪 Belgien</option>
                                <option value="PT">🇵🇹 Portugal</option>
                                <option value="GB">🇬🇧 England</option>
                                <option value="PL">🇵🇱 Polen</option>
                                <option value="HR">🇭🇷 Kroatien</option>
                                <option value="RS">🇷🇸 Serbien</option>
                                <option value="TR">🇹🇷 Türkei</option>
                                <option value="BR">🇧🇷 Brasilien</option>
                                <option value="AR">🇦🇷 Argentinien</option>
                                <option value="US">🇺🇸 USA</option>
                                <option value="OTHER">Andere</option>
                            </select>
                        </div>
                    </div>

                    <!-- Nummer & Status -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <input type="number" id="playerJersey" placeholder="Rückennummer" min="1" max="99"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                        <select id="playerStatus"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                            <option value="Fit">Fit</option>
                            <option value="Training">Training</option>
                            <option value="Reha">Reha</option>
                            <option value="Ausfall">Ausfall</option>
                        </select>
                    </div>

                    <!-- Mannschaft -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Mannschaft</label>
                        <select id="playerTeam"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box; width: 100%;">
                            <!-- Dynamisch befüllt -->
                        </select>
                        <div id="noTeamsWarning"
                            style="display: none; color: #ef4444; font-size: 12px; margin-top: 6px;">
                            ⚠️ Bitte erstelle erst eine Mannschaft bevor du einen Spieler anlegst
                        </div>
                    </div>

                    <!-- Positionen (Mehrfachauswahl) -->
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 8px;">Positionen
                            (mehrere möglich)</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                            <!-- Torwart -->
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="TW"> TW
                            </label>
                            <!-- Abwehr -->
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="IV"> IV
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="LV"> LV
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="RV"> RV
                            </label>
                            <!-- Mittelfeld -->
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="DM"> DM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="ZM"> ZM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="LM"> LM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="RM"> RM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="OM"> OM
                            </label>
                            <!-- Sturm -->
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="LF"> LF
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="RF"> RF
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="positions" value="ST"> ST
                            </label>
                        </div>
                    </div>

                    <!-- Körperdaten -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                        <input type="number" id="playerHeight" placeholder="Größe (cm)" min="100" max="250"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                        <input type="number" id="playerWeight" placeholder="Gewicht (kg)" min="40" max="150"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button onclick="addNewPlayer()"
                            style="padding: 12px 20px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Speichern</button>
                        <button onclick="closeAddPlayerModal()"
                            style="padding: 12px 20px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Abbrechen</button>
                    </div>
                </div>
            </div>

            <!-- EDIT PLAYER MODAL -->
            <div id="editPlayerModal" class="modal-overlay">
                <div class="modal-window" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>Spieler bearbeiten</h2>
                        <button class="modal-close" onclick="closeEditPlayerModal()">✕</button>
                    </div>
                    <input type="hidden" id="editPlayerId">

                    <!-- Name -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <input type="text" id="editPlayerFirstname" placeholder="Vorname"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                        <input type="text" id="editPlayerLastname" placeholder="Nachname"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                    </div>

                    <!-- Geburtsdatum & Land -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label
                                style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Geburtsdatum</label>
                            <input type="date" id="editPlayerBirthdate"
                                style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box; width: 100%;">
                        </div>
                        <div>
                            <label
                                style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Nationalität</label>
                            <select id="editPlayerCountry"
                                style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box; width: 100%;">
                                <option value="DE">🇩🇪 Deutschland</option>
                                <option value="AT">🇦🇹 Österreich</option>
                                <option value="CH">🇨🇭 Schweiz</option>
                                <option value="FR">🇫🇷 Frankreich</option>
                                <option value="ES">🇪🇸 Spanien</option>
                                <option value="IT">🇮🇹 Italien</option>
                                <option value="NL">🇳🇱 Niederlande</option>
                                <option value="BE">🇧🇪 Belgien</option>
                                <option value="PT">🇵🇹 Portugal</option>
                                <option value="GB">🇬🇧 England</option>
                                <option value="PL">🇵🇱 Polen</option>
                                <option value="HR">🇭🇷 Kroatien</option>
                                <option value="RS">🇷🇸 Serbien</option>
                                <option value="TR">🇹🇷 Türkei</option>
                                <option value="BR">🇧🇷 Brasilien</option>
                                <option value="AR">🇦🇷 Argentinien</option>
                                <option value="US">🇺🇸 USA</option>
                                <option value="OTHER">Andere</option>
                            </select>
                        </div>
                    </div>

                    <!-- Nummer & Status -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <input type="number" id="editPlayerJersey" placeholder="Rückennummer" min="1" max="99"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                        <select id="editPlayerStatus"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                            <option value="Fit">Fit</option>
                            <option value="Training">Training</option>
                            <option value="Reha">Reha</option>
                            <option value="Ausfall">Ausfall</option>
                        </select>
                    </div>

                    <!-- Mannschaft -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">Mannschaft</label>
                        <select id="editPlayerTeam"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box; width: 100%;">
                        </select>
                    </div>

                    <!-- Account Verknüpfung -->
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 4px;">
                            Account verknüpfen
                        </label>
                        <select id="editPlayerUser"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box; width: 100%;">
                        </select>
                    </div>

                    <!-- Positionen (Mehrfachauswahl) -->
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 12px; opacity: 0.7; display: block; margin-bottom: 8px;">Positionen
                            (mehrere möglich)</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="TW"> TW
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="IV"> IV
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="LV"> LV
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="RV"> RV
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="DM"> DM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="ZM"> ZM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="LM"> LM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="RM"> RM
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="OM"> OM
                            </label>
                            <!-- Sturm -->
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="LF"> LF
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="RF"> RF
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" name="editPositions" value="ST"> ST
                            </label>
                        </div>
                    </div>

                    <!-- Körperdaten -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                        <input type="number" id="editPlayerHeight" placeholder="Größe (cm)" min="100" max="250"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                        <input type="number" id="editPlayerWeight" placeholder="Gewicht (kg)" min="40" max="150"
                            style="padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); box-sizing: border-box;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button onclick="saveEditPlayer()"
                            style="padding: 12px 20px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Speichern</button>
                        <button onclick="closeEditPlayerModal()"
                            style="padding: 12px 20px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Abbrechen</button>
                    </div>
                </div>
            </div>

            <!-- ADD TEAM MODAL -->
            <div id="addTeamModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
                <div
                    style="background: var(--card-light); border-radius: 16px; padding: 24px; max-width: 450px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; font-size: 18px; color: var(--text-light); text-align: center;">
                        Neue Mannschaft erstellen</h2>

                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <input type="text" id="teamName" placeholder="Mannschaftsname (z.B. 1. Mannschaft)"
                            style="padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); font-size: 16px;">

                        <select id="teamCategory"
                            style="padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--card-light); color: var(--text-light); font-size: 14px;">
                            <option value="herren">Herren</option>
                            <option value="frauen">Frauen</option>
                            <option value="jugend">Jugend</option>
                            <option value="andere">Andere</option>
                        </select>

                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label style="color: var(--text-light); font-size: 14px;">Teamfarbe:</label>
                            <input type="color" id="teamColor" value="#10b981"
                                style="width: 50px; height: 40px; border: 1px solid var(--border-light); border-radius: 8px; cursor: pointer; padding: 2px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                        <button onclick="addNewTeam()"
                            style="padding: 12px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Erstellen</button>
                        <button onclick="closeAddTeamModal()"
                            style="padding: 12px 20px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Abbrechen</button>
                    </div>
                </div>
            </div>

            <!-- KALENDER -->
            <div id="kalender" class="app-view">
                <h1>Kalender</h1>
                <p class="subtitle">Deine Matches und Events</p>

                <div id="calendarContainer"></div>
            </div>

            <!-- Event Modal -->
            <div id="eventModalOverlay" data-edit-index=""
                style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                <div
                    style="background: var(--card-light); border-radius: 16px; padding: 24px; max-width: 450px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; font-size: 20px;" id="eventModalTitle">Neues Event</h2>
                        <button onclick="closeEventModal()"
                            style="background: none; border: none; font-size: 24px; cursor: pointer; opacity: 0.6;">×</button>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label
                                style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Titel
                                *</label>
                            <input type="text" id="eventTitle" placeholder="z.B. Training, Spiel vs. FC..."
                                style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label
                                    style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Datum
                                    *</label>
                                <input type="date" id="eventDate"
                                    style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label
                                    style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Uhrzeit</label>
                                <input type="time" id="eventTime"
                                    style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            </div>
                        </div>

                        <div>
                            <label
                                style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Typ</label>
                            <select id="eventType"
                                style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                <option value="training">Training</option>
                                <option value="match">Spiel</option>
                                <option value="meeting">Besprechung</option>
                                <option value="other">Sonstiges</option>
                            </select>
                        </div>

                        <div>
                            <label
                                style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Ort</label>
                            <input type="text" id="eventLocation" placeholder="z.B. Hauptplatz, Halle A..."
                                style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>

                        <div>
                            <label
                                style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Sichtbarkeit</label>
                            <div style="display: flex; gap: 8px;">
                                <label
                                    style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                                    id="visibilityPrivateLabel">
                                    <input type="radio" name="eventVisibility" value="private"
                                        id="eventVisibilityPrivate" checked
                                        style="width: 18px; height: 18px; accent-color: var(--primary-green);"
                                        onchange="updateVisibilityStyle()">
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">🔒 Privat</div>
                                        <div style="font-size: 11px; color: #888;">Nur für mich</div>
                                    </div>
                                </label>
                                <label
                                    style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                                    id="visibilityTeamLabel">
                                    <input type="radio" name="eventVisibility" value="team" id="eventVisibilityTeam"
                                        style="width: 18px; height: 18px; accent-color: var(--primary-green);"
                                        onchange="updateVisibilityStyle()">
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">👥 Team</div>
                                        <div style="font-size: 11px; color: #888;">Mit Zu-/Absagen</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label
                                style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Notizen</label>
                            <textarea id="eventNotes" rows="3" placeholder="Zusätzliche Informationen..."
                                style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button onclick="closeEventModal()"
                            style="flex: 1; padding: 12px; background: #e5e5ea; color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Abbrechen</button>
                        <button onclick="saveEvent()"
                            style="flex: 1; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Speichern</button>
                    </div>
                </div>
            </div>

            <!-- LIGA -->
            <div id="liga" class="app-view">
                <h1>Liga</h1>
                <p class="subtitle">Ligatabelle und Ergebnisse</p>

                <div id="ligaContent"
                    style="background: var(--card-light); border-radius: 12px; padding: 20px; border: 1px solid var(--border-light);">
                    <h2 style="margin: 0 0 20px 0; font-size: 18px;">Tabelle</h2>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-light);">
                                <th style="text-align: left; padding: 12px; font-weight: 600;">Platz</th>
                                <th style="text-align: left; padding: 12px; font-weight: 600;">Team</th>
                                <th style="text-align: center; padding: 12px; font-weight: 600;">Spiele</th>
                                <th style="text-align: center; padding: 12px; font-weight: 600;">Tore</th>
                                <th style="text-align: center; padding: 12px; font-weight: 600;">Punkte</th>
                            </tr>
                        </thead>
                        <tbody id="ligaTable">
                            <!-- Dynamisch befüllt -->
                        </tbody>
                    </table>
                </div>

                <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 18px;">Letzte Ergebnisse</h2>
                <div id="ligaResults" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Dynamisch befüllt -->
                </div>
            </div>

            <!-- MESSENGER -->
            <div id="messenger" class="app-view">
                <h1>Messenger</h1>
                <p class="subtitle">Direktnachrichten mit deinem Team</p>

                <div style="display: flex; gap: 20px; height: calc(100vh - 200px); margin-bottom: 20px;">
                    <!-- Kontaktliste -->
                    <div
                        style="flex: 0 0 280px; background: var(--card-light); border-radius: 12px; border: 1px solid var(--border-light); display: flex; flex-direction: column;">
                        <div style="padding: 16px; border-bottom: 1px solid var(--border-light);">
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <input type="text" id="contactSearch" placeholder="Kontakte durchsuchen..."
                                    onkeyup="filterContacts()"
                                    style="flex: 1; padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                <button onclick="showCreateGroupModal()"
                                    style="padding: 10px 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 18px;"
                                    title="Neue Gruppe">+</button>
                            </div>
                            <div id="teamChatBtn" onclick="selectChat('team_chat', '👥 Team')"
                                style="padding: 12px; background: var(--primary-green); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: center; margin-bottom: 8px;">
                                👥 Team Chat</div>
                            <div style="font-size: 12px; font-weight: 600; opacity: 0.6; margin-top: 8px;">SPIELER
                            </div>
                        </div>
                        <div id="messengerContacts" style="flex: 1; overflow-y: auto;">
                            <!-- Dynamisch befüllt -->
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div
                        style="flex: 1; display: flex; flex-direction: column; background: var(--card-light); border-radius: 12px; border: 1px solid var(--border-light);">
                        <div id="messengerHeader"
                            style="padding: 16px; border-bottom: 1px solid var(--border-light); font-weight: 600; color: #333; display: flex; justify-content: space-between; align-items: center;">
                            <span>Wähle einen Kontakt</span>
                            <button id="deleteConvBtn" onclick="deleteConversation()"
                                style="padding: 6px 12px; background: #ff4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; display: none;">Löschen</button>
                        </div>
                        <div id="messengerChat"
                            style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; opacity: 0.5; margin: auto;">Wähle einen Chat</div>
                        </div>
                        <div
                            style="padding: 16px; border-top: 1px solid var(--border-light); display: flex; gap: 12px; flex-wrap: wrap;">
                            <input type="file" id="messengerFileInput" accept="image/*,.pdf,.doc,.docx"
                                style="display: none;" onchange="attachFile()">
                            <button onclick="document.getElementById('messengerFileInput').click()"
                                style="padding: 10px 12px; background: #999; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"
                                title="Datei anhängen">📎</button>
                            <input type="text" id="messengerInput" placeholder="Nachricht schreiben..."
                                style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                                disabled onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()"
                                style="padding: 10px 20px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Senden</button>
                        </div>
                        <div id="attachmentPreview" style="padding: 0 16px 8px 16px; display: none;">
                            <div
                                style="background: #f0f0f0; padding: 8px; border-radius: 6px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;">
                                <span id="attachmentName">Datei angehängt</span>
                                <button onclick="clearAttachment()"
                                    style="background: none; border: none; cursor: pointer; font-weight: 600;">✕</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal für Gruppenerstellung -->
            <div id="createGroupModal"
                style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%;">
                    <h2 style="margin-top: 0;">Neue Gruppe erstellen</h2>
                    <input type="text" id="groupNameInput" placeholder="Gruppenname (z.B. 'Abwehr')"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; margin-bottom: 16px; box-sizing: border-box; font-size: 14px;">
                    <div id="groupMembersList"
                        style="border: 1px solid var(--border-light); border-radius: 8px; max-height: 200px; overflow-y: auto; margin-bottom: 16px;">
                        <!-- Checkboxen werden dynamisch gefüllt -->
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeCreateGroupModal()"
                            style="flex: 1; padding: 10px; background: #ccc; border: none; border-radius: 8px; cursor: pointer;">Abbrechen</button>
                        <button onclick="createGroup()"
                            style="flex: 1; padding: 10px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Erstellen</button>
                    </div>
                </div>
            </div>

            <!-- VIDEO UPLOAD -->
            <div id="upload" class="app-view">
                <h1>Video Analyse</h1>
                <p class="subtitle">Videos hochladen, analysieren und mit deinem Team teilen</p>

                <!-- Tab Navigation -->
                <div
                    style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border-light); padding-bottom: 16px;">
                    <button id="tabMeineVideos" onclick="switchVideoTab('meineVideos')" class="video-tab-btn active"
                        style="padding: 10px 20px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                        📁 Meine Videos
                    </button>
                    <button id="tabUpload" onclick="switchVideoTab('upload')" class="video-tab-btn"
                        style="padding: 10px 20px; background: var(--card-light); color: var(--text-light); border: 1px solid var(--border-light); border-radius: 10px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;">
                        ⬆️ Hochladen
                    </button>
                    <button id="tabShared" onclick="switchVideoTab('shared')" class="video-tab-btn"
                        style="padding: 10px 20px; background: var(--card-light); color: var(--text-light); border: 1px solid var(--border-light); border-radius: 10px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s; position: relative;">
                        📨 Geteilte Clips
                        <span id="sharedClipsBadge"
                            style="display: none; position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 16px; text-align: center;">0</span>
                    </button>
                </div>

                <!-- TAB: Meine Videos -->
                <div id="tabContentMeineVideos" class="video-tab-content">
                    <div id="videoListEmpty"
                        style="text-align: center; padding: 60px 20px; background: var(--card-light); border-radius: 16px; border: 2px dashed var(--border-light);">
                        <span style="font-size: 64px; display: block; margin-bottom: 16px; opacity: 0.5;">🎬</span>
                        <h3 style="margin-bottom: 8px; opacity: 0.8;">Noch keine Videos</h3>
                        <p style="opacity: 0.6; margin-bottom: 20px;">Lade dein erstes Spielvideo hoch um mit der
                            Analyse zu starten</p>
                        <button onclick="switchVideoTab('upload')"
                            style="padding: 12px 24px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                            ⬆️ Video hochladen
                        </button>
                    </div>
                    <div id="videoListGrid"
                        style="display: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    </div>
                </div>

                <!-- TAB: Upload -->
                <div id="tabContentUpload" class="video-tab-content" style="display: none;">
                    <!-- Upload Form -->
                    <div id="uploadFormArea"
                        style="background: var(--card-light); border-radius: 16px; padding: 24px; border: 1px solid var(--border-light);">
                        <div class="upload-area" id="videoDropZone"
                            onclick="document.getElementById('videoInput').click()"
                            style="border: 2px dashed var(--border-light); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;">
                            <div style="font-size: 48px; margin-bottom: 12px;">📹</div>
                            <h3 style="margin-bottom: 8px;">Video auswählen</h3>
                            <p style="opacity: 0.6;">Ziehe eine Datei hierher oder klicke zum Auswählen</p>
                            <p style="font-size: 12px; opacity: 0.5; margin-top: 12px;">MP4, MOV, AVI, WebM bis
                                500MB</p>
                        </div>
                        <input type="file" id="videoInput" style="display: none;"
                            accept="video/mp4,video/quicktime,video/x-msvideo,video/webm,video/x-matroska">

                        <!-- Upload Details (hidden until file selected) -->
                        <div id="uploadDetails" style="display: none; margin-top: 20px;">
                            <div style="display: flex; gap: 16px; align-items: start;">
                                <div id="videoThumbnailPreview"
                                    style="width: 160px; height: 90px; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                    <video id="thumbnailVideo"
                                        style="width: 100%; height: 100%; object-fit: cover;"></video>
                                </div>
                                <div style="flex: 1;">
                                    <input type="text" id="videoTitle"
                                        placeholder="Video Titel (z.B. Spiel vs. FC Beispiel)"
                                        style="width: 100%; padding: 12px; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; margin-bottom: 12px; color: var(--text-light);">
                                    <textarea id="videoDescription" placeholder="Beschreibung (optional)"
                                        style="width: 100%; padding: 12px; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; resize: none; height: 60px; color: var(--text-light);"></textarea>
                                </div>
                            </div>
                            <div id="selectedFileInfo"
                                style="margin-top: 12px; padding: 12px; background: var(--bg-light); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 24px;">📄</span>
                                <div style="flex: 1;">
                                    <div id="selectedFileName" style="font-weight: 500;"></div>
                                    <div id="selectedFileSize" style="font-size: 12px; opacity: 0.6;"></div>
                                </div>
                                <button onclick="clearVideoSelection()"
                                    style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">✕</button>
                            </div>

                            <!-- Upload Progress -->
                            <div id="uploadProgress" style="display: none; margin-top: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span id="uploadStatus">Hochladen...</span>
                                    <span id="uploadPercent">0%</span>
                                </div>
                                <div
                                    style="height: 6px; background: var(--bg-light); border-radius: 3px; overflow: hidden;">
                                    <div id="uploadProgressBar"
                                        style="height: 100%; background: linear-gradient(135deg, #007AFF, #00C7BE); width: 0%; transition: width 0.3s;">
                                    </div>
                                </div>
                            </div>

                            <button id="startUploadBtn" onclick="startVideoUpload()"
                                style="width: 100%; margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                ⬆️ Video hochladen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TAB: Geteilte Clips -->
                <div id="tabContentShared" class="video-tab-content" style="display: none;">
                    <div id="sharedClipsEmpty"
                        style="text-align: center; padding: 60px 20px; background: var(--card-light); border-radius: 16px; border: 2px dashed var(--border-light);">
                        <span style="font-size: 64px; display: block; margin-bottom: 16px; opacity: 0.5;">📭</span>
                        <h3 style="margin-bottom: 8px; opacity: 0.8;">Keine geteilten Clips</h3>
                        <p style="opacity: 0.6;">Hier erscheinen Clips die dein Trainer mit dir teilt</p>
                    </div>
                    <div id="sharedClipsList" style="display: none; display: flex; flex-direction: column; gap: 12px;">
                    </div>
                </div>

            </div>
            <!-- END VIDEO UPLOAD -->

            <!-- OLD VIDEO CODE REMOVED - Video functionality now in new modal-based system above -->

        </div>
        <!-- TRAINING (PREMIUM) -->
        <div id="training" class="app-view">

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">TRAININGS-EINHEITEN</div>
                    <div class="stat-value">18</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">SPIELER AKTIV</div>
                    <div class="stat-value">26</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">DIESE WOCHE</div>
                    <div class="stat-value">5</div>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">Nächste Sessions</h2>
            <div class="list-container">
                <div class="list-item">
                    <span>Ballkontrolle Training</span>
                    <span style="opacity: 0.7;">heute 14:00</span>
                </div>
                <div class="list-item">
                    <span>Defensive Drills</span>
                    <span style="opacity: 0.7;">morgen 10:00</span>
                </div>
                <div class="list-item">
                    <span>Kraft & Ausdauer</span>
                    <span style="opacity: 0.7;">Do 15:30</span>
                </div>
            </div>
        </div>

        <!-- FINANZEN (PREMIUM) -->
        <div id="finanzen" class="app-view">
            <h1>🔒 Finanzen</h1>
            <p class="subtitle">Premium Feature - Budget & Kosten Management</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">MONATLICHES BUDGET</div>
                    <div class="stat-value">€50k</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">AUSGEGEBEN</div>
                    <div class="stat-value">€32k</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">VERFÜGBAR</div>
                    <div class="stat-value">€18k</div>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">Transaktionen</h2>
            <div class="list-container">
                <div class="list-item">
                    <span>Trainingsplatz Miete</span>
                    <span style="opacity: 0.7;">-€5,000</span>
                </div>
                <div class="list-item">
                    <span>Spieler Gehälter</span>
                    <span style="opacity: 0.7;">-€18,500</span>
                </div>
                <div class="list-item">
                    <span>Ausrüstung</span>
                    <span style="opacity: 0.7;">-€8,000</span>
                </div>
            </div>
        </div>

        <!-- MEDIZIN (PREMIUM) -->
        <div id="medizin" class="app-view">
            <h1>🔒 Medizin</h1>
            <p class="subtitle">Premium Feature - Spieler Gesundheit & Fitness</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">SPIELER FIT</div>
                    <div class="stat-value" id="medizin-fit">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">VERLETZUNGEN</div>
                    <div class="stat-value" id="medizin-injured">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">IN GENESUNG</div>
                    <div class="stat-value" id="medizin-recovery">0</div>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">Spieler Status</h2>
            <div class="list-container" id="medizin-list">
                <div class="list-item">
                    <span>Keine Spieler vorhanden</span>
                    <span style="opacity: 0.7;">--</span>
                </div>
            </div>
        </div>

        <!-- SCOUTING (PREMIUM) -->
        <div id="scouting" class="app-view">
            <h1>🔒 Scouting</h1>
            <p class="subtitle">Premium Feature - Spieler Bewertung & Analyse</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">SPIELER BEWERTET</div>
                    <div class="stat-value">156</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TOP RATED</div>
                    <div class="stat-value">12</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">DIESE WOCHE</div>
                    <div class="stat-value">8</div>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">Top Kandidaten</h2>
            <div class="list-container">
                <div class="list-item">
                    <span>⭐⭐⭐⭐⭐ Vinicius Jr.</span>
                    <span style="opacity: 0.7;">9.2</span>
                </div>
                <div class="list-item">
                    <span>⭐⭐⭐⭐⭐ Erling Haaland</span>
                    <span style="opacity: 0.7;">9.1</span>
                </div>
                <div class="list-item">
                    <span>⭐⭐⭐⭐ Florian Wirtz</span>
                    <span style="opacity: 0.7;">8.7</span>
                </div>
            </div>
        </div>

        <!-- ANALYSE (PREMIUM) -->
        <div id="analyse" class="app-view">
            <h1>🔒 Analyse</h1>
            <p class="subtitle">Premium Feature - Erweiterte Video Analyse</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ANALYSEN</div>
                    <div class="stat-value">42</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">GENAUIGKEIT</div>
                    <div class="stat-value">96%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">DURCHSCHNITT</div>
                    <div class="stat-value">2.3m</div>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">Letzte Analysen</h2>
            <div class="list-container">
                <div class="list-item">
                    <span>Match Bayern 2024</span>
                    <span style="opacity: 0.7;">96% Genauigkeit</span>
                </div>
                <div class="list-item">
                    <span>Training Session 12</span>
                    <span style="opacity: 0.7;">94% Genauigkeit</span>
                </div>
                <div class="list-item">
                    <span>Test Match Prep</span>
                    <span style="opacity: 0.7;">95% Genauigkeit</span>
                </div>
            </div>
        </div>

        <!-- TAKTIK-TAFEL -->
        <div id="taktik" class="app-view" style="padding: 0;">
            <div class="taktik-content">
                <!-- Taktik Toolbar -->
                <div class="taktik-toolbar">
                    <div class="toolbar-group">
                        <span class="toolbar-label">Spieler</span>
                        <div class="taktik-segmented-control">
                            <button class="taktik-segment active" data-taktik-mode="numbers">Nummern</button>
                            <button class="taktik-segment" data-taktik-mode="kader">Kader</button>
                            <button class="taktik-segment" data-taktik-mode="neutral">Neutral</button>
                        </div>
                    </div>

                    <div class="toolbar-group">
                        <span class="toolbar-label">Gegner</span>
                        <label class="taktik-switch">
                            <input type="checkbox" id="taktikOpponentToggle">
                            <span class="taktik-switch-slider"></span>
                        </label>
                    </div>

                    <div class="toolbar-group" style="margin-left: auto;">
                        <button class="taktik-segment taktik-btn-action" id="taktikUndoBtn" type="button"
                            onclick="taktikUndo()">Undo</button>
                        <button class="taktik-segment taktik-btn-delete" id="taktikClearBtn" type="button"
                            onclick="taktikClearAll()">Löschen</button>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="canvas-container">
                    <div class="canvas-wrapper" id="canvasWrapper">
                        <canvas id="fieldCanvas"></canvas>
                        <canvas id="drawCanvas"></canvas>
                    </div>

                    <!-- Draw Toggle Button -->
                    <button class="draw-toggle-btn" id="drawToggleBtn" title="Zeichnen">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 19l7-7 3 3-7 7-3-3z" />
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
                            <path d="M2 2l7.586 7.586" />
                        </svg>
                    </button>

                    <!-- Drawing Toolbar -->
                    <div class="draw-toolbar" id="drawToolbar">
                        <button class="draw-tool-btn active" data-draw-tool="pen" title="Stift">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 19l7-7 3 3-7 7-3-3z" />
                                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
                            </svg>
                        </button>
                        <button class="draw-tool-btn" data-draw-tool="highlight" title="Marker">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M9 11l-6 6v3h9l3-3" />
                                <path d="M22 12l-4.6 4.6a2 2 0 01-2.8 0l-5.2-5.2a2 2 0 010-2.8L14 4" />
                            </svg>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="draw-tool-btn" data-draw-tool="arrow" title="Pfeil">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12" />
                                <polyline points="12 5 19 12 12 19" />
                            </svg>
                        </button>
                        <button class="draw-tool-btn" data-draw-tool="line" title="Linie">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="4" y1="20" x2="20" y2="4" />
                            </svg>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="draw-tool-btn" data-draw-tool="eraser" title="Radierer">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M20 20H7L3 16c-.6-.6-.6-1.5 0-2.1l10-10c.6-.6 1.5-.6 2.1 0l6.9 6.9c.6.6.6 1.5 0 2.1L12 23" />
                            </svg>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="color-swatch active" data-color="#ef4444" style="background: #ef4444;"
                            title="Rot"></button>
                        <button class="color-swatch" data-color="#f59e0b" style="background: #f59e0b;"
                            title="Orange"></button>
                        <button class="color-swatch" data-color="#22c55e" style="background: #22c55e;"
                            title="Grün"></button>
                        <button class="color-swatch" data-color="#3b82f6" style="background: #3b82f6;"
                            title="Blau"></button>
                        <button class="color-swatch" data-color="#ffffff" style="background: #ffffff;"
                            title="Weiß"></button>
                        <div class="toolbar-divider"></div>
                        <button class="size-btn" data-size="2" title="Dünn">
                            <span style="width:4px;height:4px;background:white;border-radius:50%;display:block;"></span>
                        </button>
                        <button class="size-btn active" data-size="4" title="Mittel">
                            <span style="width:8px;height:8px;background:white;border-radius:50%;display:block;"></span>
                        </button>
                        <button class="size-btn" data-size="8" title="Dick">
                            <span
                                style="width:12px;height:12px;background:white;border-radius:50%;display:block;"></span>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="draw-tool-btn" id="closeDrawToolbar" title="Schließen">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS -->
        <!-- ANALYSE -->
        <div id="analyse" class="app-view">
            <h1>Analyse</h1>
            <p class="subtitle">Spiel- und Trainingsanalysen</p>

            <div class="list-container">
                <div class="list-item">
                    <span>Keine Analysen vorhanden</span>
                    <span style="opacity: 0.7;">Erstelle deine erste Analyse</span>
                </div>
            </div>
        </div>

        <!-- TRAINING -->
        <div id="training" class="app-view">
            <h1>Training</h1>
            <p class="subtitle">Trainingsplanung und Übungen</p>

            <div class="list-container">
                <div class="list-item">
                    <span>Keine Trainingseinheiten geplant</span>
                    <span style="opacity: 0.7;">Plane dein erstes Training</span>
                </div>
            </div>
        </div>

        <!-- MEDIZIN -->
        <div id="medizin" class="app-view">
            <h1>Medizin</h1>
            <p class="subtitle">Verletzungen und Fitness</p>

            <div class="list-container">
                <div class="list-item">
                    <span>Keine medizinischen Einträge</span>
                    <span style="opacity: 0.7;">Alle Spieler fit</span>
                </div>
            </div>
        </div>

        <!-- FINANZEN -->
        <div id="finanzen" class="app-view">
            <h1>Finanzen</h1>
            <p class="subtitle">Einnahmen und Ausgaben</p>

            <div class="list-container">
                <div class="list-item">
                    <span>Keine Finanzdaten vorhanden</span>
                    <span style="opacity: 0.7;">Erfasse deine erste Transaktion</span>
                </div>
            </div>
        </div>

        <!-- SCOUTING -->
        <div id="scouting" class="app-view">
            <h1>Scouting</h1>
            <p class="subtitle">Spielersuche und Beobachtungen</p>

            <div class="list-container">
                <div class="list-item">
                    <span>Keine Spieler gespeichert</span>
                    <span style="opacity: 0.7;">Füge deinen ersten Spieler hinzu</span>
                </div>
            </div>
        </div>

        <!-- TIPPS & TUTORIALS -->
        <div id="tipps" class="app-view" style="overflow-y: auto !important;">
            <h1>Tipps & Tutorials</h1>
            <p class="subtitle">Lerne PitchInsights kennen</p>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 24px;">

                <!-- Tutorial 1: Erste Schritte -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            🚀</div>
                        <div id="tipps-video-1"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none;">
                            <!-- Video wird hier eingefügt -->
                        </div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Erste Schritte</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Überblick über die wichtigsten
                            Funktionen</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 2: Kader verwalten -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            👥</div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Kader verwalten</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Spieler hinzufügen, bearbeiten und
                            Status setzen</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 3: Kalender nutzen -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            📅</div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Kalender nutzen</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Trainings und Spiele planen</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 4: Taktik-Tafel -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            ⚽</div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Taktik-Tafel</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Formationen erstellen und speichern
                        </p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 5: Messenger -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            💬</div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Messenger</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Mit dem Team kommunizieren</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 6: Video Upload -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            📹</div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Video Upload</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Spielvideos hochladen und markieren
                        </p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 8: Verwaltung -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #64748b 0%, #475569 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            👔</div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Verwaltung</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Team-Mitglieder und Rollen
                            verwalten</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 9: Mannschaftskasse -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            💵</div>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Mannschaftskasse</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Einnahmen und Ausgaben tracken</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 10: Analyse (Premium) -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            📈</div>
                        <span
                            style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px;">PREMIUM</span>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Analyse</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Spiel- und Trainingsanalysen
                            erstellen</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 11: Training (Premium) -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            🏋️</div>
                        <span
                            style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px;">PREMIUM</span>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Training</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Trainingseinheiten planen und
                            durchführen</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 12: Medizin (Premium) -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            ⚕️</div>
                        <span
                            style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px;">PREMIUM</span>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Medizin</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Verletzungen und Fitness
                            dokumentieren</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

                <!-- Tutorial 13: Finanzen (Premium) -->
                <div
                    style="background: var(--card-light); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-light);">
                    <div
                        style="position: relative; padding-top: 56.25%; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);">
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                            💰</div>
                        <span
                            style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px;">PREMIUM</span>
                    </div>
                    <div style="padding: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">Finanzen</h3>
                        <p style="margin: 0; font-size: 13px; opacity: 0.7;">Vereinsfinanzen im Überblick</p>
                        <span style="display: inline-block; margin-top: 12px; font-size: 12px; color: #f59e0b;">Video
                            kommt bald</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- VERWALTUNGS-VIEW -->
        <div id="verwaltung" class="app-view" style="overflow-y: auto !important;">
            <h1>Verwaltung</h1>
            <p class="subtitle">Team & Rollen verwalten</p>

            <!-- Tabs -->
            <div class="verwaltung-tabs" style="display: flex; gap: 10px; margin-bottom: 24px;">
                <button class="verwaltung-tab active" data-tab="mitglieder" onclick="switchVerwaltungTab('mitglieder')">
                    👥 Mitglieder
                </button>
                <button class="verwaltung-tab" data-tab="rollen" onclick="switchVerwaltungTab('rollen')">
                    🎭 Rollen
                </button>
                <button class="verwaltung-tab" data-tab="einladungen" onclick="switchVerwaltungTab('einladungen')">
                    ✉️ Einladungen
                </button>
            </div>

            <!-- Tab Content: Mitglieder -->
            <div id="verwaltung-mitglieder" class="verwaltung-content active">
                <div class="list-container" style="padding: 20px;">
                    <div id="team-members-list" style="display: grid; gap: 12px;">
                        <p style="text-align: center; opacity: 0.7;">Lade Mitglieder...</p>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Rollen -->
            <div id="verwaltung-rollen" class="verwaltung-content" style="display: none;">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                    <button class="btn-primary" onclick="showCreateRoleModal()">
                        + Neue Rolle
                    </button>
                </div>
                <div class="list-container" style="padding: 20px;">
                    <div id="team-roles-list" style="display: grid; gap: 16px;">
                        <p style="text-align: center; opacity: 0.7;">Lade Rollen...</p>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Einladungen -->
            <div id="verwaltung-einladungen" class="verwaltung-content" style="display: none;">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                    <button class="btn-primary" style="position: relative; z-index: 100;"
                        onclick="document.getElementById('create-invitation-modal').classList.add('active'); loadRolesForInvitation();">
                        + Neue Einladung
                    </button>
                </div>
                <div class="list-container" style="padding: 20px;">
                    <div id="invitations-list" style="display: grid; gap: 12px;">
                        <p style="text-align: center; opacity: 0.7;">Lade Einladungen...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Role Modal -->
        <div id="create-role-modal" class="modal-overlay" style="z-index: 9999;"
            onclick="if(event.target === this) closeModal('create-role-modal')">
            <div class="modal-content"
                style="max-width: 600px; max-height: 85vh; overflow-y: auto; background: var(--card-light); border-radius: 16px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <h2 style="margin-bottom: 20px;">Neue Rolle erstellen</h2>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Rollenname *</label>
                    <input type="text" id="new-role-name" class="input-field" placeholder="z.B. Physiotherapeut">
                    <label style="display: block; margin: 16px 0 8px; font-weight: 500;">Beschreibung</label>
                    <input type="text" id="new-role-description" class="input-field" placeholder="Kurze Beschreibung">

                    <label style="display: block; margin: 24px 0 12px; font-weight: 500;">🔐
                        App-Berechtigungen</label>
                    <p style="font-size: 13px; opacity: 0.7; margin-bottom: 16px;">Wähle die Apps, die diese
                        Rolle sehen darf:</p>

                    <div id="new-role-permissions"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <!-- Apps werden dynamisch eingefügt -->
                    </div>
                </div>
                <div
                    style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                    <button class="btn-secondary" onclick="closeModal('create-role-modal')">Abbrechen</button>
                    <button class="btn-primary" onclick="createRole()">✅ Rolle erstellen</button>
                </div>
            </div>
        </div>

        <!-- Create Invitation Modal -->
        <div id="create-invitation-modal" class="modal-overlay"
            onclick="if(event.target === this) closeModal('create-invitation-modal')">
            <div class="modal-content"
                style="max-width: 500px; background: var(--card-light); border-radius: 16px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <h2 style="margin-bottom: 20px;">Einladungslink erstellen</h2>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 8px;">Rolle für eingeladene Person</label>
                    <select id="invitation-role" class="input-field">
                        <!-- Wird dynamisch gefüllt -->
                    </select>
                    <label style="display: block; margin: 16px 0 8px;">Maximale Nutzungen</label>
                    <input type="number" id="invitation-max-uses" class="input-field" value="1" min="1">
                    <label style="display: block; margin: 16px 0 8px;">Gültig für (Tage)</label>
                    <input type="number" id="invitation-days" class="input-field" value="7" min="1">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="closeModal('create-invitation-modal')">Abbrechen</button>
                    <button class="btn-primary" onclick="createInvitation()">Erstellen</button>
                </div>
            </div>
        </div>

        <!-- Invitation Link Modal -->
        <div id="invitation-link-modal" class="modal-overlay"
            onclick="if(event.target === this) closeModal('invitation-link-modal')">
            <div class="modal-content"
                style="max-width: 500px; background: var(--card-light); border-radius: 16px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <h2 style="margin-bottom: 20px;">✅ Einladungslink erstellt</h2>
                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 12px;">Teile diesen Link mit der Person:</p>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="invitation-link-display" class="input-field" readonly style="flex: 1;">
                        <button class="btn-primary" onclick="copyInvitationLink()">📋 Kopieren</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="closeModal('invitation-link-modal')">Schließen</button>
                </div>
            </div>
        </div>

        <!-- Edit Permissions Modal -->
        <div id="edit-permissions-modal" class="modal-overlay" style="z-index: 9999;"
            onclick="if(event.target === this) closeModal('edit-permissions-modal')">
            <div class="modal-content"
                style="max-width: 600px; background: var(--card-light); border-radius: 16px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <h2 style="margin-bottom: 10px;">🔐 Berechtigungen bearbeiten</h2>
                <p id="edit-permissions-role-name" style="opacity: 0.7; margin-bottom: 20px;"></p>

                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 16px; font-weight: 500;">Wähle die Apps, die diese Rolle sehen
                        darf:</p>

                    <div id="permissions-app-list"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <!-- Apps werden hier dynamisch eingefügt -->
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button class="btn-secondary" onclick="closeModal('edit-permissions-modal')">Abbrechen</button>
                    <button class="btn-primary" onclick="saveRolePermissions()">💾 Speichern</button>
                </div>
            </div>
        </div>

        <!-- MANNSCHAFTSKASSE VIEW -->
        <div id="kasse" class="app-view" style="max-width: 100%; width: 100%;">
            <h1>Mannschaftskasse</h1>
            <p class="subtitle">Ein- und Ausgaben verwalten</p>

            <!-- Kassenstand Karte -->
            <div
                style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; padding: 24px; color: white; margin-bottom: 24px; max-width: 100%;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Aktueller Kassenstand</div>
                <div id="kasseBalance" style="font-size: 36px; font-weight: 700;">0,00 €</div>
                <div style="display: flex; gap: 24px; margin-top: 16px; font-size: 14px;">
                    <div>
                        <span style="opacity: 0.8;">↑ Einnahmen:</span>
                        <span id="kasseTotalIncome" style="font-weight: 600;">0,00 €</span>
                    </div>
                    <div>
                        <span style="opacity: 0.8;">↓ Ausgaben:</span>
                        <span id="kasseTotalExpense" style="font-weight: 600;">0,00 €</span>
                    </div>
                </div>
            </div>

            <!-- Chart Container -->
            <div
                style="background: var(--card-light); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--border-light);">
                <h3 style="margin: 0 0 16px 0; font-size: 16px;">📈 Kassenverlauf</h3>
                <div style="height: 200px; position: relative;">
                    <canvas id="kasseChart"></canvas>
                </div>
            </div>

            <!-- Neue Transaktion Button -->
            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <button onclick="openKasseModal('income')"
                    style="flex: 1; padding: 14px; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ➕ Einnahme
                </button>
                <button onclick="openKasseModal('expense')"
                    style="flex: 1; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ➖ Ausgabe
                </button>
            </div>

            <!-- Transaktionsliste -->
            <div
                style="background: var(--card-light); border-radius: 16px; padding: 20px; border: 1px solid var(--border-light);">
                <h3 style="margin: 0 0 16px 0; font-size: 16px;">📋 Letzte Transaktionen</h3>
                <div id="kasseTransactionsList" style="display: flex; flex-direction: column; gap: 12px;">
                    <p style="text-align: center; opacity: 0.6; padding: 20px;">Noch keine Transaktionen</p>
                </div>
            </div>
        </div>

        <!-- Kasse Modal -->
        <div id="kasseModalOverlay"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background: var(--card-light); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 20px;" id="kasseModalTitle">Neue Einnahme</h2>
                    <button onclick="closeKasseModal()"
                        style="background: none; border: none; font-size: 24px; cursor: pointer; opacity: 0.6;">×</button>
                </div>

                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <input type="hidden" id="kasseTransactionType" value="income">
                    <div>
                        <label
                            style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Betrag
                            *</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="kasseAmount" placeholder="0.00" step="0.01" min="0"
                                style="flex: 1; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 18px; font-weight: 600; text-align: right;">
                            <span style="font-size: 18px; font-weight: 600;">€</span>
                        </div>
                    </div>
                    <div>
                        <label
                            style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Beschreibung
                            *</label>
                        <input type="text" id="kasseDescription" placeholder="z.B. Mannschaftsbeitrag, Trikots..."
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label
                            style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Datum</label>
                        <input type="date" id="kasseDate"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label
                            style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">Kategorie</label>
                        <select id="kasseCategory"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            <option value="beitrag">Beitrag</option>
                            <option value="spende">Spende</option>
                            <option value="sponsor">Sponsor</option>
                            <option value="ausruestung">Ausrüstung</option>
                            <option value="platzmiete">Platzmiete</option>
                            <option value="transport">Transport</option>
                            <option value="verpflegung">Verpflegung</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button onclick="closeKasseModal()"
                        style="flex: 1; padding: 12px; background: #e5e5ea; color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Abbrechen</button>
                    <button onclick="saveKasseTransaction()" id="kasseModalSaveBtn"
                        style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Speichern</button>
                </div>
            </div>
        </div>

        <div id="settings" class="app-view" style="overflow-y: auto !important;">
            <h1>Einstellungen</h1>
            <p class="subtitle">Profil & App Konfiguration</p>

            <h2 style="margin-bottom: 20px; font-size: 20px;">👤 Mein Profil</h2>
            <div class="list-container" style="padding: 20px;">
                <div style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label
                                style="display: block; margin-bottom: 5px; font-size: 12px; opacity: 0.7;">Vorname</label>
                            <input type="text" id="profileVorname" placeholder="Dein Vorname"
                                style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); font-size: 14px;">
                        </div>
                        <div>
                            <label
                                style="display: block; margin-bottom: 5px; font-size: 12px; opacity: 0.7;">Nachname</label>
                            <input type="text" id="profileNachname" placeholder="Dein Nachname"
                                style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); font-size: 14px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; opacity: 0.7;">E-Mail</label>
                        <input type="email" id="profileEmail" placeholder="deine@email.de" disabled
                            style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); font-size: 14px; opacity: 0.6; cursor: not-allowed;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; opacity: 0.7;">Teamname
                            / Verein</label>
                        <input type="text" id="profileTeamname" placeholder="z.B. FC Musterstadt"
                            style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; opacity: 0.7;">Rolle
                            / Position</label>
                        <select id="profileRolle"
                            style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); font-size: 14px;">
                            <option value="">Bitte wählen...</option>
                            <option value="Trainer">Trainer</option>
                            <option value="Co-Trainer">Co-Trainer</option>
                            <option value="Sportdirektor">Sportdirektor</option>
                            <option value="Manager">Manager</option>
                            <option value="Analyst">Analyst</option>
                            <option value="Betreuer">Betreuer</option>
                            <option value="Physiotherapeut">Physiotherapeut</option>
                            <option value="Andere">Andere</option>
                        </select>
                    </div>
                    <button onclick="saveProfile()"
                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px;">
                        💾 Profil speichern
                    </button>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">⚙️ App Einstellungen</h2>
            <div class="list-container">
                <div class="list-item">
                    <span>Dark Mode</span>
                    <input type="checkbox" id="darkModeToggle" onchange="toggleTheme()" style="cursor: pointer;">
                </div>
                <div class="list-item">
                    <span>Sprache</span>
                    <span style="opacity: 0.7;">Deutsch</span>
                </div>
                <div class="list-item">
                    <span>Benachrichtigungen</span>
                    <span style="opacity: 0.7;">Aktiviert</span>
                </div>
                <div class="list-item">
                    <span>Version</span>
                    <span style="opacity: 0.7;">1.0.0</span>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">🔐 Sicherheit</h2>
            <div class="list-container">
                <div class="list-item" onclick="openTwoFactorSetup()" style="cursor: pointer;">
                    <span>🛡️ Zwei-Faktor-Authentifizierung</span>
                    <span id="2faStatus" style="opacity: 0.7;">Laden...</span>
                </div>
                <div class="list-item" onclick="showChangePassword()" style="cursor: pointer;">
                    <span>🔑 Passwort ändern</span>
                    <span style="opacity: 0.5;">→</span>
                </div>
                <div class="list-item" onclick="showActiveSessions()" style="cursor: pointer;">
                    <span>📱 Aktive Sitzungen</span>
                    <span style="opacity: 0.5;">→</span>
                </div>
            </div>

            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 20px;">Konto</h2>
            <div class="list-container">
                <div class="list-item" onclick="logout()" style="cursor: pointer;">
                    <span>🚪 Ausloggen</span>
                    <span style="opacity: 0.5;">→</span>
                </div>
                <div class="list-item" onclick="confirmDeleteAccount()" style="cursor: pointer;">
                    <span style="color: #ef4444;">🗑️ Account löschen</span>
                    <span style="opacity: 0.5;">→</span>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>
        // ========================
        // EVENT DELEGATION FÜR DYNAMISCHE BUTTONS
        // ========================
        document.addEventListener('click', function (e) {
            // Neue Einladung Button
            if (e.target && e.target.id === 'neue-einladung-btn') {
                e.preventDefault();
                console.log('Neue Einladung Button geklickt (delegation)!');
                const modal = document.getElementById('create-invitation-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    if (typeof loadRolesForInvitation === 'function') {
                        loadRolesForInvitation();
                    }
                } else {
                    alert('Modal nicht gefunden!');
                }
            }
        });

        // ========================
        // APPLE-STYLE TOAST NOTIFICATIONS
        // Ruhige, professionelle Benachrichtigungen
        // ========================
        function showToast(message, type = 'info') {
            // Entferne existierenden Toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                    position: fixed;
                    bottom: 30px;
                    left: 50%;
                    transform: translateX(-50%) translateY(20px);
                    padding: 14px 24px;
                    background: ${type === 'success' ? 'rgba(16, 185, 129, 0.95)' :
                    type === 'error' ? 'rgba(239, 68, 68, 0.95)' :
                        'rgba(59, 130, 246, 0.95)'};
                    color: white;
                    border-radius: 12px;
                    font-size: 14px;
                    font-weight: 500;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
                    backdrop-filter: blur(10px);
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity var(--anim-duration-slow) var(--anim-easing),
                                transform var(--anim-duration-slow) var(--anim-easing);
                `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========================
        // SECURITY: HTML Escaping für XSS-Prävention
        // ========================
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ========================
        // CURRENT USER (vom Backend)
        // ========================
        const currentUserId = {{ user.get('id', 0) if user else 0 }};
        const currentUserEmail = "{{ user.get('email', '') if user else '' }}";

        // Widget Counter für eindeutige IDs
        let widgetCounter = 0;

        // Helper für benutzerspezifischen localStorage
        function getUserStorageKey(key) {
            return `${key}_user_${currentUserId}`;
        }

        // ========================
        // APP STORE CONFIGURATION
        // ========================
        const ALL_APPS = [
            // Persönliches Profil - immer sichtbar
            { id: 'profil', name: 'Mein Profil', icon: '👤', category: 'free', canDisable: false },
            // Kostenlose Apps
            { id: 'home', name: 'Home', icon: '🏠', category: 'free', canDisable: false },
            { id: 'kader', name: 'Kader', icon: '👥', category: 'free', canDisable: true },
            { id: 'kalender', name: 'Kalender', icon: '📅', category: 'free', canDisable: true },
            { id: 'messenger', name: 'Messenger', icon: '💬', category: 'free', canDisable: true },
            { id: 'taktik', name: 'Taktik-Tafel', icon: '⚽', category: 'free', canDisable: true },
            { id: 'upload', name: 'Video Upload', icon: '📹', category: 'free', canDisable: true },
            { id: 'tipps', name: 'Tipps & Tutorials', icon: '💡', category: 'free', canDisable: true },
            { id: 'verwaltung', name: 'Verwaltung', icon: '👔', category: 'free', canDisable: true },
            { id: 'kasse', name: 'Mannschaftskasse', icon: '💵', category: 'free', canDisable: true },
            // Premium Apps
            { id: 'analyse', name: 'Analyse', icon: '📈', category: 'premium', canDisable: true },
            { id: 'training', name: 'Training', icon: '🏋️', category: 'premium', canDisable: true },
            { id: 'medizin', name: 'Medizin', icon: '⚕️', category: 'premium', canDisable: true },
            { id: 'finanzen', name: 'Finanzen', icon: '💰', category: 'premium', canDisable: true },
            // Coming Soon
            { id: 'scouting', name: 'Scouting', icon: '🔍', category: 'soon', canDisable: true },
            { id: 'liga', name: 'Liga', icon: '🏆', category: 'soon', canDisable: true }
        ];

        // Default: Alle kostenlosen Apps aktiv
        const DEFAULT_APP_CONFIG = {
            profil: { sidebar: true, home: true },
            home: { sidebar: true, home: true },
            kader: { sidebar: true, home: true },
            kalender: { sidebar: true, home: true },
            messenger: { sidebar: true, home: true },
            taktik: { sidebar: true, home: true },
            upload: { sidebar: true, home: true },
            tipps: { sidebar: true, home: true },
            verwaltung: { sidebar: true, home: true },
            kasse: { sidebar: true, home: true },
            analyse: { sidebar: false, home: false },
            training: { sidebar: false, home: false },
            medizin: { sidebar: false, home: false },
            finanzen: { sidebar: false, home: false },
            scouting: { sidebar: false, home: false },
            liga: { sidebar: false, home: false }
        };

        // Benutzer-Berechtigungen (werden beim Laden gesetzt)
        let userPermissions = null;
        let isTeamAdmin = false;
        let isTeamStaff = false;

        async function loadUserPermissions() {
            try {
                const response = await fetch('/api/team/info');
                const data = await response.json();

                if (data.has_team) {
                    userPermissions = data.permissions || {};
                    isTeamAdmin = data.is_admin || false;
                    const staffRoles = ['Admin', 'Trainer', 'Co-Trainer', 'Torwarttrainer', 'Betreuer', 'Physio', 'Jugendleiter', 'Vorstand'];
                    const roleName = (data.role_name || '').trim();
                    isTeamStaff = staffRoles.includes(roleName);
                } else {
                    // Kein Team = alle Apps erlaubt (für Admins/Ersteller)
                    userPermissions = null;
                    isTeamAdmin = true;
                    isTeamStaff = true;
                }

                console.log('User permissions loaded:', userPermissions, 'isAdmin:', isTeamAdmin, 'isStaff:', isTeamStaff);
            } catch (error) {
                console.error('Fehler beim Laden der Berechtigungen:', error);
                userPermissions = null;
                isTeamAdmin = true;
                isTeamStaff = true;
            }
        }

        function canViewApp(appId) {
            // Wenn keine Berechtigungen geladen oder Admin = alles erlaubt
            if (!userPermissions || isTeamAdmin) return true;

            // Home, Store, Settings immer erlaubt
            if (['home', 'store', 'settings'].includes(appId)) return true;

            // Prüfe Berechtigung
            return userPermissions[appId]?.view || false;
        }

        function getAppConfig() {
            const stored = localStorage.getItem('appConfig');
            if (stored) {
                try {
                    const config = JSON.parse(stored);
                    // Füge fehlende Apps hinzu (z.B. wenn neue Apps hinzugefügt wurden)
                    let needsSave = false;
                    Object.keys(DEFAULT_APP_CONFIG).forEach(appId => {
                        if (!config[appId]) {
                            config[appId] = { ...DEFAULT_APP_CONFIG[appId] };
                            needsSave = true;
                        }
                    });
                    // Speichere aktualisierte Config
                    if (needsSave) {
                        localStorage.setItem('appConfig', JSON.stringify(config));
                    }
                    return config;
                } catch (e) {
                    return { ...DEFAULT_APP_CONFIG };
                }
            }
            return { ...DEFAULT_APP_CONFIG };
        }

        function saveAppConfig(config) {
            localStorage.setItem('appConfig', JSON.stringify(config));
        }

        function toggleAppVisibility(appId, location) {
            const config = getAppConfig();
            if (!config[appId]) config[appId] = { sidebar: false, home: false };
            config[appId][location] = !config[appId][location];

            // Home muss immer in Sidebar bleiben
            if (appId === 'home') {
                config[appId].sidebar = true;
                config[appId].home = true;
            }

            saveAppConfig(config);
            renderSidebar();
            renderHomeGrid();
            updateAddWidgetVisibility('home');
            renderAppStore();
        }

        function renderSidebar() {
            const config = getAppConfig();
            const sidebarContainer = document.getElementById('sidebarModules');

            let html = '<div class="sidebar-section"><div class="sidebar-title">Module</div>';

            ALL_APPS.forEach(app => {
                // Prüfe ob User diese App sehen darf
                if (!canViewApp(app.id)) return;

                // Verwaltung nur für Admins anzeigen
                if (app.adminOnly && !isTeamAdmin) return;

                if (config[app.id]?.sidebar) {
                    const isActive = document.getElementById(app.id)?.classList.contains('active') ? 'active' : '';

                    if (app.category === 'premium') {
                        html += `
                                <div class="app-item ${isActive}" onclick="switchApp('${app.id}')" style="position: relative;">
                                    <div class="app-icon-small">${app.icon}</div>
                                    <div class="app-label">${app.name}</div>
                                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 6px; font-size: 9px; font-weight: bold;">💎</span>
                                </div>`;
                    } else if (app.category === 'soon') {
                        html += `
                                <div class="app-item" style="opacity: 0.6; cursor: not-allowed; position: relative;">
                                    <div class="app-icon-small">${app.icon}</div>
                                    <div class="app-label">${app.name}</div>
                                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #f59e0b; color: white; padding: 2px 6px; border-radius: 6px; font-size: 9px; font-weight: bold;">Soon</span>
                                </div>`;
                    } else {
                        html += `
                                <div class="app-item ${isActive}" onclick="switchApp('${app.id}')">
                                    <div class="app-icon-small">${app.icon}</div>
                                    <div class="app-label">${app.name}</div>
                                </div>`;
                    }
                }
            });

            html += '</div>';
            sidebarContainer.innerHTML = html;
        }

        function getHomeAppPositions() {
            const stored = localStorage.getItem('homeAppPositions');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    return {};
                }
            }
            return {};
        }

        function saveHomeAppPositions(positions) {
            localStorage.setItem('homeAppPositions', JSON.stringify(positions));
        }

        function renderHomeGrid() {
            console.log('renderHomeGrid() called');
            const config = getAppConfig();
            const homeGrid = document.querySelector('#home .app-grid');
            if (!homeGrid) {
                console.error('homeGrid not found!');
                return;
            }
            console.log('homeGrid found:', homeGrid);

            const positions = getHomeAppPositions();
            homeGrid.innerHTML = '';

            let index = 0;
            const gridSize = 120;
            const cols = 6;

            ALL_APPS.forEach(app => {
                // Prüfe ob User diese App sehen darf
                if (!canViewApp(app.id)) return;

                // Verwaltung nur für Admins anzeigen
                if (app.adminOnly && !isTeamAdmin) return;

                if (config[app.id]?.home && app.id !== 'home') {
                    const tile = document.createElement('div');
                    tile.className = 'app-tile';
                    tile.dataset.appId = app.id;
                    tile.draggable = true;

                    // Position aus localStorage oder Standard-Grid
                    if (positions[app.id]) {
                        tile.style.left = positions[app.id].left;
                        tile.style.top = positions[app.id].top;
                    } else {
                        const col = index % cols;
                        const row = Math.floor(index / cols);
                        tile.style.left = (col * gridSize + 20) + 'px';
                        tile.style.top = (row * gridSize + 20) + 'px';
                    }

                    let badgeHtml = '';
                    if (app.category === 'premium') {
                        badgeHtml = '<span style="position: absolute; top: -6px; right: -6px; background: #8b5cf6; color: white; padding: 2px 5px; border-radius: 6px; font-size: 8px; font-weight: bold;">💎</span>';
                        tile.onclick = () => switchApp(app.id);
                    } else if (app.category === 'soon') {
                        badgeHtml = '<span style="position: absolute; top: -6px; right: -6px; background: #f59e0b; color: white; padding: 2px 5px; border-radius: 6px; font-size: 8px; font-weight: bold;">Soon</span>';
                        tile.style.opacity = '0.6';
                        tile.style.cursor = 'not-allowed';
                        tile.draggable = false;
                    } else {
                        tile.onclick = () => switchApp(app.id);
                    }

                    tile.innerHTML = `
                            <div class="app-icon" style="position: relative;">${app.icon}${badgeHtml}</div>
                            <div class="app-name">${app.name}</div>
                        `;

                    homeGrid.appendChild(tile);
                    index++;
                }
            });

            // Add Widget Button
            const addBtn = document.createElement('div');
            addBtn.className = 'add-widget';
            addBtn.dataset.appId = 'add-widget';
            addBtn.draggable = true;
            addBtn.onclick = () => switchApp('store');

            if (positions['add-widget']) {
                addBtn.style.left = positions['add-widget'].left;
                addBtn.style.top = positions['add-widget'].top;
            } else {
                const col = index % cols;
                const row = Math.floor(index / cols);
                addBtn.style.left = (col * gridSize + 20) + 'px';
                addBtn.style.top = (row * gridSize + 20) + 'px';
            }

            addBtn.innerHTML = `
                    <div class="add-icon">+</div>
                    <div class="add-text">Apps</div>
                `;
            homeGrid.appendChild(addBtn);

            // Restore saved widgets from localStorage
            restoreSavedWidgets(homeGrid);

            // Setup Drag & Drop
            setupHomeDragDrop();
        }

        // Funktion zum Wiederherstellen gespeicherter Widgets
        function restoreSavedWidgets(grid) {
            console.log('restoreSavedWidgets() called');
            const savedPositions = localStorage.getItem('appPositions');
            console.log('Saved positions:', savedPositions);
            if (!savedPositions) {
                console.log('No saved positions found');
                return;
            }

            try {
                const positions = JSON.parse(savedPositions);
                console.log('Parsed positions:', positions);
                Object.entries(positions).forEach(([id, data]) => {
                    console.log('Processing:', id, data);
                    if (data.type === 'widget' && data.widgetType && widgetTemplates[data.widgetType]) {
                        console.log('Creating widget:', id, data.widgetType);
                        // Widget bereits vorhanden? Überspringen
                        if (document.getElementById(id)) return;

                        const widget = document.createElement('div');
                        widget.className = 'widget-container';
                        widget.draggable = true;
                        widget.id = id;
                        widget.dataset.widgetType = data.widgetType;

                        // App-ID für Navigation
                        const appWidgets = ['kader', 'kalender', 'messenger', 'analyse', 'training', 'medizin', 'finanzen', 'kasse', 'taktik', 'upload', 'scouting'];
                        if (appWidgets.includes(data.widgetType)) {
                            widget.dataset.appId = data.widgetType;
                        }

                        const content = widgetTemplates[data.widgetType]();
                        let headerText = '';
                        try {
                            headerText = content.split('</div>')[0].split('>')[1] || '';
                        } catch (e) {
                            headerText = '';
                        }
                        let restContent = '';
                        try {
                            restContent = content.split('</div>')[1] ? content.substring(content.indexOf('</div>') + 6) : '';
                        } catch (e) {
                            restContent = '';
                        }

                        widget.innerHTML = `
                                <div class="widget-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="flex: 1;">${headerText}</span>
                                    <span class="widget-delete" onclick="event.stopPropagation(); deleteWidget('${id}')">✕</span>
                                </div>
                                ${restContent}
                            `;

                        // Position aus localStorage
                        widget.style.left = data.left || '0px';
                        widget.style.top = data.top || '0px';

                        // Klickbar für Navigation
                        if (widget.dataset.appId) {
                            widget.addEventListener('click', (e) => {
                                if (e.target.classList.contains('widget-delete')) return;
                                if (widget.classList.contains('dragging')) return;
                                switchApp(widget.dataset.appId);
                            });
                        }

                        grid.appendChild(widget);
                    }
                });

                // Widget-Daten aktualisieren
                setTimeout(() => {
                    updateAllWidgetData();
                }, 500);
            } catch (e) {
                console.error('Fehler beim Wiederherstellen der Widgets:', e);
            }
        }

        function setupHomeDragDrop() {
            const grid = document.getElementById('appGrid');
            if (!grid) return;

            let draggedTile = null;
            let offsetX = 0;
            let offsetY = 0;

            // Gemeinsame Drag-Logik für alle ziehbaren Elemente
            const setupDraggable = (element) => {
                element.addEventListener('dragstart', (e) => {
                    if (element.style.cursor === 'not-allowed') {
                        e.preventDefault();
                        return;
                    }
                    draggedTile = element;
                    element.classList.add('dragging');
                    const rect = element.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    e.dataTransfer.effectAllowed = 'move';
                });

                element.addEventListener('dragend', (e) => {
                    element.classList.remove('dragging');
                    draggedTile = null;
                });
            };

            // App-Tiles draggable machen
            grid.querySelectorAll('.app-tile').forEach(setupDraggable);

            // Add-Widget Button auch draggable machen
            const addWidget = grid.querySelector('.add-widget');
            if (addWidget) {
                setupDraggable(addWidget);
            }

            grid.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedTile) {
                    const gridRect = grid.getBoundingClientRect();
                    let newX = e.clientX - gridRect.left - offsetX;
                    let newY = e.clientY - gridRect.top - offsetY;

                    // Snap to grid
                    const snapSize = 20;
                    newX = Math.round(newX / snapSize) * snapSize;
                    newY = Math.round(newY / snapSize) * snapSize;

                    // Boundaries
                    newX = Math.max(0, Math.min(newX, gridRect.width - 100));
                    newY = Math.max(0, Math.min(newY, gridRect.height - 100));

                    draggedTile.style.left = newX + 'px';
                    draggedTile.style.top = newY + 'px';
                }
            });

            grid.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedTile) {
                    // Save positions
                    const positions = getHomeAppPositions();
                    const appId = draggedTile.dataset.appId;
                    if (appId) {
                        positions[appId] = {
                            left: draggedTile.style.left,
                            top: draggedTile.style.top
                        };
                        saveHomeAppPositions(positions);
                    }
                }
            });
        }

        function renderAppStore() {
            const config = getAppConfig();

            // Free Apps
            const freeGrid = document.getElementById('storeAppsGrid');
            let freeHtml = '';
            ALL_APPS.filter(a => a.category === 'free').forEach(app => {
                const sidebarChecked = config[app.id]?.sidebar ? 'checked' : '';
                const homeChecked = config[app.id]?.home ? 'checked' : '';
                const disabled = !app.canDisable ? 'disabled' : '';

                freeHtml += `
                        <div class="store-app-card" style="background: var(--card-bg); border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="font-size: 40px;">${app.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color); font-size: 16px;">${app.name}</div>
                                <div style="display: flex; gap: 16px; margin-top: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: ${disabled ? 'not-allowed' : 'pointer'};">
                                        <input type="checkbox" ${sidebarChecked} ${disabled} onchange="toggleAppVisibility('${app.id}', 'sidebar')" style="width: 18px; height: 18px; cursor: ${disabled ? 'not-allowed' : 'pointer'};">
                                        <span style="color: var(--secondary-text); font-size: 13px;">Sidebar</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: ${disabled ? 'not-allowed' : 'pointer'};">
                                        <input type="checkbox" ${homeChecked} ${disabled} onchange="toggleAppVisibility('${app.id}', 'home')" style="width: 18px; height: 18px; cursor: ${disabled ? 'not-allowed' : 'pointer'};">
                                        <span style="color: var(--secondary-text); font-size: 13px;">Home</span>
                                    </label>
                                </div>
                            </div>
                        </div>`;
            });
            freeGrid.innerHTML = freeHtml;

            // Premium Apps
            const premiumGrid = document.getElementById('storePremiumGrid');
            let premiumHtml = '';
            ALL_APPS.filter(a => a.category === 'premium').forEach(app => {
                const sidebarChecked = config[app.id]?.sidebar ? 'checked' : '';
                const homeChecked = config[app.id]?.home ? 'checked' : '';

                premiumHtml += `
                        <div class="store-app-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="font-size: 40px;">${app.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color); font-size: 16px;">${app.name} <span style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; margin-left: 8px;">💎 Premium</span></div>
                                <div style="display: flex; gap: 16px; margin-top: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" ${sidebarChecked} onchange="toggleAppVisibility('${app.id}', 'sidebar')" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="color: var(--secondary-text); font-size: 13px;">Sidebar</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" ${homeChecked} onchange="toggleAppVisibility('${app.id}', 'home')" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="color: var(--secondary-text); font-size: 13px;">Home</span>
                                    </label>
                                </div>
                            </div>
                        </div>`;
            });
            premiumGrid.innerHTML = premiumHtml;

            // Coming Soon Apps
            const soonGrid = document.getElementById('storeComingSoonGrid');
            let soonHtml = '';
            ALL_APPS.filter(a => a.category === 'soon').forEach(app => {
                const sidebarChecked = config[app.id]?.sidebar ? 'checked' : '';
                const homeChecked = config[app.id]?.home ? 'checked' : '';

                soonHtml += `
                        <div class="store-app-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="font-size: 40px;">${app.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color); font-size: 16px;">${app.name} <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; margin-left: 8px;">🚀 Soon</span></div>
                                <div style="display: flex; gap: 16px; margin-top: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" ${sidebarChecked} onchange="toggleAppVisibility('${app.id}', 'sidebar')" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="color: var(--secondary-text); font-size: 13px;">Sidebar</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" ${homeChecked} onchange="toggleAppVisibility('${app.id}', 'home')" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="color: var(--secondary-text); font-size: 13px;">Home</span>
                                    </label>
                                </div>
                            </div>
                        </div>`;
            });
            soonGrid.innerHTML = soonHtml;
        }

        function switchApp(appName) {
            console.log('switchApp called with:', appName);

            // Schließe Mobile Menu
            closeMobileMenu();

            // Schließe Video Player Modal falls offen
            const videoModal = document.getElementById('videoPlayerModal');
            if (videoModal && videoModal.style.display !== 'none') {
                closeVideoPlayer();
            }

            // Alle Views und Items deaktivieren
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.app-item').forEach(i => i.classList.remove('active'));

            // Neue View aktivieren
            const appElement = document.getElementById(appName);
            console.log('App element:', appElement);
            if (!appElement) {
                console.error('App element not found:', appName);
                return;
            }

            appElement.classList.add('active');
            console.log('Active class added to:', appName);
            updateAddWidgetVisibility(appName);

            // Sidebar-Item aktivieren
            const sidebarItem = document.querySelector(`.app-item[onclick*="'${appName}'"]`);
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }

            // Initialize specific apps
            if (appName === 'kalender') {
                console.log('Initializing calendar');
                initializeCalendar();
            } else if (appName === 'dashboard') {
                setTimeout(() => {
                    renderDashboardStats();
                }, 100);
            } else if (appName === 'taktik') {
                setTimeout(() => {
                    initTaktik();
                }, 100);
            } else if (appName === 'settings') {
                setTimeout(() => {
                    loadProfile();
                }, 100);
            } else if (appName === 'store') {
                setTimeout(() => {
                    renderAppStore();
                }, 100);
            } else if (appName === 'verwaltung') {
                setTimeout(() => {
                    loadVerwaltungData();
                }, 100);
            } else if (appName === 'kasse') {
                setTimeout(() => {
                    initializeKasse();
                }, 100);
            } else if (appName === 'profil') {
                setTimeout(() => {
                    loadProfile();  // Verwendet die rollenbasierte Funktion
                }, 100);
            } else if (appName === 'upload') {
                setTimeout(() => {
                    loadTeamVideos();
                    loadSharedClips();
                }, 100);
            }
        }

        function updateAddWidgetVisibility(activeApp) {
            const addBtn = document.getElementById('floatingAddWidget');
            if (!addBtn) return;
            const show = activeApp === 'home';
            addBtn.classList.toggle('is-visible', show);
        }

        // Alias für Legacy-Code
        const showPage = switchApp;

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            document.getElementById('darkModeToggle').checked = document.body.classList.contains('dark-mode');
            // Re-render Teams für Dark Mode Update
            if (typeof renderTeamsList === 'function') {
                renderTeamsList();
            }
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobileSidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Schließe Mobile Menu wenn App gewechselt wird
        function closeMobileMenu() {
            const sidebar = document.getElementById('mobileSidebar');
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
        }

        // Schließe Menu bei Klick außerhalb
        document.addEventListener('click', function (e) {
            const sidebar = document.getElementById('mobileSidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            if (sidebar && sidebar.classList.contains('mobile-open')) {
                if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

        // Profil laden - rollenbasiert
        async function loadProfile() {
            try {
                // Zuerst Team-Info laden um die echte Rolle zu bekommen
                const teamResponse = await fetch('/api/team/info');
                let teamRolle = '';
                let isTeamAdmin = false;
                let teamInfo = null;

                if (teamResponse.ok) {
                    teamInfo = await teamResponse.json();
                    teamRolle = (teamInfo.role_name || '').toLowerCase();
                    isTeamAdmin = teamInfo.is_admin || false;
                    console.log('[Profil] Team-Rolle:', teamInfo.role_name, '| isAdmin:', isTeamAdmin);
                    loadTeamManager(teamInfo);
                }

                const response = await fetch('/api/profile');
                const data = await response.json();

                if (!data.error) {
                    // Rolle: Zuerst aus Team-Info, dann Fallback auf Profile
                    const rolle = teamRolle || (data.rolle || '').toLowerCase();

                    console.log('[DEBUG] Finale Rolle:', rolle, '| data.rolle:', data.rolle, '| teamRolle:', teamRolle);

                    // Helper-Funktion
                    const setVal = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.value = val || '';
                    };

                    // Einstellungen-Seite (profile* mit 'e')
                    setVal('profileVorname', data.vorname);
                    setVal('profileNachname', data.nachname);
                    setVal('profileEmail', data.email);
                    setVal('profileTeamname', data.teamname);
                    setVal('profileRolle', data.rolle);

                    // Basis-Profil (für alle Rollen)
                    setVal('profilVorname', data.vorname);
                    setVal('profilNachname', data.nachname);
                    setVal('profilEmail', data.email);
                    setVal('profilTelefon', data.telefon);
                    setVal('profilGeburtsdatum', data.geburtsdatum);
                    setVal('profilWerdegang', data.werdegang);

                    // Rollenspezifische Cards anzeigen/verstecken
                    const spielerCard = document.getElementById('spielerProfilCard');
                    const trainerCard = document.getElementById('trainerProfilCard');
                    const profilTypWaehler = document.getElementById('profilTypWaehler');

                    if (spielerCard) spielerCard.style.display = 'none';
                    if (trainerCard) trainerCard.style.display = 'none';
                    if (profilTypWaehler) profilTypWaehler.style.display = 'none';

                    // Rollen-Checks - case-insensitive
                    const rolleLower = rolle.toLowerCase();
                    const isSpieler = rolleLower === 'spieler';
                    const isAdmin = isTeamAdmin || rolleLower === 'admin';
                    const isTrainer = rolleLower === 'trainer' || rolleLower === 'co-trainer';

                    console.log('[Profil] rolleLower:', rolleLower, '| isAdmin:', isAdmin, '| isTrainer:', isTrainer, '| isSpieler:', isSpieler);

                    // Admin kann Profil-Typ wählen
                    if (isAdmin) {
                        if (profilTypWaehler) profilTypWaehler.style.display = 'block';
                        // Gespeicherten Profil-Typ laden oder Standard: Trainer
                        const savedProfilTyp = localStorage.getItem('profilTyp') || 'trainer';
                        setProfilTyp(savedProfilTyp, data);
                    }
                    // Spieler-spezifische Felder
                    else if (isSpieler) {
                        if (spielerCard) spielerCard.style.display = 'block';
                        setVal('profilGroesse', data.groesse);
                        setVal('profilGewicht', data.gewicht);
                        setVal('profilPosition', data.position);
                        setVal('profilNebenpositionen', data.nebenpositionen);
                        setVal('profilStarkerFuss', data.starker_fuss);
                        setVal('profilJahrgang', data.jahrgang);
                    }
                    // Trainer-spezifische Felder
                    else if (isTrainer) {
                        if (trainerCard) trainerCard.style.display = 'block';
                        setVal('profilSpielsystem', data.spielsystem);
                        setVal('profilTaktischeGrundidee', data.taktische_grundidee);
                        setVal('profilTrainingsschwerpunkte', data.trainingsschwerpunkte);
                        setVal('profilBisherigeStationen', data.bisherige_stationen);
                        setVal('profilLizenzen', data.lizenzen);
                    }

                    // Avatar aktualisieren
                    const initials = (data.vorname?.charAt(0) || '') + (data.nachname?.charAt(0) || '');
                    if (initials && document.getElementById('profilAvatar')) {
                        document.getElementById('profilAvatar').textContent = initials.toUpperCase();
                    }

                    // Rolle global speichern für saveProfile
                    window.currentUserRolle = rolle;
                    // Profil-Daten global speichern für setProfilTyp
                    window.currentProfilData = data;

                    // Team-Info Box aktualisieren (wenn wir schon Team-Daten haben)
                    const teamInfoDiv = document.getElementById('profilTeamInfo');
                    if (teamInfoDiv && teamResponse.ok) {
                        const teamData = await teamResponse.json().catch(() => null);
                        // teamData wurde schon oben geladen, nutze die Variablen
                    }
                }

                // Team-Info Anzeige aktualisieren
                await updateTeamInfoDisplay();

            } catch (error) {
                console.error('Fehler beim Laden des Profils:', error);
            }
        }

        async function loadTeamManager(teamInfo) {
            const card = document.getElementById('teamManagerCard');
            if (!card) return;

            if (!teamInfo || !teamInfo.has_team || !teamInfo.is_primary_admin) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            const list = document.getElementById('teamList');
            const activeTeamId = teamInfo.team_id;

            try {
                const response = await fetch('/api/teams');
                const data = await response.json();
                const teams = data.teams || [];
                if (!teams.length) {
                    list.innerHTML = '<span style="opacity: 0.7; font-size: 13px;">Keine Mannschaften gefunden.</span>';
                    return;
                }

                list.innerHTML = teams.map(team => {
                    const isActive = team.id === activeTeamId;
                    const label = team.mannschaft || team.name || 'Mannschaft';
                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600;">${escapeHtml(label)}</div>
                                <div style="font-size: 12px; opacity: 0.7;">${escapeHtml(team.verein || '')}</div>
                            </div>
                            ${isActive ? '<span style="font-size: 12px; color: #22c55e; font-weight: 600;">Aktiv</span>'
                            : `<button class="btn-secondary" onclick="switchTeam(${team.id})">Wechseln</button>`}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                list.innerHTML = '<span style="opacity: 0.7; font-size: 13px;">Teams konnten nicht geladen werden.</span>';
            }
        }

        async function createAdditionalTeam() {
            const input = document.getElementById('newMannschaftName');
            const errorEl = document.getElementById('teamCreateError');
            if (!input || !errorEl) return;

            const mannschaft = input.value.trim();
            if (!mannschaft) {
                errorEl.textContent = 'Bitte gib einen Mannschaftsnamen ein.';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/team/create/additional', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mannschaft })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    window.location.reload();
                } else {
                    errorEl.textContent = data.error || 'Fehler beim Anlegen der Mannschaft.';
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.textContent = 'Netzwerkfehler. Bitte versuche es erneut.';
                errorEl.style.display = 'block';
            }
        }

        async function switchTeam(teamId) {
            try {
                const response = await fetch('/api/teams/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team_id: teamId })
                });
                if (response.ok) {
                    window.location.reload();
                }
            } catch (e) {
                console.error('Teamwechsel fehlgeschlagen', e);
            }
        }

        // Team-Info Box im Profil aktualisieren
        async function updateTeamInfoDisplay() {
            try {
                const teamResponse = await fetch('/api/team/info');
                const teamInfoDiv = document.getElementById('profilTeamInfo');

                if (!teamInfoDiv) return;

                if (teamResponse.ok) {
                    const team = await teamResponse.json();

                    if (team.has_team) {
                        teamInfoDiv.innerHTML = `
                            <div class="profil-team-badge">
                                <span style="font-size: 24px;">⚽</span>
                                <div>
                                    <div style="font-weight: 600;">${escapeHtml(team.verein || team.team_name || 'Team')}</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${escapeHtml(team.mannschaft || '')}</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px; font-size: 14px;">
                                <div style="margin-bottom: 8px;"><strong>Rolle:</strong> ${escapeHtml(team.role_name || 'Mitglied')}</div>
                                ${team.is_admin ? '<div style="color: #22c55e;">✓ Team-Administrator</div>' : ''}
                            </div>
                        `;
                    } else {
                        teamInfoDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 40px; margin-bottom: 12px;">🏟️</div>
                                <p style="margin-bottom: 16px;">Du bist noch keinem Team beigetreten.</p>
                                <button onclick="switchApp('home')" 
                                    style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    Team erstellen
                                </button>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Fehler beim Laden der Team-Info:', e);
            }
        }

        // Profil-Typ wählen (für Admin)
        function setProfilTyp(typ, data = null) {
            const spielerCard = document.getElementById('spielerProfilCard');
            const trainerCard = document.getElementById('trainerProfilCard');
            const btnTrainer = document.getElementById('btnProfilTrainer');
            const btnSpieler = document.getElementById('btnProfilSpieler');

            // Daten aus globalem Speicher oder Parameter
            const profilData = data || window.currentProfilData || {};

            // Alle Cards ausblenden
            if (spielerCard) spielerCard.style.display = 'none';
            if (trainerCard) trainerCard.style.display = 'none';

            // Buttons zurücksetzen
            if (btnTrainer) {
                btnTrainer.style.background = 'transparent';
                btnTrainer.style.borderColor = 'var(--border-light)';
            }
            if (btnSpieler) {
                btnSpieler.style.background = 'transparent';
                btnSpieler.style.borderColor = 'var(--border-light)';
            }

            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            };

            if (typ === 'spieler') {
                if (spielerCard) spielerCard.style.display = 'block';
                if (btnSpieler) {
                    btnSpieler.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    btnSpieler.style.borderColor = '#10b981';
                    btnSpieler.style.color = 'white';
                }
                // Spieler-Felder laden
                setVal('profilGroesse', profilData.groesse);
                setVal('profilGewicht', profilData.gewicht);
                setVal('profilPosition', profilData.position);
                setVal('profilNebenpositionen', profilData.nebenpositionen);
                setVal('profilStarkerFuss', profilData.starker_fuss);
                setVal('profilJahrgang', profilData.jahrgang);
            } else {
                if (trainerCard) trainerCard.style.display = 'block';
                if (btnTrainer) {
                    btnTrainer.style.background = 'linear-gradient(135deg, #3b82f6, #8b5cf6)';
                    btnTrainer.style.borderColor = '#3b82f6';
                    btnTrainer.style.color = 'white';
                }
                // Trainer-Felder laden
                setVal('profilSpielsystem', profilData.spielsystem);
                setVal('profilTaktischeGrundidee', profilData.taktische_grundidee);
                setVal('profilTrainingsschwerpunkte', profilData.trainingsschwerpunkte);
                setVal('profilBisherigeStationen', profilData.bisherige_stationen);
                setVal('profilLizenzen', profilData.lizenzen);
            }

            // Typ speichern
            localStorage.setItem('profilTyp', typ);
            window.currentProfilTyp = typ;
        }

        // ========================
        // VERWALTUNG FUNCTIONS
        // ========================

        function switchVerwaltungTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.verwaltung-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.verwaltung-tab[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.verwaltung-content').forEach(c => c.style.display = 'none');
            document.getElementById(`verwaltung-${tabName}`).style.display = 'block';
        }

        async function loadVerwaltungData() {
            // Prüfe ob Team existiert, wenn nicht erstelle eines
            const checkResponse = await fetch('/api/team/info');
            const checkData = await checkResponse.json();

            if (checkData.error === "Kein Team gefunden") {
                // Auto-create team
                const profileResponse = await fetch('/api/profile');
                const profile = await profileResponse.json();

                await fetch('/api/team/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        verein: profile.verein || profile.teamname || 'Mein Verein',
                        mannschaft: profile.mannschaft || 'Erste Mannschaft'
                    })
                });
            }

            await Promise.all([
                loadTeamMembers(),
                loadTeamRoles(),
                loadInvitations()
            ]);
        }

        async function loadTeamMembers() {
            try {
                const response = await fetch('/api/team/members');
                const data = await response.json();

                const container = document.getElementById('team-members-list');

                const canManageMembers = isTeamAdmin || isTeamStaff;
                if (data.members && data.members.length > 0) {
                    container.innerHTML = data.members.map(m => `
                            <div class="member-card" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--card-light); border-radius: 12px; border: 1px solid var(--border-light);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                        ${escapeHtml((m.vorname || m.email)[0]).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: 500;">${m.vorname ? escapeHtml(m.vorname) + ' ' + escapeHtml(m.nachname || '') : escapeHtml(m.email)}</div>
                                        <div style="font-size: 12px; opacity: 0.7;">${escapeHtml(m.email)}</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="padding: 4px 12px; background: var(--primary-color); color: white; border-radius: 20px; font-size: 12px;">
                                        ${escapeHtml(m.role_name) || 'Keine Rolle'}
                                    </span>
                                    ${m.is_admin ? '<span style="font-size: 10px; opacity: 0.5;">Admin</span>' : `
                                        ${isTeamAdmin ? `<button onclick="changeMemberRole(${parseInt(m.id)})" style="background: none; border: none; cursor: pointer; font-size: 16px;">✏️</button>` : ''}
                                        ${canManageMembers ? `<button onclick="removeMember(${parseInt(m.id)})" style="background: none; border: none; cursor: pointer; font-size: 16px;">🗑️</button>` : ''}
                                    `}
                                </div>
                            </div>
                        `).join('');
                } else {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Noch keine Mitglieder. Erstelle eine Einladung!</p>';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Mitglieder:', error);
            }
        }

        async function loadTeamRoles() {
            try {
                const response = await fetch('/api/team/roles');
                const data = await response.json();

                const container = document.getElementById('team-roles-list');

                if (data.roles && data.roles.length > 0) {
                    container.innerHTML = data.roles.map(r => {
                        // permissions ist ein Object, nicht Array
                        const permsHtml = r.permissions ? Object.entries(r.permissions).map(([appId, perms]) => `
                                <span style="padding: 3px 8px; background: ${perms.view ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${perms.view ? '#22c55a' : '#ef4444'}; border-radius: 6px; font-size: 11px;">
                                    ${escapeHtml(appId)}
                                </span>
                            `).join('') : '';

                        return `
                            <div class="role-card" style="padding: 20px; background: var(--card-light); border-radius: 12px; border: 1px solid var(--border-light);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 16px;">${escapeHtml(r.name)}</h3>
                                        <p style="margin: 4px 0 0; font-size: 13px; opacity: 0.7;">${escapeHtml(r.description || '')}</p>
                                    </div>
                                    ${!r.is_default ? `<button onclick="deleteRole(${parseInt(r.id)})" style="background: none; border: none; cursor: pointer; font-size: 16px;">🗑️</button>` : ''}
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${permsHtml}
                                </div>
                                <button onclick="editRolePermissions(${parseInt(r.id)})" style="margin-top: 12px; background: var(--primary-color); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px;">
                                    Berechtigungen bearbeiten
                                </button>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Keine Rollen gefunden.</p>';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Rollen:', error);
            }
        }

        async function loadInvitations() {
            try {
                const response = await fetch('/api/invitations');
                const data = await response.json();

                const container = document.getElementById('invitations-list');

                if (data.invitations && data.invitations.length > 0) {
                    container.innerHTML = data.invitations.map(inv => `
                            <div class="invitation-card" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--card-light); border-radius: 12px; border: 1px solid var(--border-light);">
                                <div>
                                    <div style="font-weight: 500;">Für Rolle: ${escapeHtml(inv.role_name)}</div>
                                    <div style="font-size: 12px; opacity: 0.7;">
                                        Verwendet: ${parseInt(inv.uses)}/${parseInt(inv.max_uses)} • Gültig bis: ${new Date(inv.expires_at).toLocaleDateString('de-DE')}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="copyLink('${window.location.origin}/join/${escapeHtml(inv.token)}')" style="background: var(--primary-color); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px;">
                                        📋 Link kopieren
                                    </button>
                                    <button onclick="deleteInvitation(${parseInt(inv.id)})" style="background: none; border: none; cursor: pointer; font-size: 16px;">🗑️</button>
                                </div>
                            </div>
                        `).join('');
                } else {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Keine aktiven Einladungen.</p>';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Einladungen:', error);
            }
        }

        function showCreateRoleModal() {
            document.getElementById('new-role-name').value = '';
            document.getElementById('new-role-description').value = '';

            // App-Checkboxen generieren
            const container = document.getElementById('new-role-permissions');
            container.innerHTML = ALL_PERMISSION_APPS.map(app => `
                    <label class="permission-checkbox" style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--card-light); border: 2px solid var(--border-light); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="new-role-app" value="${escapeHtml(app.id)}" 
                            onchange="this.parentElement.style.borderColor = this.checked ? 'var(--primary-color)' : 'var(--border-light)'"
                            style="width: 18px; height: 18px; accent-color: var(--primary-color);">
                        <span style="font-size: 18px;">${escapeHtml(app.icon)}</span>
                        <span style="font-size: 13px; font-weight: 500;">${escapeHtml(app.name)}</span>
                    </label>
                `).join('');

            document.getElementById('create-role-modal').classList.add('active');
        }

        async function showCreateInvitationModal() {
            console.log('showCreateInvitationModal aufgerufen');

            const modal = document.getElementById('create-invitation-modal');
            const select = document.getElementById('invitation-role');

            if (!modal) {
                console.error('Modal create-invitation-modal nicht gefunden!');
                alert('Fehler: Modal nicht gefunden');
                return;
            }

            if (!select) {
                console.error('Select invitation-role nicht gefunden!');
                alert('Fehler: Select nicht gefunden');
                return;
            }

            // Load roles for dropdown
            try {
                console.log('Lade Rollen von /api/team/roles...');
                const response = await fetch('/api/team/roles');
                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Rollen geladen:', data);

                const roles = data.roles || [];

                if (roles.length === 0) {
                    select.innerHTML = '<option value="">Keine Rollen verfügbar</option>';
                } else {
                    select.innerHTML = roles.map(r => `<option value="${parseInt(r.id)}">${escapeHtml(r.name)}</option>`).join('');
                }

                document.getElementById('invitation-max-uses').value = 1;
                document.getElementById('invitation-days').value = 7;
                modal.style.display = 'flex';
                console.log('Modal geöffnet');
            } catch (error) {
                console.error('Fehler beim Laden der Rollen:', error);
                // Öffne Modal trotzdem mit Fallback
                select.innerHTML = '<option value="1">Spieler</option><option value="2">Trainer</option>';
                document.getElementById('invitation-max-uses').value = 1;
                document.getElementById('invitation-days').value = 7;
                modal.style.display = 'flex';
            }
        }

        // Vereinfachte Funktion zum Laden der Rollen im Modal
        async function loadRolesForInvitation() {
            const select = document.getElementById('invitation-role');
            if (!select) return;

            try {
                const response = await fetch('/api/team/roles');
                const data = await response.json();
                const roles = data.roles || [];

                if (roles.length > 0) {
                    select.innerHTML = roles.map(r => `<option value="${parseInt(r.id)}">${escapeHtml(r.name)}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="1">Spieler</option><option value="2">Trainer</option>';
                }
            } catch (e) {
                select.innerHTML = '<option value="1">Spieler</option><option value="2">Trainer</option>';
            }

            document.getElementById('invitation-max-uses').value = 1;
            document.getElementById('invitation-days').value = 7;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createRole() {
            const name = document.getElementById('new-role-name').value.trim();
            const description = document.getElementById('new-role-description').value.trim();

            if (!name) {
                alert('Bitte gib einen Rollennamen ein');
                return;
            }

            // Ausgewählte Apps sammeln
            const checkboxes = document.querySelectorAll('input[name="new-role-app"]:checked');
            const selectedApps = Array.from(checkboxes).map(cb => cb.value);

            // Permissions Array erstellen
            const permissions = ALL_PERMISSION_APPS.map(app => ({
                app_id: app.id,
                can_view: selectedApps.includes(app.id),
                can_edit: selectedApps.includes(app.id)
            }));

            try {
                const response = await fetch('/api/team/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, permissions })
                });

                const data = await response.json();
                console.log('Create role response:', data);

                if (data.success) {
                    closeModal('create-role-modal');
                    loadTeamRoles();
                    alert('✅ Rolle erfolgreich erstellt!');
                } else {
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler: ' + error.message);
            }
        }

        async function createInvitation() {
            const role_id = document.getElementById('invitation-role').value;
            const max_uses = parseInt(document.getElementById('invitation-max-uses').value);
            const days = parseInt(document.getElementById('invitation-days').value);

            if (!role_id) {
                alert('Bitte wähle eine Rolle aus');
                return;
            }

            try {
                const response = await fetch('/api/invitations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role_id: parseInt(role_id), max_uses, days_valid: days })
                });

                const data = await response.json();
                console.log('Einladung Response:', data);

                if (data.token) {
                    closeModal('create-invitation-modal');
                    const link = `${window.location.origin}/join/${data.token}`;
                    document.getElementById('invitation-link-display').value = link;
                    document.getElementById('invitation-link-modal').classList.add('active');
                    loadInvitations();
                } else {
                    alert('Fehler: ' + (data.error || 'Einladung konnte nicht erstellt werden'));
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Netzwerkfehler beim Erstellen der Einladung');
            }
        }

        function copyInvitationLink() {
            const input = document.getElementById('invitation-link-display');
            input.select();
            document.execCommand('copy');
            alert('✅ Link kopiert!');
        }

        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('✅ Link kopiert!');
            });
        }

        async function deleteInvitation(id) {
            if (!confirm('Einladung wirklich löschen?')) return;

            try {
                await fetch(`/api/invitations/${id}`, { method: 'DELETE' });
                loadInvitations();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function deleteRole(id) {
            if (!confirm('Rolle wirklich löschen? Mitglieder werden auf "Spieler" zurückgesetzt.')) return;

            try {
                await fetch(`/api/team/roles/${id}`, { method: 'DELETE' });
                loadTeamRoles();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function removeMember(id) {
            if (!confirm('Mitglied wirklich entfernen?')) return;

            try {
                await fetch(`/api/team/members/${id}`, { method: 'DELETE' });
                loadTeamMembers();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function changeMemberRole(memberId) {
            try {
                const response = await fetch('/api/team/roles');
                const data = await response.json();

                const roleNames = data.roles.map(r => r.name).join('\n');
                const newRole = prompt(`Neue Rolle eingeben:\n\nVerfügbare Rollen:\n${roleNames}`);

                if (newRole) {
                    const role = data.roles.find(r => r.name.toLowerCase() === newRole.toLowerCase());
                    if (role) {
                        await fetch(`/api/team/members/${memberId}/role`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ role_id: role.id })
                        });
                        loadTeamMembers();
                    } else {
                        alert('Rolle nicht gefunden');
                    }
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        // Alle verfügbaren Apps für Berechtigungen
        const ALL_PERMISSION_APPS = [
            { id: 'dashboard', name: 'Dashboard', icon: '📊' },
            { id: 'kader', name: 'Kader', icon: '👥' },
            { id: 'kalender', name: 'Kalender', icon: '📅' },
            { id: 'messenger', name: 'Messenger', icon: '💬' },
            { id: 'taktik', name: 'Taktik-Tafel', icon: '⚽' },
            { id: 'upload', name: 'Video Upload', icon: '📹' },
            { id: 'tipps', name: 'Tipps & Tutorials', icon: '💡' },
            { id: 'analyse', name: 'Analyse', icon: '📈' },
            { id: 'training', name: 'Training', icon: '🏋️' },
            { id: 'medizin', name: 'Medizin', icon: '⚕️' },
            { id: 'finanzen', name: 'Finanzen', icon: '💰' },
            { id: 'verwaltung', name: 'Verwaltung', icon: '👔' }
        ];

        let currentEditingRoleId = null;

        async function editRolePermissions(roleId) {
            try {
                const response = await fetch('/api/team/roles');
                const data = await response.json();
                const role = data.roles.find(r => r.id === roleId);

                if (!role) return;

                currentEditingRoleId = roleId;

                // Rollenname anzeigen
                document.getElementById('edit-permissions-role-name').textContent = `Rolle: ${role.name}`;

                // Aktuelle Berechtigungen
                const currentPerms = role.permissions || {};

                // App-Liste mit Checkboxen generieren
                const container = document.getElementById('permissions-app-list');
                container.innerHTML = ALL_PERMISSION_APPS.map(app => {
                    const hasPermission = currentPerms[app.id]?.view || false;
                    return `
                            <label class="permission-checkbox" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--card-light); border: 2px solid ${hasPermission ? 'var(--primary-color)' : 'var(--border-light)'}; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" name="app-permission" value="${app.id}" ${hasPermission ? 'checked' : ''} 
                                    onchange="this.parentElement.style.borderColor = this.checked ? 'var(--primary-color)' : 'var(--border-light)'"
                                    style="width: 20px; height: 20px; accent-color: var(--primary-color);">
                                <span style="font-size: 20px;">${app.icon}</span>
                                <span style="font-weight: 500;">${app.name}</span>
                            </label>
                        `;
                }).join('');

                // Modal öffnen
                document.getElementById('edit-permissions-modal').classList.add('active');

            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Laden der Berechtigungen');
            }
        }

        async function saveRolePermissions() {
            if (!currentEditingRoleId) return;

            try {
                // Ausgewählte Apps sammeln
                const checkboxes = document.querySelectorAll('input[name="app-permission"]:checked');
                const selectedApps = Array.from(checkboxes).map(cb => cb.value);

                // Alle Apps mit Berechtigungen
                const permissions = ALL_PERMISSION_APPS.map(app => ({
                    app_id: app.id,
                    can_view: selectedApps.includes(app.id),
                    can_edit: selectedApps.includes(app.id)
                }));

                const response = await fetch(`/api/team/roles/${currentEditingRoleId}/permissions`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ permissions })
                });

                const data = await response.json();

                if (data.success) {
                    closeModal('edit-permissions-modal');
                    loadTeamRoles();
                    alert('✅ Berechtigungen gespeichert!');
                } else {
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Speichern');
            }
        }

        // ========================
        // SECURITY FUNCTIONS
        // ========================

        async function load2FAStatus() {
            try {
                const response = await fetch('/2fa/status', { credentials: 'include' });
                const data = await response.json();
                const statusEl = document.getElementById('2faStatus');
                if (statusEl) {
                    statusEl.textContent = data.enabled ? '✅ Aktiviert' : '❌ Deaktiviert';
                    statusEl.style.color = data.enabled ? '#10b981' : '#ef4444';
                }
            } catch (e) {
                console.error('2FA status error:', e);
            }
        }

        function openTwoFactorSetup() {
            window.location.href = '/2fa/setup';
        }

        function showChangePassword() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center;
                justify-content: center; z-index: 10000; backdrop-filter: blur(5px);
            `;
            modal.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%;">
                    <h3 style="margin-bottom: 20px;">🔑 Passwort ändern</h3>
                    <div style="display: grid; gap: 15px;">
                        <input type="password" id="currentPassword" placeholder="Aktuelles Passwort"
                            style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color);">
                        <input type="password" id="newPassword" placeholder="Neues Passwort"
                            style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color);">
                        <input type="password" id="confirmPassword" placeholder="Passwort wiederholen"
                            style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color);">
                        <p style="font-size: 12px; opacity: 0.7;">Min. 8 Zeichen, Groß-/Kleinbuchstaben, Zahlen & Sonderzeichen</p>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="this.closest('.modal-overlay').remove()"
                                style="flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: transparent; color: var(--text-color); cursor: pointer;">
                                Abbrechen
                            </button>
                            <button onclick="changePassword()"
                                style="flex: 1; padding: 12px; border-radius: 10px; border: none; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; cursor: pointer; font-weight: 600;">
                                Ändern
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (newPw !== confirm) {
                alert('Passwörter stimmen nicht überein!');
                return;
            }
            if (newPw.length < 8) {
                alert('Passwort muss mindestens 8 Zeichen haben!');
                return;
            }

            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ current_password: current, new_password: newPw })
                });
                const data = await response.json();

                if (response.ok) {
                    showToast('Passwort erfolgreich geändert!', 'success');
                    document.querySelector('.modal-overlay').remove();
                } else {
                    alert(data.error || 'Fehler beim Ändern des Passworts');
                }
            } catch (e) {
                alert('Netzwerkfehler');
            }
        }

        function showActiveSessions() {
            showToast('Aktive Sitzungen: Diese Funktion wird bald verfügbar sein.', 'info');
        }

        // 2FA-Status beim Laden der Settings prüfen
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(load2FAStatus, 500);
        });

        function logout() {
            if (confirm('Möchtest du dich wirklich ausloggen?')) {
                // SECURITY: Alle lokalen Daten löschen (kritisch für Datenschutz!)
                localStorage.clear();
                sessionStorage.clear();
                // Zur Logout-Endpoint weiterleiten (löscht auch Server-Session)
                window.location.href = '/logout';
            }
        }

        function confirmDeleteAccount() {
            const confirmed = confirm('⚠️ ACHTUNG!\n\nMöchtest du deinen Account wirklich löschen?\n\nAlle deine Daten (Spieler, Kalender, Nachrichten, Taktiken) werden unwiderruflich gelöscht!\n\nDiese Aktion kann NICHT rückgängig gemacht werden.');

            if (confirmed) {
                const doubleConfirm = confirm('Bist du dir wirklich sicher?\n\nGib "OK" um deinen Account endgültig zu löschen.');

                if (doubleConfirm) {
                    deleteAccount();
                }
            }
        }

        async function deleteAccount() {
            try {
                // Alle lokalen Daten löschen
                localStorage.clear();
                sessionStorage.clear();

                // API Call zum Löschen des Accounts
                const response = await fetch('/api/account/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                alert('Dein Account wurde erfolgreich gelöscht. Auf Wiedersehen!');
                window.location.href = '/login';
            } catch (error) {
                console.error('Fehler beim Löschen:', error);
                // Trotzdem ausloggen
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login';
            }
        }

        // ============ NEUES VIDEO SYSTEM ============
        let teamVideos = [];
        let sharedClips = [];
        let currentVideoId = null;
        let clipStart = null;
        let clipEnd = null;
        let selectedFile = null;
        let selectedFileDuration = 0;
        let currentClipToShare = null;
        let selectedPlayersForShare = [];

        // Tab-Switching
        function switchVideoTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.video-tab-btn').forEach(btn => {
                btn.style.background = 'var(--card-light)';
                btn.style.color = 'var(--text-light)';
                btn.style.border = '1px solid var(--border-light)';
            });

            if (tab === 'meineVideos') {
                document.getElementById('tabMeineVideos').style.background = 'linear-gradient(135deg, #007AFF, #00C7BE)';
                document.getElementById('tabMeineVideos').style.color = 'white';
                document.getElementById('tabMeineVideos').style.border = 'none';
            } else if (tab === 'upload') {
                document.getElementById('tabUpload').style.background = 'linear-gradient(135deg, #007AFF, #00C7BE)';
                document.getElementById('tabUpload').style.color = 'white';
                document.getElementById('tabUpload').style.border = 'none';
            } else if (tab === 'shared') {
                document.getElementById('tabShared').style.background = 'linear-gradient(135deg, #007AFF, #00C7BE)';
                document.getElementById('tabShared').style.color = 'white';
                document.getElementById('tabShared').style.border = 'none';
            }

            // Update content
            document.getElementById('tabContentMeineVideos').style.display = tab === 'meineVideos' ? 'block' : 'none';
            document.getElementById('tabContentUpload').style.display = tab === 'upload' ? 'block' : 'none';
            document.getElementById('tabContentShared').style.display = tab === 'shared' ? 'block' : 'none';

            // Load data
            if (tab === 'meineVideos') loadTeamVideos();
            if (tab === 'shared') loadSharedClips();
        }

        // Videos vom Server laden
        async function loadTeamVideos() {
            try {
                const response = await fetch('/api/videos', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Fehler beim Laden');
                const data = await response.json();
                teamVideos = data.videos || [];
                renderVideoList();
            } catch (error) {
                console.error('Fehler beim Laden der Videos:', error);
                showToast('Fehler beim Laden der Videos', 'error');
            }
        }

        // Video-Liste rendern
        function renderVideoList() {
            const emptyEl = document.getElementById('videoListEmpty');
            const gridEl = document.getElementById('videoListGrid');

            if (teamVideos.length === 0) {
                emptyEl.style.display = 'block';
                gridEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            gridEl.style.display = 'grid';

            gridEl.innerHTML = teamVideos.map(video => `
                    <div class="video-card" style="background: var(--card-light); border: 1px solid var(--border-light); border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onclick="openVideoPlayer(${video.id})" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                        <div style="height: 140px; background: var(--video-thumb-bg, linear-gradient(135deg, #e8e8ed, #d1d1d6)); display: flex; align-items: center; justify-content: center; position: relative;">
                            <span style="font-size: 48px; opacity: 0.5;">🎬</span>
                            <span style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-family: monospace;">
                                ${formatDuration(video.duration)}
                            </span>
                        </div>
                        <div style="padding: 12px;">
                            <h4 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-light);">${escapeHtml(video.title)}</h4>
                            <p style="margin: 0; font-size: 12px; opacity: 0.6; color: var(--text-light);">${formatFileSize(video.file_size)} • ${new Date(video.created_at).toLocaleDateString('de-DE')}</p>
                            ${video.clip_count > 0 ? `<span style="display: inline-block; margin-top: 8px; padding: 2px 8px; background: #10b98122; color: #10b981; border-radius: 4px; font-size: 11px;">${video.clip_count} Clips</span>` : ''}
                        </div>
                    </div>
                `).join('');
        }

        // Video-Player öffnen
        async function openVideoPlayer(videoId) {
            currentVideoId = videoId;
            clipStart = null;
            clipEnd = null;
            videoDrawMode = false;
            updateClipUI();

            const video = teamVideos.find(v => v.id === videoId);
            if (!video) return;

            document.getElementById('playerVideoTitle').textContent = video.title;

            const modalVideo = document.getElementById('modalVideo');
            modalVideo.src = `/api/videos/${videoId}/stream`;

            // Canvas Setup nach Video-Load
            modalVideo.onloadedmetadata = function () {
                setupVideoDrawCanvas();
            };

            document.getElementById('videoPlayerModal').style.display = 'flex';

            // Clips und Marker für dieses Video laden
            await loadVideoClips(videoId);
            await loadVideoMarkers(videoId);
        }

        // Video-Player schließen
        function closeVideoPlayer() {
            // Zuerst Fullscreen beenden falls aktiv
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            const modalVideo = document.getElementById('modalVideo');
            modalVideo.pause();
            modalVideo.src = '';
            document.getElementById('videoPlayerModal').style.display = 'none';
            currentVideoId = null;
            videoDrawMode = false;
            clearVideoDrawing();
        }

        // =====================
        // VIDEO FULLSCREEN (mit Zeichnen-Support)
        // =====================
        let isVideoFullscreen = false;

        function toggleVideoFullscreen() {
            const modal = document.getElementById('videoPlayerModal');
            const container = document.getElementById('videoPlayerContainer');
            const sidebar = document.getElementById('videoSidebar');
            const btn = document.getElementById('fullscreenBtn');

            if (!document.fullscreenElement) {
                // Fullscreen aktivieren - nur der Container (Video + Toolbar + Clip-Bar)
                container.requestFullscreen().then(() => {
                    isVideoFullscreen = true;
                    btn.innerHTML = '✕';
                    btn.style.background = 'rgba(16,185,129,0.9)';
                    // Container nimmt jetzt ganzen Bildschirm ein
                    container.style.right = '0';
                    // Sidebar verstecken (ist außerhalb des Containers)
                    if (sidebar) sidebar.style.display = 'none';
                    // Canvas neu einrichten
                    setTimeout(() => setupVideoDrawCanvas(), 150);
                }).catch(err => {
                    console.error('Fullscreen error:', err);
                });
            } else {
                // Fullscreen beenden
                document.exitFullscreen().then(() => {
                    isVideoFullscreen = false;
                    btn.innerHTML = '⛶';
                    btn.style.background = 'rgba(0,0,0,0.6)';
                    // Container wieder Platz für Sidebar lassen
                    container.style.right = '280px';
                    // Sidebar wieder zeigen
                    if (sidebar) sidebar.style.display = 'flex';
                    // Canvas neu einrichten
                    setTimeout(() => setupVideoDrawCanvas(), 150);
                });
            }
        }

        // Fullscreen-Änderungen überwachen (z.B. ESC-Taste)
        document.addEventListener('fullscreenchange', () => {
            const container = document.getElementById('videoPlayerContainer');
            const sidebar = document.getElementById('videoSidebar');
            const btn = document.getElementById('fullscreenBtn');

            if (!document.fullscreenElement && isVideoFullscreen) {
                isVideoFullscreen = false;
                if (btn) {
                    btn.innerHTML = '⛶';
                    btn.style.background = 'rgba(0,0,0,0.6)';
                }
                // Container wieder Platz für Sidebar lassen
                if (container) {
                    container.style.right = '280px';
                }
                // Sidebar wieder zeigen
                if (sidebar) {
                    sidebar.style.display = 'flex';
                }
                setTimeout(() => setupVideoDrawCanvas(), 150);
            }
        });

        // =====================
        // VIDEO DRAWING
        // =====================
        let videoDrawMode = false;
        let videoDrawing = false;
        let videoDrawCtx = null;
        let videoStrokes = [];  // Array für Striche mit Timestamps
        let videoFadeMode = true;  // Auto-Fade standardmäßig AN
        let videoFadeAnimationRunning = false;
        let currentVideoStroke = null;

        function setupVideoDrawCanvas() {
            const video = document.getElementById('modalVideo');
            const canvas = document.getElementById('modalDrawCanvas');
            const wrapper = document.getElementById('videoWrapper');

            if (!video || !canvas || !wrapper) return;

            // Warte bis Video Dimensionen hat
            const videoRect = video.getBoundingClientRect();
            const wrapperRect = wrapper.getBoundingClientRect();

            // Canvas genau über Video positionieren
            const videoWidth = video.clientWidth;
            const videoHeight = video.clientHeight;

            // Berechne Video-Position innerhalb des Wrappers
            const videoLeft = (wrapperRect.width - videoWidth) / 2;
            const videoTop = (wrapperRect.height - videoHeight) / 2;

            canvas.width = videoWidth;
            canvas.height = videoHeight;
            canvas.style.width = videoWidth + 'px';
            canvas.style.height = videoHeight + 'px';
            canvas.style.left = videoLeft + 'px';
            canvas.style.top = videoTop + 'px';
            canvas.style.position = 'absolute';

            videoDrawCtx = canvas.getContext('2d');
            videoDrawCtx.strokeStyle = '#ff0000';
            videoDrawCtx.lineWidth = 3;
            videoDrawCtx.lineCap = 'round';
            videoDrawCtx.lineJoin = 'round';

            // Event-Listener nur einmal hinzufügen
            if (!canvas.hasAttribute('data-initialized')) {
                canvas.setAttribute('data-initialized', 'true');

                canvas.addEventListener('mousedown', startVideoDraw);
                canvas.addEventListener('mousemove', doVideoDraw);
                canvas.addEventListener('mouseup', stopVideoDraw);
                canvas.addEventListener('mouseleave', stopVideoDraw);

                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    startVideoDraw({ offsetX: touch.clientX - canvas.getBoundingClientRect().left, offsetY: touch.clientY - canvas.getBoundingClientRect().top });
                });
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    doVideoDraw({ offsetX: touch.clientX - canvas.getBoundingClientRect().left, offsetY: touch.clientY - canvas.getBoundingClientRect().top });
                });
                canvas.addEventListener('touchend', stopVideoDraw);
            }
        }

        function toggleDrawMode() {
            videoDrawMode = !videoDrawMode;
            const canvas = document.getElementById('modalDrawCanvas');
            const btn = document.getElementById('drawModeBtn');

            if (videoDrawMode) {
                canvas.style.pointerEvents = 'auto';
                canvas.style.cursor = 'crosshair';
                btn.style.background = 'rgba(16,185,129,0.9)';
                btn.title = 'Zeichnen (AN)';
            } else {
                canvas.style.pointerEvents = 'none';
                canvas.style.cursor = 'default';
                btn.style.background = 'rgba(0,0,0,0.6)';
                btn.title = 'Zeichnen';
            }
        }

        function startVideoDraw(e) {
            if (!videoDrawMode || !videoDrawCtx) return;
            videoDrawing = true;
            currentVideoStroke = {
                points: [{ x: e.offsetX, y: e.offsetY }],
                timestamp: Date.now(),
                opacity: 1
            };
        }

        function doVideoDraw(e) {
            if (!videoDrawing || !videoDrawCtx || !currentVideoStroke) return;
            currentVideoStroke.points.push({ x: e.offsetX, y: e.offsetY });
            // Zeichne live
            redrawVideoStrokes();
        }

        function stopVideoDraw() {
            if (videoDrawing && currentVideoStroke && currentVideoStroke.points.length > 1) {
                videoStrokes.push(currentVideoStroke);
                if (videoFadeMode) {
                    startVideoFadeAnimation();
                }
            }
            videoDrawing = false;
            currentVideoStroke = null;
        }

        function redrawVideoStrokes() {
            const canvas = document.getElementById('modalDrawCanvas');
            if (!canvas || !videoDrawCtx) return;

            videoDrawCtx.clearRect(0, 0, canvas.width, canvas.height);

            // Zeichne alle gespeicherten Striche
            videoStrokes.forEach(stroke => {
                if (stroke.points.length < 2) return;

                videoDrawCtx.beginPath();
                videoDrawCtx.strokeStyle = `rgba(255, 0, 0, ${stroke.opacity})`;
                videoDrawCtx.lineWidth = 3;
                videoDrawCtx.lineCap = 'round';
                videoDrawCtx.lineJoin = 'round';

                videoDrawCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
                for (let i = 1; i < stroke.points.length; i++) {
                    videoDrawCtx.lineTo(stroke.points[i].x, stroke.points[i].y);
                }
                videoDrawCtx.stroke();
            });

            // Zeichne aktuellen Strich
            if (currentVideoStroke && currentVideoStroke.points.length >= 2) {
                videoDrawCtx.beginPath();
                videoDrawCtx.strokeStyle = 'rgba(255, 0, 0, 1)';
                videoDrawCtx.lineWidth = 3;
                videoDrawCtx.lineCap = 'round';
                videoDrawCtx.lineJoin = 'round';

                videoDrawCtx.moveTo(currentVideoStroke.points[0].x, currentVideoStroke.points[0].y);
                for (let i = 1; i < currentVideoStroke.points.length; i++) {
                    videoDrawCtx.lineTo(currentVideoStroke.points[i].x, currentVideoStroke.points[i].y);
                }
                videoDrawCtx.stroke();
            }
        }

        function startVideoFadeAnimation() {
            if (videoFadeAnimationRunning) return;
            videoFadeAnimationRunning = true;

            function animate() {
                const now = Date.now();
                let hasActiveStrokes = false;

                videoStrokes = videoStrokes.filter(stroke => {
                    const age = now - stroke.timestamp;
                    if (age < 3000) {
                        // Noch sichtbar (3 Sekunden)
                        stroke.opacity = 1;
                        hasActiveStrokes = true;
                        return true;
                    } else if (age < 4000) {
                        // Fade out (1 Sekunde)
                        stroke.opacity = 1 - ((age - 3000) / 1000);
                        hasActiveStrokes = true;
                        return true;
                    } else {
                        // Komplett verblasst
                        return false;
                    }
                });

                redrawVideoStrokes();

                if (hasActiveStrokes) {
                    requestAnimationFrame(animate);
                } else {
                    videoFadeAnimationRunning = false;
                }
            }

            requestAnimationFrame(animate);
        }

        function toggleVideoFadeMode() {
            videoFadeMode = !videoFadeMode;
            const btn = document.getElementById('fadeModeBtn');

            if (videoFadeMode) {
                btn.style.background = 'rgba(139,92,246,0.9)';  // Lila wenn AN
                btn.title = 'Auto-Fade (AN)';
                // Starte Animation für existierende Striche
                if (videoStrokes.length > 0) {
                    startVideoFadeAnimation();
                }
            } else {
                btn.style.background = 'rgba(0,0,0,0.6)';
                btn.title = 'Auto-Fade (AUS)';
                // Setze alle Striche auf volle Opacity
                videoStrokes.forEach(s => s.opacity = 1);
                redrawVideoStrokes();
            }
        }

        function clearVideoDrawing() {
            const canvas = document.getElementById('modalDrawCanvas');
            if (canvas && videoDrawCtx) {
                videoDrawCtx.clearRect(0, 0, canvas.width, canvas.height);
            }
            videoStrokes = [];
            currentVideoStroke = null;
        }

        // Video löschen
        async function deleteCurrentVideo() {
            if (!currentVideoId) return;

            if (!confirm('Video wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                return;
            }

            try {
                const response = await fetch(`/api/videos/${currentVideoId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Fehler beim Löschen');

                showToast('Video gelöscht!', 'success');
                closeVideoPlayer();
                loadTeamVideos(); // Videos neu laden
            } catch (error) {
                console.error('Fehler:', error);
                showToast('Fehler beim Löschen des Videos', 'error');
            }
        }

        // Clip-Start setzen
        function setClipStart() {
            const video = document.getElementById('modalVideo');
            clipStart = video.currentTime;
            document.getElementById('clipStartTime').textContent = formatTime(clipStart);
            updateClipUI();
        }

        // Clip-Ende setzen
        function setClipEnd() {
            const video = document.getElementById('modalVideo');
            clipEnd = video.currentTime;
            document.getElementById('clipEndTime').textContent = formatTime(clipEnd);
            updateClipUI();
        }

        // Clip-UI aktualisieren
        function updateClipUI() {
            const saveBtn = document.getElementById('saveClipBtn');
            if (clipStart !== null && clipEnd !== null && clipEnd > clipStart) {
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            } else {
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
            document.getElementById('clipStartTime').textContent = clipStart !== null ? formatTime(clipStart) : '--:--';
            document.getElementById('clipEndTime').textContent = clipEnd !== null ? formatTime(clipEnd) : '--:--';
        }

        // Clip speichern
        async function saveVideoClip() {
            if (!currentVideoId || clipStart === null || clipEnd === null) return;

            const note = document.getElementById('clipNote').value;

            try {
                const response = await fetch(`/api/videos/${currentVideoId}/clips`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        start_time: Math.round(clipStart),
                        end_time: Math.round(clipEnd),
                        note: note,
                        title: note || `Clip ${formatTime(clipStart)} - ${formatTime(clipEnd)}`
                    })
                });

                if (!response.ok) throw new Error('Fehler beim Speichern');

                showToast('Clip gespeichert!', 'success');
                clipStart = null;
                clipEnd = null;
                document.getElementById('clipNote').value = '';
                updateClipUI();
                loadVideoClips(currentVideoId);
            } catch (error) {
                console.error('Fehler:', error);
                showToast('Fehler beim Speichern des Clips', 'error');
            }
        }

        // Clips für Video laden
        async function loadVideoClips(videoId) {
            try {
                const response = await fetch(`/api/videos/${videoId}/clips`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Fehler');
                const data = await response.json();
                const clips = data.clips || data || [];
                renderVideoClips(clips);
                document.getElementById('clipCount').textContent = clips.length;
            } catch (error) {
                console.error('Fehler beim Laden der Clips:', error);
            }
        }

        // =====================
        // VIDEO MARKERS
        // =====================

        // Marker hinzufügen
        async function addVideoMarker() {
            if (!currentVideoId) return;

            const video = document.getElementById('modalVideo');
            const currentTime = video.currentTime;

            // Optionales Label per Prompt
            const label = prompt('Marker-Beschreibung (optional):', '');

            try {
                const response = await fetch(`/api/videos/${currentVideoId}/markers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        time_seconds: currentTime,
                        label: label || '',
                        color: '#f59e0b'
                    })
                });

                if (!response.ok) throw new Error('Fehler beim Speichern');

                showToast('Marker gesetzt!', 'success');
                loadVideoMarkers(currentVideoId);
            } catch (error) {
                console.error('Fehler:', error);
                showToast('Fehler beim Speichern des Markers', 'error');
            }
        }

        // Marker laden
        async function loadVideoMarkers(videoId) {
            try {
                const response = await fetch(`/api/videos/${videoId}/markers`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Fehler');
                const data = await response.json();
                const markers = data.markers || [];
                renderVideoMarkers(markers);
                document.getElementById('markerCount').textContent = markers.length;
            } catch (error) {
                console.error('Fehler beim Laden der Marker:', error);
            }
        }

        // Marker rendern
        function renderVideoMarkers(markers) {
            const container = document.getElementById('videoMarkersList');
            if (!Array.isArray(markers) || markers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); opacity: 0.4; font-size: 12px; text-align: center; padding: 8px;">Keine Marker</p>';
                return;
            }

            container.innerHTML = markers.map(marker => `
                <div onclick="jumpToMarker(${marker.time_seconds})" 
                     style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.3); border-radius: 6px; cursor: pointer; margin-bottom: 6px; transition: background 0.2s;"
                     onmouseover="this.style.background='rgba(245,158,11,0.25)'" 
                     onmouseout="this.style.background='rgba(245,158,11,0.15)'">
                    <span style="font-family: monospace; color: #f59e0b; font-size: 13px; font-weight: 600;">${formatTime(marker.time_seconds)}</span>
                    <span style="flex: 1; font-size: 12px; color: var(--text-light); opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(marker.label) || 'Marker'}</span>
                    <button onclick="event.stopPropagation(); deleteMarker(${marker.id})" 
                            style="background: none; border: none; color: var(--text-light); opacity: 0.4; cursor: pointer; font-size: 14px; padding: 2px 6px;"
                            title="Löschen">✕</button>
                </div>
            `).join('');
        }

        // Zu Marker springen
        function jumpToMarker(timeSeconds) {
            const video = document.getElementById('modalVideo');
            video.currentTime = timeSeconds;
            video.play();
        }

        // Marker löschen
        async function deleteMarker(markerId) {
            if (!confirm('Marker löschen?')) return;

            try {
                const response = await fetch(`/api/markers/${markerId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Fehler');

                showToast('Marker gelöscht', 'success');
                loadVideoMarkers(currentVideoId);
            } catch (error) {
                console.error('Fehler:', error);
                showToast('Fehler beim Löschen', 'error');
            }
        }

        // Clips rendern
        function renderVideoClips(clips) {
            const container = document.getElementById('videoClipsList');
            document.getElementById('clipCount').textContent = clips.length;

            if (!Array.isArray(clips) || clips.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light); opacity: 0.5; font-size: 12px;">Keine Clips</div>';
                return;
            }

            container.innerHTML = clips.map(clip => `
                    <div style="background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <div style="cursor: pointer; flex: 1;" onclick="jumpToClip(${clip.start_time})">
                                <span style="font-family: monospace; font-size: 12px; color: #10b981;">${formatTime(clip.start_time)}</span>
                                <span style="opacity: 0.5; color: var(--text-light); font-size: 10px;"> → </span>
                                <span style="font-family: monospace; font-size: 12px; color: #ef4444;">${formatTime(clip.end_time)}</span>
                            </div>
                            <button onclick="openShareModal(${clip.id})" title="Teilen" style="width: 28px; height: 28px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                📤
                            </button>
                            <button onclick="deleteClip(${clip.id})" title="Löschen" style="width: 28px; height: 28px; background: rgba(220,38,38,0.2); color: #ef4444; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                🗑️
                            </button>
                        </div>
                        <div style="font-size: 11px; color: var(--text-light); opacity: 0.7; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(clip.note || 'Kein Kommentar')}</div>
                    </div>
                `).join('');
        }

        // Clip löschen
        async function deleteClip(clipId) {
            if (!confirm('Clip wirklich löschen?')) return;

            try {
                const response = await fetch(`/api/clips/${clipId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Clip gelöscht', 'success');
                    if (currentVideoId) {
                        await loadVideoClips(currentVideoId);
                    }
                } else {
                    showToast('Fehler beim Löschen', 'error');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showToast('Fehler beim Löschen', 'error');
            }
        }

        // Zum Clip springen
        function jumpToClip(startTime) {
            const video = document.getElementById('modalVideo');
            video.currentTime = startTime;
            video.play();
        }

        // Share Modal öffnen
        async function openShareModal(clipId) {
            currentClipToShare = clipId;
            selectedPlayersForShare = [];

            // Team-Mitglieder laden
            try {
                const response = await fetch('/api/team', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Fehler');
                const players = await response.json();

                const container = document.getElementById('sharePlayersList');
                container.innerHTML = players.map(player => `
                        <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #2c2c2e; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" value="${player.id}" onchange="togglePlayerSelection(${player.id})" style="width: 18px; height: 18px; accent-color: #007AFF;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #007AFF, #00C7BE); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                ${(player.vorname || '?')[0]}${(player.nachname || '?')[0]}
                            </div>
                            <div>
                                <div style="font-weight: 500; color: white;">${escapeHtml(player.vorname)} ${escapeHtml(player.nachname)}</div>
                                <div style="font-size: 12px; opacity: 0.6; color: white;">${escapeHtml(player.position || 'Spieler')}</div>
                            </div>
                        </label>
                    `).join('');

                document.getElementById('shareClipModal').style.display = 'flex';
            } catch (error) {
                console.error('Fehler:', error);
                showToast('Fehler beim Laden des Teams', 'error');
            }
        }

        // Player für Share auswählen/abwählen
        function togglePlayerSelection(playerId) {
            if (selectedPlayersForShare.includes(playerId)) {
                selectedPlayersForShare = selectedPlayersForShare.filter(id => id !== playerId);
            } else {
                selectedPlayersForShare.push(playerId);
            }
        }

        // Clips an Spieler senden
        async function sendClipToPlayers() {
            if (!currentClipToShare || selectedPlayersForShare.length === 0) {
                showToast('Bitte wähle mindestens einen Spieler aus', 'error');
                return;
            }

            const message = document.getElementById('shareMessage').value;

            try {
                for (const playerId of selectedPlayersForShare) {
                    await fetch(`/api/clips/${currentClipToShare}/share`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            recipient_id: playerId,
                            message: message
                        })
                    });
                }

                showToast(`Clip an ${selectedPlayersForShare.length} Spieler gesendet!`, 'success');
                closeShareModal();
            } catch (error) {
                console.error('Fehler:', error);
                showToast('Fehler beim Teilen', 'error');
            }
        }

        // Share Modal schließen
        function closeShareModal() {
            document.getElementById('shareClipModal').style.display = 'none';
            document.getElementById('shareMessage').value = '';
            currentClipToShare = null;
            selectedPlayersForShare = [];
        }

        // Geteilte Clips laden
        async function loadSharedClips() {
            try {
                const response = await fetch('/api/shared-clips', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Fehler');
                const data = await response.json();
                sharedClips = data.shared_clips || [];
                renderSharedClips();
                updateSharedClipsBadge();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        // Geteilte Clips rendern
        function renderSharedClips() {
            const emptyEl = document.getElementById('sharedClipsEmpty');
            const listEl = document.getElementById('sharedClipsList');

            if (sharedClips.length === 0) {
                emptyEl.style.display = 'block';
                listEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            listEl.style.display = 'flex';

            listEl.innerHTML = sharedClips.map(share => `
                    <div style="background: var(--card-light); border: 1px solid ${share.is_viewed ? 'var(--border-light)' : '#007AFF'}; border-radius: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0 0 4px 0; display: flex; align-items: center; gap: 8px;">
                                    ${!share.is_viewed ? '<span style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%; display: inline-block;"></span>' : ''}
                                    ${escapeHtml(share.video?.title || share.clip?.title || 'Video')}
                                </h4>
                                <p style="margin: 0; font-size: 12px; opacity: 0.6;">Von ${escapeHtml(share.sender || 'Unbekannt')} • ${new Date(share.shared_at).toLocaleDateString('de-DE')}</p>
                            </div>
                            <span style="font-family: monospace; font-size: 13px; padding: 4px 8px; background: var(--bg-light); border-radius: 4px;">
                                ${formatTime(share.clip?.start_time || 0)} - ${formatTime(share.clip?.end_time || 0)}
                            </span>
                        </div>
                        ${share.message ? `<p style="margin: 0 0 12px 0; padding: 8px; background: var(--bg-light); border-radius: 8px; font-size: 13px; font-style: italic;">"${escapeHtml(share.message)}"</p>` : ''}
                        ${share.clip?.note ? `<p style="margin: 0 0 12px 0; font-size: 13px; opacity: 0.8;">📝 ${escapeHtml(share.clip.note)}</p>` : ''}
                        <button onclick="watchSharedClip(${share.share_id}, ${share.video?.id || 0}, ${share.clip?.start_time || 0})" style="padding: 10px 20px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            ▶ Clip ansehen
                        </button>
                    </div>
                `).join('');
        }

        // Badge für ungelesene Clips aktualisieren
        function updateSharedClipsBadge() {
            const unviewedCount = sharedClips.filter(c => !c.is_viewed).length;
            const badge = document.getElementById('sharedClipsBadge');
            if (unviewedCount > 0) {
                badge.textContent = unviewedCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Geteilten Clip ansehen
        async function watchSharedClip(shareId, videoId, startTime) {
            // Als gesehen markieren
            try {
                await fetch(`/api/shared-clips/${shareId}/viewed`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (e) { }

            // Video laden und abspielen
            currentVideoId = videoId;

            const share = sharedClips.find(s => s.id === shareId);
            document.getElementById('playerVideoTitle').textContent = share?.video_title || 'Video';
            document.getElementById('playerVideoDescription').textContent = share?.message || '';

            const modalVideo = document.getElementById('modalVideo');
            modalVideo.src = `/api/videos/${videoId}/stream`;

            document.getElementById('videoPlayerModal').style.display = 'flex';

            // Zum Clip springen wenn Video geladen
            modalVideo.onloadedmetadata = () => {
                modalVideo.currentTime = startTime;
                modalVideo.play();
            };

            // Liste neu laden
            loadSharedClips();
        }

        // Hilfsfunktion: Sekunden in Zeit formatieren
        function formatTime(seconds) {
            if (seconds === null || seconds === undefined) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Hilfsfunktion: Duration formatieren
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (hours > 0) {
                return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Hilfsfunktion: Dateigröße formatieren
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`;
        }

        // Upload: File auswählen
        document.getElementById('videoInput')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Prüfen ob Datei zu groß (500MB Limit)
            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('Datei zu groß! Maximal 500MB erlaubt.', 'error');
                return;
            }

            selectedFile = file;
            selectedFileDuration = 0;

            // Thumbnail erstellen und Dauer ermitteln
            const thumbnailVideo = document.getElementById('thumbnailVideo');
            thumbnailVideo.src = URL.createObjectURL(file);

            // Video-Dauer ermitteln wenn Metadaten geladen
            thumbnailVideo.onloadedmetadata = function () {
                selectedFileDuration = thumbnailVideo.duration || 0;
                console.log('Video duration:', selectedFileDuration);
            };

            // Details anzeigen
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
            document.getElementById('videoTitle').value = file.name.replace(/\.[^/.]+$/, '');
            document.getElementById('uploadDetails').style.display = 'block';
        });

        // Upload: Auswahl löschen
        function clearVideoSelection() {
            selectedFile = null;
            document.getElementById('videoInput').value = '';
            document.getElementById('uploadDetails').style.display = 'none';
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoDescription').value = '';
            const thumbnailVideo = document.getElementById('thumbnailVideo');
            if (thumbnailVideo.src) {
                URL.revokeObjectURL(thumbnailVideo.src);
                thumbnailVideo.src = '';
            }
        }

        // Upload: Video hochladen
        async function startVideoUpload() {
            if (!selectedFile) return;

            const title = document.getElementById('videoTitle').value.trim();
            if (!title) {
                showToast('Bitte gib einen Titel ein', 'error');
                return;
            }

            const description = document.getElementById('videoDescription').value.trim();

            // UI für Upload-Progress
            document.getElementById('startUploadBtn').disabled = true;
            document.getElementById('uploadProgress').style.display = 'block';

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', title);
            formData.append('description', description);
            formData.append('duration', Math.round(selectedFileDuration));

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('uploadProgressBar').style.width = percent + '%';
                        document.getElementById('uploadPercent').textContent = percent + '%';
                        document.getElementById('uploadStatus').textContent = percent < 100 ? 'Hochladen...' : 'Verarbeiten...';
                    }
                };

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        showToast('Video erfolgreich hochgeladen!', 'success');
                        clearVideoSelection();
                        document.getElementById('uploadProgress').style.display = 'none';
                        document.getElementById('startUploadBtn').disabled = false;
                        switchVideoTab('meineVideos');
                    } else {
                        throw new Error(xhr.responseText);
                    }
                };

                xhr.onerror = function () {
                    showToast('Fehler beim Upload', 'error');
                    document.getElementById('uploadProgress').style.display = 'none';
                    document.getElementById('startUploadBtn').disabled = false;
                };

                xhr.open('POST', '/api/videos/upload');
                xhr.withCredentials = true;
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                showToast('Fehler beim Upload', 'error');
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('startUploadBtn').disabled = false;
            }
        }

        // Drag & Drop für Upload-Area
        const dropZone = document.getElementById('videoDropZone');
        if (dropZone) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#007AFF';
                dropZone.style.background = 'rgba(0, 122, 255, 0.1)';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border-light)';
                dropZone.style.background = 'transparent';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border-light)';
                dropZone.style.background = 'transparent';

                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    const input = document.getElementById('videoInput');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }

        // OLD widgetTemplates removed - keeping only the one below

        // Widget Templates - Widgets für jede App
        const widgetTemplates = {
            // KADER WIDGET
            kader: () => `
                <div class="widget-header">👥 Kader</div>
                <div class="widget-content" id="widget-kader-content">
                    <div class="widget-stat">
                        <span class="widget-stat-label"><span class="status-dot fit"></span>Fit</span>
                        <span class="widget-stat-value widget-kader-fit">-</span>
                    </div>
                    <div class="widget-stat">
                        <span class="widget-stat-label"><span class="status-dot training"></span>Training</span>
                        <span class="widget-stat-value widget-kader-training">-</span>
                    </div>
                    <div class="widget-stat">
                        <span class="widget-stat-label"><span class="status-dot reha"></span>Reha</span>
                        <span class="widget-stat-value widget-kader-reha">-</span>
                    </div>
                    <div class="widget-stat">
                        <span class="widget-stat-label"><span class="status-dot ausfall"></span>Ausfall</span>
                        <span class="widget-stat-value widget-kader-ausfall">-</span>
                    </div>
                </div>
            `,
            // KALENDER WIDGET
            kalender: () => `
                <div class="widget-header">📅 Kalender</div>
                <div class="widget-content">
                    <div class="widget-week-grid" id="widget-kalender-grid">
                        <div class="widget-week-day"><span class="widget-day-label">Mo</span><span class="widget-day-dot"></span></div>
                        <div class="widget-week-day"><span class="widget-day-label">Di</span><span class="widget-day-dot"></span></div>
                        <div class="widget-week-day"><span class="widget-day-label">Mi</span><span class="widget-day-dot"></span></div>
                        <div class="widget-week-day"><span class="widget-day-label">Do</span><span class="widget-day-dot"></span></div>
                        <div class="widget-week-day"><span class="widget-day-label">Fr</span><span class="widget-day-dot"></span></div>
                        <div class="widget-week-day"><span class="widget-day-label">Sa</span><span class="widget-day-dot"></span></div>
                        <div class="widget-week-day"><span class="widget-day-label">So</span><span class="widget-day-dot"></span></div>
                    </div>
                </div>
            `,
            // MESSENGER WIDGET
            messenger: () => `
                <div class="widget-header">💬 Messenger</div>
                <div class="widget-content" id="widget-messenger-content">
                    <span style="opacity: 0.6; font-size: 12px;">Keine neuen Nachrichten</span>
                </div>
            `,
            // ANALYSE WIDGET (Premium)
            analyse: () => `
                <div class="widget-header">📈 Analyse <span style="background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 6px; font-size: 10px; margin-left: 6px;">💎</span></div>
                <div class="widget-content">
                    <span style="opacity: 0.6; font-size: 12px;">Noch keine Analyse vorhanden</span>
                </div>
            `,
            // TRAINING WIDGET
            training: () => `
                <div class="widget-header">🏋️ Training</div>
                <div class="widget-content" id="widget-training-content">
                    <span style="opacity: 0.6; font-size: 12px;">Kein Training geplant</span>
                </div>
            `,
            // MEDIZIN WIDGET
            medizin: () => `
                <div class="widget-header">⚕️ Medizin</div>
                <div class="widget-content">
                    <div class="widget-stat">
                        <span class="widget-stat-label">Verletzt</span>
                        <span class="widget-stat-value widget-medizin-injured">-</span>
                    </div>
                </div>
            `,
            // FINANZEN WIDGET
            finanzen: () => `
                <div class="widget-header">💰 Finanzen</div>
                <div class="widget-content" id="widget-finanzen-content">
                    <span style="opacity: 0.6; font-size: 12px;">Keine Finanzdaten</span>
                </div>
            `,
            // VIDEO WIDGET
            video: () => `
                <div class="widget-header">🎬 Video</div>
                <div class="widget-content" id="widget-video-content">
                    <span style="opacity: 0.6; font-size: 12px;">Keine Videos</span>
                </div>
            `,
            // KASSE WIDGET
            kasse: () => `
                <div class="widget-header">💵 Kasse</div>
                <div class="widget-content">
                    <div class="widget-stat">
                        <span class="widget-stat-label">Kontostand</span>
                        <span class="widget-stat-value widget-kasse-balance">0 €</span>
                    </div>
                </div>
            `,
            // TAKTIK WIDGET
            taktik: () => `
                <div class="widget-header">⚽ Taktik</div>
                <div class="widget-content">
                    <span style="opacity: 0.6; font-size: 12px;">Taktik-Tafel öffnen</span>
                </div>
            `,
            // UPLOAD WIDGET
            upload: () => `
                <div class="widget-header">📹 Videos</div>
                <div class="widget-content" id="widget-upload-content">
                    <span style="opacity: 0.6; font-size: 12px;">Keine Videos hochgeladen</span>
                </div>
            `,
            // QUICK LINKS WIDGET
            quick_links: () => `
                <div class="widget-header">🔗 Schnellzugriffe</div>
                <div class="widget-content" style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <span onclick="switchApp('kader')" style="cursor: pointer; padding: 4px 8px; background: rgba(16,185,129,0.1); border-radius: 6px; font-size: 12px;">👥 Kader</span>
                    <span onclick="switchApp('kalender')" style="cursor: pointer; padding: 4px 8px; background: rgba(59,130,246,0.1); border-radius: 6px; font-size: 12px;">📅 Kalender</span>
                    <span onclick="switchApp('taktik')" style="cursor: pointer; padding: 4px 8px; background: rgba(245,158,11,0.1); border-radius: 6px; font-size: 12px;">⚽ Taktik</span>
                </div>
            `,
            // STATS WIDGET
            stats: () => `
                <div class="widget-header">📊 Statistiken</div>
                <div class="widget-content">
                    <div class="widget-stat">
                        <span class="widget-stat-label">Spieler</span>
                        <span class="widget-stat-value widget-stats-players">-</span>
                    </div>
                    <div class="widget-stat">
                        <span class="widget-stat-label">Events</span>
                        <span class="widget-stat-value widget-stats-events">-</span>
                    </div>
                    <div class="widget-stat">
                        <span class="widget-stat-label">Videos</span>
                        <span class="widget-stat-value widget-stats-videos">-</span>
                    </div>
                </div>
            `,
            // UPCOMING WIDGET
            upcoming: () => `
                <div class="widget-header">📅 Nächste Spiele</div>
                <div class="widget-content" id="widget-upcoming-content">
                    <span style="opacity: 0.6; font-size: 12px;">Keine Spiele geplant</span>
                </div>
            `
        };

        // Widget code consolidated

        function openWidgetModal() {
            document.getElementById('widgetModal').classList.add('active');
        }

        function closeWidgetModal() {
            document.getElementById('widgetModal').classList.remove('active');
        }

        function addWidget(widgetType) {
            const grid = document.getElementById('appGrid');
            const widgetId = `widget-${++widgetCounter}`;

            const widget = document.createElement('div');
            widget.className = 'widget-container';
            widget.draggable = true;
            widget.id = widgetId;
            widget.dataset.widgetType = widgetType;

            // App-ID für Navigation zuweisen (falls Widget einer App entspricht)
            const appWidgets = ['kader', 'kalender', 'messenger', 'analyse', 'training', 'medizin', 'finanzen', 'kasse', 'taktik', 'upload', 'scouting'];
            if (appWidgets.includes(widgetType)) {
                widget.dataset.appId = widgetType;
            }

            const content = widgetTemplates[widgetType]?.() || 'Widget';
            let headerText = '';
            try {
                headerText = content.split('</div>')[0].split('>')[1] || '';
            } catch (e) {
                headerText = '';
            }
            let restContent = '';
            try {
                restContent = content.split('</div>')[1] ? content.substring(content.indexOf('</div>') + 6) : '';
            } catch (e) {
                restContent = '';
            }
            widget.innerHTML = `
                <div class="widget-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="flex: 1;">${headerText}</span>
                    <span class="widget-delete" onclick="event.stopPropagation(); deleteWidget('${widgetId}')">✕</span>
                </div>
                ${restContent}
            `;

            // Widget klickbar machen für Navigation zur App
            if (widget.dataset.appId) {
                widget.addEventListener('click', (e) => {
                    // Nicht navigieren wenn auf Delete geklickt wird
                    if (e.target.classList.contains('widget-delete')) return;
                    // Nicht navigieren beim Drag
                    if (widget.classList.contains('dragging')) return;
                    switchApp(widget.dataset.appId);
                });
            }

            // Zufällige Position auf dem Grid
            const gridSize = 60;
            const randomCol = Math.floor(Math.random() * 6) * gridSize;
            const randomRow = Math.floor(Math.random() * 4) * gridSize;

            widget.style.left = randomCol + 'px';
            widget.style.top = randomRow + 'px';

            grid.appendChild(widget);
            saveAppPositions();
            updateWidgetData(widgetType); // Daten sofort laden
            closeWidgetModal();
        }

        // Widget-Daten aktualisieren
        async function updateWidgetData(widgetType) {
            try {
                switch (widgetType) {
                    case 'kader':
                    case 'medizin':
                    case 'stats':
                        await updateKaderWidgets();
                        break;
                    case 'kalender':
                    case 'upcoming':
                        await updateKalenderWidgets();
                        break;
                    case 'messenger':
                        await updateMessengerWidgets();
                        break;
                    case 'kasse':
                        updateKasseWidgets();
                        break;
                    case 'upload':
                        updateUploadWidgets();
                        break;
                }
            } catch (error) {
                console.error('Fehler beim Laden der Widget-Daten:', error);
            }
        }

        // Kader Widget Daten
        async function updateKaderWidgets() {
            try {
                const response = await fetch('/api/players/stats');
                if (!response.ok) return;
                const data = await response.json();

                // Kader Widget
                document.querySelectorAll('.widget-kader-fit').forEach(el => el.textContent = data.fit || 0);
                document.querySelectorAll('.widget-kader-limited').forEach(el => el.textContent = data.belastet || 0);
                document.querySelectorAll('.widget-kader-injured').forEach(el => el.textContent = data.verletzt || 0);

                // Medizin Widget
                document.querySelectorAll('.widget-medizin-injured').forEach(el => el.textContent = data.verletzt || 0);
                document.querySelectorAll('.widget-medizin-limited').forEach(el => el.textContent = data.belastet || 0);

                // Stats Widget
                const totalPlayers = (data.fit || 0) + (data.belastet || 0) + (data.verletzt || 0);
                document.querySelectorAll('.widget-stats-players').forEach(el => el.textContent = totalPlayers);
            } catch (e) {
                console.error('Fehler beim Laden der Kader-Widget-Daten:', e);
            }
        }

        // Kalender Widget Daten
        function updateKalenderWidgets() {
            try {
                // Events aus localStorage laden (wie die App)
                const storageKey = getUserStorageKey('calendarEvents');
                const allEvents = JSON.parse(localStorage.getItem(storageKey) || '[]');

                // Nach Woche gruppieren
                const today = new Date();
                const dayOfWeek = today.getDay();
                const monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

                const weekEvents = {};
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(monday);
                    currentDay.setDate(monday.getDate() + i);
                    const dateStr = currentDay.toISOString().split('T')[0];
                    weekEvents[i] = allEvents.filter(e => e.date === dateStr);
                }

                // Kalender Widget aktualisieren
                document.querySelectorAll('.widget-week-grid').forEach(grid => {
                    const days = grid.querySelectorAll('.widget-week-day');
                    days.forEach((dayEl, index) => {
                        const dot = dayEl.querySelector('.widget-day-dot');
                        if (dot) {
                            const events = weekEvents[index] || [];
                            dot.classList.remove('has-event', 'has-match');
                            if (events.length > 0) {
                                const hasMatch = events.some(e => e.type === 'match' || e.type === 'spiel');
                                dot.classList.add(hasMatch ? 'has-match' : 'has-event');
                            }
                        }
                    });
                });

                // Nächste Events Widget aktualisieren
                const upcomingContent = document.querySelectorAll('#widget-upcoming-content');
                const futureEvents = allEvents
                    .filter(e => new Date(e.date) >= today)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 2);

                upcomingContent.forEach(container => {
                    if (futureEvents.length > 0) {
                        container.innerHTML = futureEvents.map(e => {
                            const eventDate = new Date(e.date);
                            const dateStr = eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                            const type = e.type || 'event';
                            const typeIcon = type === 'match' || type === 'spiel' ? '⚽' : type === 'training' ? '🏋️' : '📅';
                            return `<div style="margin-bottom: 8px; font-size: 12px;">
                                    <span>${typeIcon}</span> <strong>${e.title || 'Event'}</strong>
                                    <div style="opacity: 0.6; font-size: 11px;">${dateStr}</div>
                                </div>`;
                        }).join('');
                    } else {
                        container.innerHTML = '<span style="opacity: 0.6; font-size: 12px;">Keine Events geplant</span>';
                    }
                });

                // Stats Widget - Events zählen
                document.querySelectorAll('.widget-stats-events').forEach(el => el.textContent = allEvents.length);
            } catch (e) {
                console.error('Fehler beim Laden der Kalender-Widget-Daten:', e);
            }
        }

        // Messenger Widget Daten
        function updateMessengerWidgets() {
            try {
                // Nachrichten aus localStorage laden (wie die App)
                const storageKey = getUserStorageKey('messengerMessages');
                const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');

                document.querySelectorAll('#widget-messenger-content').forEach(container => {
                    if (messages.length > 0) {
                        const lastMessage = messages[messages.length - 1]; // Neueste am Ende
                        const time = new Date(lastMessage.timestamp || Date.now()).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        const sender = lastMessage.sender || 'Unbekannt';
                        const text = lastMessage.text || '';
                        container.innerHTML = `
                                <div style="font-size: 12px;">
                                    <strong>${escapeHtml(sender)}</strong>
                                    <div style="opacity: 0.7; font-size: 11px; margin-top: 2px;">${escapeHtml(text.substring(0, 30))}${text.length > 30 ? '...' : ''}</div>
                                    <div style="opacity: 0.5; font-size: 10px; margin-top: 4px;">${time}</div>
                                </div>
                            `;
                    } else {
                        container.innerHTML = '<span style="opacity: 0.6; font-size: 12px;">Keine Nachrichten</span>';
                    }
                });
            } catch (e) {
                console.error('Fehler beim Laden der Messenger-Widget-Daten:', e);
            }
        }

        // Mannschaftskasse Widget Daten
        function updateKasseWidgets() {
            try {
                // Kasse aus localStorage laden (wie die App)
                const storageKey = getUserStorageKey('kasseTransactions');
                const transactions = JSON.parse(localStorage.getItem(storageKey) || '[]');

                let totalIncome = 0;
                let totalExpense = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        totalIncome += t.amount;
                    } else {
                        totalExpense += t.amount;
                    }
                });
                const saldo = totalIncome - totalExpense;

                // Widget aktualisieren
                document.querySelectorAll('.widget-kasse-balance').forEach(el => {
                    el.textContent = saldo.toFixed(2) + ' €';
                    el.style.color = saldo >= 0 ? '#22c55e' : '#ef4444';
                });
            } catch (e) {
                console.error('Fehler beim Laden der Kasse-Widget-Daten:', e);
            }
        }

        // Video Upload Widget Daten
        async function updateUploadWidgets() {
            try {
                // Videos aus API laden
                const response = await fetch('/api/videos');
                let videos = [];

                if (response.ok) {
                    const data = await response.json();
                    videos = data.videos || [];
                } else {
                    // Fallback auf localStorage
                    const storageKey = getUserStorageKey('uploadedVideos');
                    videos = JSON.parse(localStorage.getItem(storageKey) || '[]');
                }

                // Upload Widget Content aktualisieren
                document.querySelectorAll('#widget-upload-content').forEach(container => {
                    if (videos.length > 0) {
                        container.innerHTML = `
                            <div style="font-size: 12px;">
                                <strong>${videos.length}</strong> Video${videos.length !== 1 ? 's' : ''} hochgeladen
                            </div>
                        `;
                    } else {
                        container.innerHTML = '<span style="opacity: 0.6; font-size: 12px;">Keine Videos hochgeladen</span>';
                    }
                });

                // Stats Widget
                document.querySelectorAll('.widget-stats-videos').forEach(el => {
                    el.textContent = videos.length;
                });
            } catch (e) {
                console.error('Fehler beim Laden der Upload-Widget-Daten:', e);
            }
        }

        // Alle Widget-Daten beim Start laden
        async function updateAllWidgetData() {
            await updateKaderWidgets();
            updateKalenderWidgets();
            updateMessengerWidgets();
            updateKasseWidgets();
            await updateUploadWidgets();
        }

        function deleteWidget(widgetId) {
            document.getElementById(widgetId).remove();
            saveAppPositions();
        }

        function saveAppPositions() {
            const grid = document.getElementById('appGrid');
            const positions = {};

            grid.querySelectorAll('.widget-container, .app-card').forEach(item => {
                const id = item.id || item.dataset.app;
                positions[id] = {
                    left: item.style.left,
                    top: item.style.top,
                    type: item.classList.contains('widget-container') ? 'widget' : 'app',
                    widgetType: item.dataset.widgetType
                };
            });

            localStorage.setItem('appPositions', JSON.stringify(positions));
        }

        // ============================================
        // Dashboard Stats - Echtzeitdaten von API
        // ============================================

        async function renderDashboardStats() {
            console.log('Dashboard Stats werden geladen...');

            // Load Kader stats from API
            await loadKaderStats();

            // Kalender preview - Events der Woche
            await loadKalenderPreview();

            // Messenger preview - Letzte Nachrichten
            await loadMessengerPreview();

            console.log('Dashboard Stats geladen');
        }

        async function loadKaderStats() {
            try {
                console.log('Lade Kader Stats...');
                const response = await fetch('/api/players/stats');
                console.log('Kader Stats Response:', response.status);
                if (!response.ok) return;

                const data = await response.json();
                console.log('Kader Stats Daten:', data);

                // Widgets aktualisieren - neue Status
                document.querySelectorAll('.widget-kader-fit').forEach(el => el.textContent = data.fit || '0');
                document.querySelectorAll('.widget-kader-training').forEach(el => el.textContent = data.training || '0');
                document.querySelectorAll('.widget-kader-reha').forEach(el => el.textContent = data.reha || '0');
                document.querySelectorAll('.widget-kader-ausfall').forEach(el => el.textContent = data.ausfall || '0');

                // Total für andere Widgets
                const total = (data.fit || 0) + (data.training || 0) + (data.reha || 0) + (data.ausfall || 0);
                document.querySelectorAll('.widget-stats-players').forEach(el => el.textContent = total);

                // Medizin stats (Reha + Ausfall)
                document.querySelectorAll('.widget-medizin-injured').forEach(el => el.textContent = (data.reha || 0) + (data.ausfall || 0));
            } catch (e) {
                console.error('Fehler beim Laden der Kader-Stats:', e);
            }
        }

        async function loadKalenderPreview() {
            const grid = document.getElementById('kalenderPreviewGrid');
            if (!grid) return;

            // Versuche zuerst die API, dann localStorage
            let weekEvents = {};

            try {
                const response = await fetch('/api/events/week');
                if (response.ok) {
                    const data = await response.json();
                    weekEvents = data.week || {};
                }
            } catch (e) {
                console.log('API nicht verfügbar, nutze localStorage');
            }

            // Fallback: localStorage Events (benutzerspezifisch)
            const storageKey = getUserStorageKey('calendarEvents');
            const storedEvents = JSON.parse(localStorage.getItem(storageKey) || '[]');
            if (storedEvents.length > 0) {
                // Berechne aktuelle Woche
                const today = new Date();
                const dayOfWeek = today.getDay();
                const monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

                // Gruppiere Events nach Wochentag
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(monday);
                    currentDay.setDate(monday.getDate() + i);
                    const dateStr = currentDay.toISOString().split('T')[0];

                    const dayEvents = storedEvents.filter(e => e.date === dateStr);
                    if (dayEvents.length > 0) {
                        weekEvents[i] = dayEvents.map(e => ({
                            event_type: e.type || 'other',
                            title: e.title
                        }));
                    }
                }
            }

            const today = new Date();
            const dayOfWeek = today.getDay();
            const todayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Mo=0, So=6

            const weekDays = grid.querySelectorAll('.week-day');
            weekDays.forEach((dayEl, index) => {
                // Mark today
                if (index === todayIndex) {
                    dayEl.classList.add('today');
                } else {
                    dayEl.classList.remove('today');
                }

                // Add events
                const eventsContainer = dayEl.querySelector('.week-day-events');
                if (eventsContainer) {
                    eventsContainer.innerHTML = '';
                    const dayEvents = weekEvents[index] || [];
                    dayEvents.slice(0, 2).forEach(event => {
                        const dot = document.createElement('div');
                        dot.className = 'event-dot';
                        if (event.event_type === 'training') dot.classList.add('training');
                        else if (event.event_type === 'match') dot.classList.add('match');
                        eventsContainer.appendChild(dot);
                    });
                }
            });
        }

        async function loadMessengerPreview() {
            const container = document.getElementById('messengerPreview');
            if (!container) return;

            try {
                const response = await fetch('/api/messages/unread');
                if (!response.ok) return;

                const data = await response.json();
                const unreadCount = data.count || 0;

                if (unreadCount > 0) {
                    container.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="background: #ff3b30; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600;">${unreadCount}</span>
                                <span>Neue Nachrichten</span>
                            </div>
                        `;
                } else {
                    container.innerHTML = '<span class="dashboard-placeholder">Keine neuen Nachrichten</span>';
                }
            } catch (e) {
                console.error('Fehler beim Laden der Messenger-Preview:', e);
            }
        }

        async function loadTaktikPreview() {
            const taktikCount = document.getElementById('taktikFormationCount');
            if (!taktikCount) return;

            try {
                const response = await fetch('/api/formations');
                if (!response.ok) return;

                const data = await response.json();
                taktikCount.textContent = (data.formations || []).length || '0';
            } catch (e) {
                console.error('Fehler beim Laden der Taktik-Preview:', e);
            }
        }

        // ============================================
        // PROFIL - Persönliches Profil Funktionen
        // ============================================

        async function loadProfilData() {
            try {
                // Persönliche Daten laden
                const profileResponse = await fetch('/api/profile');
                if (profileResponse.ok) {
                    const profile = await profileResponse.json();
                    document.getElementById('profilEmail').value = profile.email || '';
                    document.getElementById('profilVorname').value = profile.vorname || '';
                    document.getElementById('profilNachname').value = profile.nachname || '';
                    document.getElementById('profilTelefon').value = profile.telefon || '';
                    document.getElementById('profilGeburtsdatum').value = profile.geburtsdatum || '';
                    document.getElementById('profilGroesse').value = profile.groesse || '';
                    document.getElementById('profilPosition').value = profile.position || '';
                    document.getElementById('profilStarkerFuss').value = profile.starker_fuss || '';
                    document.getElementById('profilWerdegang').value = profile.werdegang || '';

                    // Avatar mit Initialen
                    const initials = (profile.vorname?.charAt(0) || '') + (profile.nachname?.charAt(0) || '');
                    if (initials) {
                        document.getElementById('profilAvatar').textContent = initials.toUpperCase();
                    }
                }

                // Team-Info laden
                const teamResponse = await fetch('/api/team/info');
                const teamInfoDiv = document.getElementById('profilTeamInfo');

                if (teamResponse.ok) {
                    const team = await teamResponse.json();

                    if (team.has_team) {
                        teamInfoDiv.innerHTML = `
                                <div class="profil-team-badge">
                                    <span style="font-size: 24px;">⚽</span>
                                    <div>
                                        <div style="font-weight: 600;">${escapeHtml(team.verein || team.team_name || 'Team')}</div>
                                        <div style="font-size: 12px; opacity: 0.7;">${escapeHtml(team.mannschaft || '')}</div>
                                    </div>
                                </div>
                                <div style="margin-top: 16px; font-size: 14px;">
                                    <div style="margin-bottom: 8px;"><strong>Rolle:</strong> ${escapeHtml(team.role_name || 'Mitglied')}</div>
                                    ${team.is_admin ? '<div style="color: #22c55e;">✓ Team-Administrator</div>' : ''}
                                </div>
                            `;

                        // Kader-Eintrag laden wenn Spieler
                        await loadProfilKaderEntry();
                    } else {
                        teamInfoDiv.innerHTML = `
                                <div style="text-align: center; padding: 20px;">
                                    <div style="font-size: 40px; margin-bottom: 12px;">🏟️</div>
                                    <p style="margin-bottom: 16px;">Du bist noch keinem Team beigetreten.</p>
                                    <button onclick="switchApp('home')" 
                                        style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                        Team erstellen
                                    </button>
                                </div>
                            `;
                    }
                }
            } catch (e) {
                console.error('Fehler beim Laden der Profildaten:', e);
            }
        }

        async function loadProfilKaderEntry() {
            try {
                const response = await fetch('/api/profile/kader');
                const kaderCard = document.getElementById('profilKaderCard');
                const kaderInfo = document.getElementById('profilKaderInfo');

                // Null-Check - Element existiert möglicherweise nicht
                if (!kaderCard || !kaderInfo) {
                    return;
                }

                if (response.ok) {
                    const data = await response.json();

                    if (data.player) {
                        kaderCard.style.display = 'block';
                        const p = data.player;

                        kaderInfo.innerHTML = `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                                    <div>
                                        <span style="opacity: 0.7;">Name:</span>
                                        <div style="font-weight: 600;">${escapeHtml(p.name || '-')}</div>
                                    </div>
                                    <div>
                                        <span style="opacity: 0.7;">Trikotnummer:</span>
                                        <div style="font-weight: 600;">${p.trikotnummer !== null ? '#' + p.trikotnummer : '-'}</div>
                                    </div>
                                    <div>
                                        <span style="opacity: 0.7;">Position:</span>
                                        <div style="font-weight: 600;">${escapeHtml(p.position || '-')}</div>
                                    </div>
                                    <div>
                                        <span style="opacity: 0.7;">Status:</span>
                                        <div style="font-weight: 600; color: ${getStatusColor(p.status)};">${escapeHtml(p.status || 'Fit')}</div>
                                    </div>
                                </div>
                            `;
                    } else {
                        kaderCard.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Fehler beim Laden des Kader-Eintrags:', e);
            }
        }

        function getStatusColor(status) {
            const colors = {
                'Fit': '#22c55e',
                'Belastet': '#f59e0b',
                'Angeschlagen': '#f97316',
                'Verletzt': '#ef4444',
                'Reha': '#06b6d4',
                'Ausfall': '#dc2626'
            };
            return colors[status] || '#6b7280';
        }

        async function saveProfile() {
            // Rollenbasiertes Speichern
            const rolle = (window.currentUserRolle || '').toLowerCase();

            const getVal = (id1, id2) => {
                const el1 = document.getElementById(id1);
                const el2 = document.getElementById(id2);
                return (el1?.value?.trim() || el2?.value?.trim() || '');
            };

            // Basis-Daten (für alle Rollen)
            const data = {
                vorname: getVal('profilVorname', 'profileVorname'),
                nachname: getVal('profilNachname', 'profileNachname'),
                telefon: document.getElementById('profilTelefon')?.value?.trim() || '',
                geburtsdatum: document.getElementById('profilGeburtsdatum')?.value || '',
                werdegang: document.getElementById('profilWerdegang')?.value?.trim() || '',
            };

            // Rollen-Checks - case-insensitive
            const rolleLower = rolle.toLowerCase();
            const isAdmin = rolleLower === 'admin';

            // Admin kann wählen, welches Profil er bearbeitet
            let effektiveRolle = rolleLower;
            if (isAdmin) {
                const gewaehlterTyp = window.currentProfilTyp || localStorage.getItem('profilTyp') || 'trainer';
                effektiveRolle = gewaehlterTyp;
            }

            const isSpieler = effektiveRolle === 'spieler';
            const isTrainer = ['trainer', 'co-trainer'].includes(effektiveRolle) || (isAdmin && effektiveRolle === 'trainer');

            // Spieler-spezifische Felder
            if (isSpieler) {
                data.groesse = document.getElementById('profilGroesse')?.value || '';
                data.gewicht = document.getElementById('profilGewicht')?.value || '';
                data.position = document.getElementById('profilPosition')?.value || '';
                data.nebenpositionen = document.getElementById('profilNebenpositionen')?.value?.trim() || '';
                data.starker_fuss = document.getElementById('profilStarkerFuss')?.value || '';
                data.jahrgang = document.getElementById('profilJahrgang')?.value || '';
            }

            // Trainer-spezifische Felder
            if (isTrainer) {
                data.spielsystem = document.getElementById('profilSpielsystem')?.value || '';
                data.taktische_grundidee = document.getElementById('profilTaktischeGrundidee')?.value?.trim() || '';
                data.trainingsschwerpunkte = document.getElementById('profilTrainingsschwerpunkte')?.value?.trim() || '';
                data.bisherige_stationen = document.getElementById('profilBisherigeStationen')?.value?.trim() || '';
                data.lizenzen = document.getElementById('profilLizenzen')?.value?.trim() || '';
            }

            try {
                const response = await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast('Profil erfolgreich gespeichert!', 'success');
                    // Avatar aktualisieren
                    const initials = (data.vorname?.charAt(0) || '') + (data.nachname?.charAt(0) || '');
                    if (initials && document.getElementById('profilAvatar')) {
                        document.getElementById('profilAvatar').textContent = initials.toUpperCase();
                    }
                    // Einstellungen-Seite auch aktualisieren
                    if (document.getElementById('profileVorname')) {
                        document.getElementById('profileVorname').value = data.vorname;
                        document.getElementById('profileNachname').value = data.nachname;
                    }
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Fehler beim Speichern', 'error');
                }
            } catch (e) {
                console.error('Fehler beim Speichern des Profils:', e);
                showToast('Verbindungsfehler', 'error');
            }
        }

        async function confirmDeleteAccount() {
            if (confirm('Bist du sicher, dass du deinen Account löschen möchtest? Diese Aktion kann nicht rückgängig gemacht werden!')) {
                if (confirm('LETZTE WARNUNG: Alle deine Daten werden unwiderruflich gelöscht. Fortfahren?')) {
                    try {
                        const response = await fetch('/api/account/delete', {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            window.location.href = '/login';
                        } else {
                            showToast('Fehler beim Löschen des Accounts', 'error');
                        }
                    } catch (e) {
                        showToast('Verbindungsfehler', 'error');
                    }
                }
            }
        }

        // ============================================
        // Kader - Spieler von API laden
        // ============================================

        async function loadPlayersFromAPI() {
            try {
                const response = await fetch('/api/players');
                if (!response.ok) return [];

                const data = await response.json();
                return data.players || [];
            } catch (e) {
                console.error('Fehler beim Laden der Spieler:', e);
                return [];
            }
        }

        async function savePlayerToAPI(player) {
            try {
                const response = await fetch('/api/players', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(player)
                });
                return response.ok;
            } catch (e) {
                console.error('Fehler beim Speichern des Spielers:', e);
                return false;
            }
        }

        async function updatePlayerAPI(playerId, updates) {
            try {
                const response = await fetch(`/api/players/${playerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                return response.ok;
            } catch (e) {
                console.error('Fehler beim Aktualisieren des Spielers:', e);
                return false;
            }
        }

        async function deletePlayerAPI(playerId) {
            try {
                const response = await fetch(`/api/players/${playerId}`, {
                    method: 'DELETE'
                });
                return response.ok;
            } catch (e) {
                console.error('Fehler beim Löschen des Spielers:', e);
                return false;
            }
        }

        // ============================================
        // Kalender - Events von API laden
        // ============================================

        async function loadEventsFromAPI() {
            try {
                const response = await fetch('/api/events');
                if (!response.ok) return [];

                const data = await response.json();
                return data.events || [];
            } catch (e) {
                console.error('Fehler beim Laden der Events:', e);
                return [];
            }
        }

        async function saveEventToAPI(event) {
            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(event)
                });
                return response.ok;
            } catch (e) {
                console.error('Fehler beim Speichern des Events:', e);
                return false;
            }
        }

        async function deleteEventAPI(eventId) {
            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE'
                });
                return response.ok;
            } catch (e) {
                console.error('Fehler beim Löschen des Events:', e);
                return false;
            }
        }

        // ============================================
        // Messenger - Nachrichten von API
        // ============================================

        async function loadMessagesFromAPI() {
            try {
                const response = await fetch('/api/messages');
                if (!response.ok) return [];

                const data = await response.json();
                return data.messages || [];
            } catch (e) {
                console.error('Fehler beim Laden der Nachrichten:', e);
                return [];
            }
        }

        async function sendMessageToAPI(content, recipientId = null) {
            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, recipient_id: recipientId })
                });
                return response.ok;
            } catch (e) {
                console.error('Fehler beim Senden der Nachricht:', e);
                return false;
            }
        }

        // Auto-Refresh Dashboard Stats alle 30 Sekunden
        setInterval(() => {
            const dashboardView = document.getElementById('dashboard');
            if (dashboardView && dashboardView.classList.contains('active')) {
                renderDashboardStats();
            }
        }, 30000);

        // Legacy-Funktionen für Kompatibilität
        function loadKalenderPreviewLegacy() {
            const grid = document.getElementById('kalenderPreviewGrid');
            if (!grid) return;

            const storageKey = getUserStorageKey('calendarEvents');
            const events = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

            const weekDays = grid.querySelectorAll('.week-day');
            weekDays.forEach((dayEl, index) => {
                const currentDay = new Date(monday);
                currentDay.setDate(monday.getDate() + index);
                const dateStr = currentDay.toISOString().split('T')[0];
                const todayStr = today.toISOString().split('T')[0];

                // Mark today
                if (dateStr === todayStr) {
                    dayEl.classList.add('today');
                } else {
                    dayEl.classList.remove('today');
                }

                // Add events
                const eventsContainer = dayEl.querySelector('.week-day-events');
                if (eventsContainer) {
                    eventsContainer.innerHTML = '';
                    const dayEvents = events.filter(e => e.date === dateStr);
                    dayEvents.slice(0, 2).forEach(event => {
                        const dot = document.createElement('div');
                        dot.className = 'event-dot';
                        if (event.type === 'training') dot.classList.add('training');
                        else if (event.type === 'match') dot.classList.add('match');
                        eventsContainer.appendChild(dot);
                    });
                }
            });
        }

        function loadMessengerPreview() {
            const container = document.getElementById('messengerPreview');
            if (!container) return;

            const messages = JSON.parse(localStorage.getItem('messengerMessages') || '[]');
            if (messages.length === 0) {
                container.innerHTML = '<span class="dashboard-placeholder">Keine neuen Nachrichten</span>';
                return;
            }

            const lastMsg = messages[messages.length - 1];
            const initials = (lastMsg.sender || 'UN').substring(0, 2).toUpperCase();
            const timeAgo = getTimeAgo(lastMsg.timestamp);

            container.innerHTML = `
                    <div class="message-preview">
                        <div class="message-avatar">${initials}</div>
                        <div class="message-content">
                            <div class="message-sender">${lastMsg.sender || 'Unbekannt'}</div>
                            <div class="message-text">${lastMsg.text || ''}</div>
                        </div>
                        <span class="message-time">${timeAgo}</span>
                    </div>
                `;
        }

        function loadAnalysePreview() {
            const container = document.getElementById('analysePreview');
            if (!container) return;

            const analyses = JSON.parse(localStorage.getItem('analyses') || '[]');
            if (analyses.length === 0) {
                container.innerHTML = '<span class="dashboard-placeholder">Noch keine Analyse vorhanden</span>';
                return;
            }

            const lastAnalysis = analyses[analyses.length - 1];
            const date = new Date(lastAnalysis.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            container.innerHTML = `
                    <div class="dashboard-card-stat">${analyses.length}</div>
                    <div class="dashboard-card-label">Letzte: ${date}</div>
                `;
        }

        function loadTrainingPreview() {
            const container = document.getElementById('trainingPreview');
            if (!container) return;

            const trainings = JSON.parse(localStorage.getItem('trainingSessions') || '[]');
            const now = new Date();
            const upcoming = trainings.filter(t => new Date(t.date) >= now).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcoming.length === 0) {
                container.innerHTML = '<span class="dashboard-placeholder">Kein Training geplant</span>';
                return;
            }

            const next = upcoming[0];
            const date = new Date(next.date).toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            container.innerHTML = `
                    <div class="dashboard-card-stat">${date}</div>
                    <div class="dashboard-card-label">Nächstes Training</div>
                `;
        }

        function loadFinanzenPreview() {
            const container = document.getElementById('finanzenPreview');
            if (!container) return;

            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            if (transactions.length === 0) {
                container.innerHTML = '<span class="dashboard-placeholder">Keine Finanzdaten</span>';
                return;
            }

            const now = new Date();
            const thisMonth = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });

            let income = 0, expenses = 0;
            thisMonth.forEach(t => {
                if (t.amount > 0) income += t.amount;
                else expenses += Math.abs(t.amount);
            });

            container.innerHTML = `
                    <div class="dashboard-stat-row">
                        <div class="dashboard-stat-item">
                            <span class="dashboard-stat-value" style="color: #34c759;">+${income}€</span>
                            <span class="dashboard-stat-label">Einnahmen</span>
                        </div>
                        <div class="dashboard-stat-item">
                            <span class="dashboard-stat-value" style="color: #ff3b30;">-${expenses}€</span>
                            <span class="dashboard-stat-label">Ausgaben</span>
                        </div>
                    </div>
                `;
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Jetzt';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        // DEPRECATED: Alte App-Karten Funktionen (ersetzt durch App Store)
        function initializeApps() {
            // Ersetzt durch renderHomeGrid()
        }

        function restoreWidgets() {
            // Ersetzt durch renderHomeGrid()
        }

        // Drag and drop für Widgets
        // Store offset for smooth dragging
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        document.addEventListener('dragstart', (e) => {
            if (e.target.closest('.widget-container')) {
                const widget = e.target.closest('.widget-container');
                const rect = widget.getBoundingClientRect();
                const gridRect = document.getElementById('appGrid').getBoundingClientRect();

                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;

                widget.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            } else if (e.target.closest('.app-card')) {
                const card = e.target.closest('.app-card');
                const rect = card.getBoundingClientRect();
                const gridRect = document.getElementById('appGrid').getBoundingClientRect();

                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;

                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
        });

        document.addEventListener('dragend', (e) => {
            if (e.target.closest('.widget-container')) {
                e.target.closest('.widget-container').classList.remove('dragging');
            } else if (e.target.closest('.app-card')) {
                e.target.closest('.app-card').classList.remove('dragging');
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const widget = document.querySelector('.widget-container.dragging');
            const appCard = document.querySelector('.app-card.dragging');
            const dragged = widget || appCard;

            if (!dragged) return;

            const grid = document.getElementById('appGrid');
            const gridRect = grid.getBoundingClientRect();

            // Berechne Position mit Offset (wo der Cursor auf dem Element war)
            let newX = e.clientX - gridRect.left - dragOffsetX;
            let newY = e.clientY - gridRect.top - dragOffsetY;

            // Snap to 60px grid
            const gridSize = 60;
            newX = Math.round(newX / gridSize) * gridSize;
            newY = Math.round(newY / gridSize) * gridSize;

            // Boundary checking
            const maxX = gridRect.width - dragged.offsetWidth;
            const maxY = gridRect.height - dragged.offsetHeight;

            newX = Math.max(0, Math.min(newX, maxX));
            newY = Math.max(0, Math.min(newY, maxY));

            dragged.style.left = newX + 'px';
            dragged.style.top = newY + 'px';

            saveAppPositions();
        });

        // Modal schließen bei click außerhalb
        document.getElementById('widgetModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'widgetModal') {
                closeWidgetModal();
            }
        });

        // ALTE DRAG AND DROP CODE (gelöscht, nicht mehr nötig)

        // ========================
        // MANNSCHAFTSKASSE SYSTEM
        // ========================
        let kasseTransactions = [];

        function initializeKasse() {
            const storageKey = getUserStorageKey('kasseTransactions');
            const stored = localStorage.getItem(storageKey);
            if (stored) {
                kasseTransactions = JSON.parse(stored);
            }
            renderKasse();
        }

        function saveKasseToStorage() {
            const storageKey = getUserStorageKey('kasseTransactions');
            localStorage.setItem(storageKey, JSON.stringify(kasseTransactions));
        }

        function openKasseModal(type) {
            const modal = document.getElementById('kasseModalOverlay');
            const title = document.getElementById('kasseModalTitle');
            const typeInput = document.getElementById('kasseTransactionType');
            const saveBtn = document.getElementById('kasseModalSaveBtn');

            typeInput.value = type;

            if (type === 'income') {
                title.textContent = '➕ Neue Einnahme';
                saveBtn.style.background = '#10b981';
            } else {
                title.textContent = '➖ Neue Ausgabe';
                saveBtn.style.background = '#ef4444';
            }

            // Reset form
            document.getElementById('kasseAmount').value = '';
            document.getElementById('kasseDescription').value = '';
            document.getElementById('kasseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('kasseCategory').value = type === 'income' ? 'beitrag' : 'sonstiges';

            modal.style.display = 'flex';
        }

        function closeKasseModal() {
            document.getElementById('kasseModalOverlay').style.display = 'none';
        }

        function saveKasseTransaction() {
            const amount = parseFloat(document.getElementById('kasseAmount').value);
            const description = document.getElementById('kasseDescription').value.trim();
            const date = document.getElementById('kasseDate').value;
            const category = document.getElementById('kasseCategory').value;
            const type = document.getElementById('kasseTransactionType').value;

            if (!amount || amount <= 0) {
                alert('Bitte einen gültigen Betrag eingeben');
                return;
            }
            if (!description) {
                alert('Bitte eine Beschreibung eingeben');
                return;
            }

            kasseTransactions.push({
                id: Date.now(),
                type,
                amount,
                description,
                date: date || new Date().toISOString().split('T')[0],
                category,
                createdAt: new Date().toISOString()
            });

            // Nach Datum sortieren (neueste zuerst)
            kasseTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            saveKasseToStorage();
            closeKasseModal();
            renderKasse();
        }

        function deleteKasseTransaction(id) {
            if (confirm('Transaktion wirklich löschen?')) {
                kasseTransactions = kasseTransactions.filter(t => t.id !== id);
                saveKasseToStorage();
                renderKasse();
            }
        }

        function renderKasse() {
            // Berechne Summen
            let totalIncome = 0;
            let totalExpense = 0;

            kasseTransactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });

            const balance = totalIncome - totalExpense;

            // Update Anzeigen
            document.getElementById('kasseBalance').textContent = formatCurrency(balance);
            document.getElementById('kasseTotalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('kasseTotalExpense').textContent = formatCurrency(totalExpense);

            // Transaktionsliste rendern
            const list = document.getElementById('kasseTransactionsList');
            if (kasseTransactions.length === 0) {
                list.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 20px;">Noch keine Transaktionen</p>';
            } else {
                list.innerHTML = kasseTransactions.slice(0, 20).map(t => {
                    const isIncome = t.type === 'income';
                    const categoryEmoji = getCategoryEmoji(t.category);
                    const dateFormatted = new Date(t.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });

                    return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${isIncome ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 10px; border-left: 4px solid ${isIncome ? '#10b981' : '#ef4444'};">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 20px;">${categoryEmoji}</span>
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">${t.description}</div>
                                        <div style="font-size: 12px; opacity: 0.7;">${dateFormatted}</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-weight: 700; font-size: 16px; color: ${isIncome ? '#10b981' : '#ef4444'};">
                                        ${isIncome ? '+' : '-'}${formatCurrency(t.amount)}
                                    </span>
                                    <button onclick="deleteKasseTransaction(${t.id})" style="background: none; border: none; cursor: pointer; opacity: 0.5; font-size: 16px;" title="Löschen">🗑️</button>
                                </div>
                            </div>
                        `;
                }).join('');
            }

            // Chart rendern
            renderKasseChart();
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'beitrag': '💳',
                'spende': '🎁',
                'sponsor': '🤝',
                'ausruestung': '👕',
                'platzmiete': '🏟️',
                'transport': '🚌',
                'verpflegung': '🍕',
                'sonstiges': '📦'
            };
            return emojis[category] || '📦';
        }

        function renderKasseChart() {
            const canvas = document.getElementById('kasseChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;

            // Canvas Größe setzen
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (kasseTransactions.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Noch keine Daten für Diagramm', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Erstelle Zeitreihe über die letzten 6 Monate (oder ab erster Transaktion)
            const sortedByDate = [...kasseTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstDate = new Date(sortedByDate[0].date);
            const today = new Date();

            // Mindestens 6 Monate anzeigen, auch wenn weniger Daten vorhanden
            const startDate = new Date(Math.min(firstDate.getTime(), today.getTime() - 180 * 24 * 60 * 60 * 1000));
            startDate.setDate(1); // Start am Monatsbeginn

            // Erstelle monatliche Datenpunkte
            const monthlyData = [];
            let currentMonth = new Date(startDate);
            let runningBalance = 0;

            // Berechne Balance für jeden Monat
            while (currentMonth <= today) {
                const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
                const monthStr = currentMonth.toISOString().slice(0, 7); // YYYY-MM

                // Addiere alle Transaktionen bis zum Ende dieses Monats
                sortedByDate.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate <= monthEnd && !t._counted) {
                        if (t.type === 'income') {
                            runningBalance += t.amount;
                        } else {
                            runningBalance -= t.amount;
                        }
                        t._counted = true;
                    }
                });

                monthlyData.push({
                    month: monthStr,
                    label: currentMonth.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' }),
                    balance: runningBalance
                });

                // Nächster Monat
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }

            // Reset _counted flag
            sortedByDate.forEach(t => delete t._counted);

            // Wenn nur ein Monat, füge den Startpunkt (0) hinzu
            if (monthlyData.length === 1) {
                monthlyData.unshift({
                    month: 'start',
                    label: 'Start',
                    balance: 0
                });
            }

            const balances = monthlyData.map(d => d.balance);
            const labels = monthlyData.map(d => d.label);

            // Chart zeichnen
            const padding = { top: 20, right: 20, bottom: 40, left: 70 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;

            const minBalance = Math.min(0, ...balances);
            const maxBalance = Math.max(...balances, 100); // Mindestens 100€ anzeigen
            const range = maxBalance - minBalance || 100;

            // Hintergrund-Grid
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);

            // Horizontale Linien
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (i / 4) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(canvas.width - padding.right, y);
                ctx.stroke();
            }
            ctx.setLineDash([]);

            // Null-Linie (wenn im sichtbaren Bereich)
            if (minBalance < 0) {
                const zeroY = padding.top + chartHeight * (1 - (0 - minBalance) / range);
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(padding.left, zeroY);
                ctx.lineTo(canvas.width - padding.right, zeroY);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Linie zeichnen
            ctx.beginPath();
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            balances.forEach((balance, i) => {
                const x = padding.left + (i / (balances.length - 1)) * chartWidth;
                const y = padding.top + chartHeight * (1 - (balance - minBalance) / range);

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // Fläche unter der Linie
            const lastX = padding.left + chartWidth;
            const zeroY = padding.top + chartHeight * (1 - (0 - minBalance) / range);
            ctx.lineTo(lastX, zeroY);
            ctx.lineTo(padding.left, zeroY);
            ctx.closePath();
            const gradient = ctx.createLinearGradient(0, padding.top, 0, canvas.height - padding.bottom);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0.05)');
            ctx.fillStyle = gradient;
            ctx.fill();

            // Punkte zeichnen
            balances.forEach((balance, i) => {
                const x = padding.left + (i / (balances.length - 1)) * chartWidth;
                const y = padding.top + chartHeight * (1 - (balance - minBalance) / range);

                ctx.beginPath();
                ctx.fillStyle = balance >= 0 ? '#10b981' : '#ef4444';
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Y-Achsen Labels (Beträge)
            ctx.fillStyle = '#666';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(formatCurrency(maxBalance), padding.left - 8, padding.top + 5);
            ctx.fillText(formatCurrency((maxBalance + minBalance) / 2), padding.left - 8, padding.top + chartHeight / 2 + 4);
            ctx.fillText(formatCurrency(minBalance), padding.left - 8, canvas.height - padding.bottom + 5);

            // X-Achsen Labels (Monate)
            ctx.textAlign = 'center';
            ctx.fillStyle = '#666';
            ctx.font = '10px -apple-system, sans-serif';

            // Zeige max 6 Labels
            const step = Math.ceil(labels.length / 6);
            labels.forEach((label, i) => {
                if (i % step === 0 || i === labels.length - 1) {
                    const x = padding.left + (i / (labels.length - 1)) * chartWidth;
                    ctx.fillText(label, x, canvas.height - 10);
                }
            });
        }

        // ========================
        // CALENDAR SYSTEM
        // ========================
        let currentDate = new Date(2026, 0, 4); // 4. Januar 2026
        let calendarView = 'month';
        const calendarEvents = [];

        // Helper function to format date as YYYY-MM-DD in local timezone
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function initializeCalendar() {
            console.log('initializeCalendar aufgerufen');
            const storageKey = getUserStorageKey('calendarEvents');
            const stored = localStorage.getItem(storageKey);
            if (stored) {
                calendarEvents.length = 0;
                calendarEvents.push(...JSON.parse(stored));
            }
            console.log('Rufe renderCalendar auf...');
            renderCalendar();
            console.log('renderCalendar abgeschlossen');
        }

        function saveEventsToStorage() {
            const storageKey = getUserStorageKey('calendarEvents');
            localStorage.setItem(storageKey, JSON.stringify(calendarEvents));
        }

        function deleteEvent(eventIndex) {
            if (confirm('Event wirklich löschen?')) {
                calendarEvents.splice(eventIndex, 1);
                saveEventsToStorage();
                renderCalendar();
            }
        }

        function openEventModal(dateStr, time) {
            const modal = document.getElementById('eventModalOverlay');
            if (!modal) {
                console.error('Event modal not found');
                return;
            }

            // Entferne Edit-Index wenn neuer Event
            modal.dataset.editIndex = '';

            // Reset form
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = dateStr || '';
            document.getElementById('eventTime').value = time || '';
            document.getElementById('eventType').value = 'training';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventNotes').value = '';
            document.getElementById('eventVisibilityPrivate').checked = true;
            document.getElementById('eventVisibilityTeam').checked = false;
            updateVisibilityStyle();
            document.getElementById('eventModalTitle').textContent = 'Neues Event';

            modal.style.display = 'flex';
        }

        function updateVisibilityStyle() {
            const privateLabel = document.getElementById('visibilityPrivateLabel');
            const teamLabel = document.getElementById('visibilityTeamLabel');
            const privateChecked = document.getElementById('eventVisibilityPrivate')?.checked;

            if (privateLabel && teamLabel) {
                privateLabel.style.borderColor = privateChecked ? 'var(--primary-green)' : 'var(--border-light)';
                privateLabel.style.background = privateChecked ? 'rgba(52, 199, 89, 0.1)' : 'transparent';
                teamLabel.style.borderColor = !privateChecked ? 'var(--primary-green)' : 'var(--border-light)';
                teamLabel.style.background = !privateChecked ? 'rgba(52, 199, 89, 0.1)' : 'transparent';
            }
        }

        function closeEventModal() {
            const modal = document.getElementById('eventModalOverlay');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function setRsvp(eventIndex, status) {
            if (eventIndex < 0 || eventIndex >= calendarEvents.length) return;

            const event = calendarEvents[eventIndex];
            if (!event.rsvps) {
                event.rsvps = {};
            }

            const userKey = `user_${currentUserId}`;

            // Toggle: Wenn gleicher Status, entfernen
            if (event.rsvps[userKey] === status) {
                delete event.rsvps[userKey];
            } else {
                event.rsvps[userKey] = status;
            }

            saveEventsToStorage();
            renderCalendar();
        }

        function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const dateStr = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const type = document.getElementById('eventType').value;
            const location = document.getElementById('eventLocation').value.trim();
            const notes = document.getElementById('eventNotes').value.trim();
            const visibility = document.querySelector('input[name="eventVisibility"]:checked')?.value || 'private';

            if (!title) {
                alert('Bitte einen Titel eingeben');
                return;
            }
            if (!dateStr) {
                alert('Bitte ein Datum auswählen');
                return;
            }

            const modal = document.getElementById('eventModalOverlay');
            const editIndex = modal.dataset.editIndex;

            const eventData = {
                date: dateStr,
                title,
                type,
                time: time || '',
                location: location || '',
                notes: notes || '',
                visibility: visibility,
                rsvps: {}
            };

            if (editIndex !== '' && editIndex !== undefined && editIndex !== null) {
                // Bearbeiten - RSVPs beibehalten
                const idx = parseInt(editIndex);
                eventData.rsvps = calendarEvents[idx].rsvps || {};
                calendarEvents[idx] = eventData;
            } else {
                // Neuer Event
                calendarEvents.push(eventData);
            }

            saveEventsToStorage();
            closeEventModal();
            renderCalendar();
        }

        function editEvent(eventIndex) {
            const event = calendarEvents[eventIndex];
            if (!event) return;

            const modal = document.getElementById('eventModalOverlay');
            modal.dataset.editIndex = eventIndex;

            document.getElementById('eventTitle').value = event.title || '';
            document.getElementById('eventDate').value = event.date || '';
            document.getElementById('eventTime').value = event.time || '';
            document.getElementById('eventType').value = event.type || 'training';
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventNotes').value = event.notes || '';

            // Visibility setzen
            const visibility = event.visibility || 'private';
            document.getElementById('eventVisibilityPrivate').checked = (visibility === 'private');
            document.getElementById('eventVisibilityTeam').checked = (visibility === 'team');
            updateVisibilityStyle();

            document.getElementById('eventModalTitle').textContent = 'Event bearbeiten';

            modal.style.display = 'flex';
        }

        function renderDayView() {
            const dateStr = formatLocalDate(currentDate);
            const dayName = currentDate.toLocaleDateString('de-DE', { weekday: 'long' });
            const dayNum = currentDate.getDate();

            let html = '<div class="calendar-grid"><div class="day-view">';
            html += `<div class="day-header">${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${dayNum}. ${currentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })}</div>`;
            html += '<div class="timeline" id="timeline">';

            const dayEvents = calendarEvents.filter(e => e.date === dateStr);

            // Zuerst alle Time-Slots ohne Events
            for (let hour = 0; hour < 24; hour++) {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;

                html += `
                <div class="time-slot" data-hour="${hour}">
                    <div class="time-label">
                        <span>${timeStr}</span>
                        <button class="time-add-btn" onclick="openEventModal('${dateStr}', '${timeStr}')">+</button>
                    </div>
                    <div class="slot-content"></div>
                </div>`;
            }

            // Jetzt alle Events absolut positioniert ÜBER den Slots
            dayEvents.forEach(event => {
                const eventIndex = calendarEvents.findIndex(e => e.date === event.date && e.time === event.time && e.title === event.title);
                const duration = event.duration || 1;

                // Berechne Endzeit
                const [eventHours, eventMinutes] = event.time.split(':');
                const startMinutes = parseInt(eventHours) * 60 + parseInt(eventMinutes);
                const endMinutes = startMinutes + (duration * 60);
                const endHours = Math.floor(endMinutes / 60);
                const endMins = Math.round(endMinutes % 60);
                const endTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;

                // Berechne absolute Position (top = stunde * 80px)
                const topPx = parseInt(eventHours) * 80;
                const heightPx = duration * 80;

                // RSVP-Info für Team-Events
                const isTeamEvent = event.visibility === 'team';
                const rsvps = event.rsvps || {};
                const yesCount = Object.values(rsvps).filter(r => r === 'yes').length;
                const noCount = Object.values(rsvps).filter(r => r === 'no').length;
                const maybeCount = Object.values(rsvps).filter(r => r === 'maybe').length;
                const myRsvp = rsvps[`user_${currentUserId}`] || '';

                let rsvpHtml = '';
                if (isTeamEvent) {
                    rsvpHtml = `
                            <div class="event-rsvp-info" style="display: flex; gap: 8px; margin-top: 4px; font-size: 11px;">
                                <span style="color: #34c759;">✓ ${yesCount}</span>
                                <span style="color: #ff3b30;">✗ ${noCount}</span>
                                <span style="color: #ff9500;">? ${maybeCount}</span>
                            </div>
                            <div class="event-rsvp-buttons" style="display: flex; gap: 4px; margin-top: 6px;">
                                <button class="rsvp-btn ${myRsvp === 'yes' ? 'active' : ''}" 
                                        onclick="event.stopPropagation(); setRsvp(${eventIndex}, 'yes')"
                                        style="padding: 4px 8px; font-size: 11px; border: 1px solid #34c759; background: ${myRsvp === 'yes' ? '#34c759' : 'transparent'}; color: ${myRsvp === 'yes' ? 'white' : '#34c759'}; border-radius: 4px; cursor: pointer;">
                                    Zusage
                                </button>
                                <button class="rsvp-btn ${myRsvp === 'maybe' ? 'active' : ''}" 
                                        onclick="event.stopPropagation(); setRsvp(${eventIndex}, 'maybe')"
                                        style="padding: 4px 8px; font-size: 11px; border: 1px solid #ff9500; background: ${myRsvp === 'maybe' ? '#ff9500' : 'transparent'}; color: ${myRsvp === 'maybe' ? 'white' : '#ff9500'}; border-radius: 4px; cursor: pointer;">
                                    Vielleicht
                                </button>
                                <button class="rsvp-btn ${myRsvp === 'no' ? 'active' : ''}" 
                                        onclick="event.stopPropagation(); setRsvp(${eventIndex}, 'no')"
                                        style="padding: 4px 8px; font-size: 11px; border: 1px solid #ff3b30; background: ${myRsvp === 'no' ? '#ff3b30' : 'transparent'}; color: ${myRsvp === 'no' ? 'white' : '#ff3b30'}; border-radius: 4px; cursor: pointer;">
                                    Absage
                                </button>
                            </div>
                        `;
                }

                const visibilityIcon = isTeamEvent ? '👥' : '🔒';

                html += `
                <div class="timeline-event ${event.type}" 
                     data-event-index="${eventIndex}"
                     style="top: ${topPx}px; height: ${heightPx}px; ${isTeamEvent ? 'min-height: 120px;' : ''}">
                    <div class="event-time">${event.time} - ${endTime} ${visibilityIcon}</div>
                    <div class="event-name">${event.title}</div>
                    ${rsvpHtml}
                    <div class="event-actions">
                        <button class="event-btn event-edit-btn" data-event-index="${eventIndex}" title="Bearbeiten">✎</button>
                        <button class="event-btn event-delete-btn" data-event-index="${eventIndex}" title="Löschen">✕</button>
                    </div>
                    <div class="event-resize-handle"></div>
                </div>
                `;
            });

            html += '</div></div>';
            return html;
        }

        function renderWeekView() {
            const weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - (weekStart.getDay() === 0 ? 6 : weekStart.getDay() - 1));

            let html = '<div class="calendar-grid"><div class="week-view">';

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('de-DE', { weekday: 'short' });
                const dayNum = date.getDate();
                const hasEvent = calendarEvents.some(e => e.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                html += `
                <div class="week-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}" onclick="selectDate('${dateStr}')">
                    <div style="font-size: 12px; opacity: 0.7; font-weight: 600;">${dayName}</div>
                    <div style="font-size: 18px; font-weight: 600;">${dayNum}</div>
                    ${hasEvent ? '<div style="color: var(--primary-green); font-size: 10px; margin-top: 4px;">●●●</div>' : ''}
                    <button class="week-day-add-btn" onclick="event.stopPropagation(); openEventModal('${dateStr}', '10:00')">+</button>
                </div>
            `;
            }

            html += '</div></div>';
            return html;
        }

        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            let html = '<div class="calendar-grid"><div class="weekdays">';
            html += '<div class="weekday">Mo</div><div class="weekday">Di</div><div class="weekday">Mi</div>';
            html += '<div class="weekday">Do</div><div class="weekday">Fr</div><div class="weekday">Sa</div><div class="weekday">So</div>';
            html += '</div><div class="days">';

            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevLastDay.getDate() - i;
                html += `<div class="day other-month">${day}</div>`;
            }

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const date = new Date(year, month, i);
                const dateStr = formatLocalDate(date);
                const isToday = dateStr === formatLocalDate(new Date());
                const hasEvent = calendarEvents.some(e => e.date === dateStr);

                html += `
                <div class="day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}" onclick="selectDate('${dateStr}')">
                    ${i}
                    <div class="day-event-dot"></div>
                    <button class="day-add-btn" onclick="event.stopPropagation(); openEventModal('${dateStr}', '10:00')">+</button>
                </div>
            `;
            }

            const endDay = lastDay.getDay() === 0 ? 0 : lastDay.getDay() - 1;
            for (let i = 1; i < 7 - endDay; i++) {
                html += `<div class="day other-month">${i}</div>`;
            }

            html += '</div></div>';
            return html;
        }

        function renderWeekView() {
            const weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - (weekStart.getDay() === 0 ? 6 : weekStart.getDay() - 1));

            let html = '<div class="calendar-grid"><div class="week-view">';

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dateStr = formatLocalDate(date);
                const dayName = date.toLocaleDateString('de-DE', { weekday: 'short' });
                const dayNum = date.getDate();
                const hasEvent = calendarEvents.some(e => e.date === dateStr);
                const isToday = dateStr === formatLocalDate(new Date());

                html += `
                <div class="week-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}" onclick="selectDate('${dateStr}')">
                    <div style="font-size: 12px; opacity: 0.7; font-weight: 600;">${dayName}</div>
                    <div style="font-size: 18px; font-weight: 600;">${dayNum}</div>
                    ${hasEvent ? '<div style="color: var(--primary-green); font-size: 10px; margin-top: 4px;">●●●</div>' : ''}
                    <button class="week-day-add-btn" onclick="event.stopPropagation(); openEventModal('${dateStr}', '10:00')">+</button>
                </div>
            `;
            }

            html += '</div></div>';
            return html;
        }

        function renderYearView() {
            const year = currentDate.getFullYear();
            let html = '<div class="year-view">';

            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const monthName = new Date(year, month).toLocaleDateString('de-DE', { month: 'short' });
                const monthNum = month + 1;

                html += `<div class="year-month" onclick="switchToMonth(${year}, ${monthNum})" style="cursor: pointer;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 12px;">${monthName}</div>
                    <div class="year-month-grid">`;

                const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                for (let i = startDay - 1; i >= 0; i--) {
                    html += `<div class="year-day other-month"></div>`;
                }

                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const date = new Date(year, month, i);
                    const dateStr = formatLocalDate(date);
                    const hasEvent = calendarEvents.some(e => e.date === dateStr);

                    html += `<div class="year-day ${hasEvent ? 'has-event' : ''}">${i}</div>`;
                }

                const endDay = lastDay.getDay() === 0 ? 0 : lastDay.getDay() - 1;
                for (let i = 1; i < 7 - endDay; i++) {
                    html += `<div class="year-day other-month"></div>`;
                }

                html += '</div></div>';
            }

            html += '</div>';
            return html;
        }

        function updateTitle() {
            const titleEl = document.getElementById('calendarTitle');
            if (!titleEl) return;

            let title = '';
            if (calendarView === 'day') {
                title = currentDate.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            } else if (calendarView === 'week') {
                const weekStart = new Date(currentDate);
                weekStart.setDate(weekStart.getDate() - (weekStart.getDay() === 0 ? 6 : weekStart.getDay() - 1));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                title = `${weekStart.toLocaleDateString('de-DE', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('de-DE', { day: 'numeric', month: 'short', year: 'numeric' })}`;
            } else if (calendarView === 'month') {
                title = currentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            } else if (calendarView === 'year') {
                title = currentDate.getFullYear().toString();
            }
            titleEl.textContent = title;
        }

        function renderEvents() {
            let events = [];

            if (calendarView === 'day') {
                const dateStr = formatLocalDate(currentDate);
                events = calendarEvents.filter(e => e.date === dateStr);
            } else if (calendarView === 'month') {
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                events = calendarEvents.filter(e => e.date.startsWith(`${year}-${month}`));
            } else if (calendarView === 'year') {
                const year = currentDate.getFullYear();
                events = calendarEvents.filter(e => e.date.startsWith(year.toString()));
            }

            let html = '';
            if (events.length === 0) {
                html = '<p style="opacity: 0.7; text-align: center;">Keine Termine</p>';
            } else {
                events.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(event => {
                    const date = new Date(event.date).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' });
                    html += `
                    <div class="event-card">
                        <div class="event-info">
                            <div class="event-title">${event.title}</div>
                            <div class="event-date">${date} • ${event.time}</div>
                        </div>
                    </div>
                `;
                });
            }

            const eventsList = document.getElementById('eventsList');
            if (eventsList) {
                eventsList.innerHTML = html;
            }
        }

        let draggedEventIndex = null;
        let dragStartTime = null;
        let dragStartY = null;
        let dragMode = null;
        let originalDuration = null;

        function setupDragListeners() {
            const events = document.querySelectorAll('.timeline-event');
            console.log('Found timeline events:', events.length);
            events.forEach(eventEl => {
                eventEl.addEventListener('mousedown', handleTimelineEventMouseDown);

                // Add button listeners
                const editBtn = eventEl.querySelector('.event-edit-btn');
                const deleteBtn = eventEl.querySelector('.event-delete-btn');

                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const idx = parseInt(eventEl.getAttribute('data-event-index'));
                        editEvent(idx);
                    });
                }

                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const idx = parseInt(eventEl.getAttribute('data-event-index'));
                        deleteEvent(idx);
                    });
                }
            });
        }

        function handleTimelineEventMouseDown(e) {
            // Ignore if clicking on buttons
            if (e.target.closest('.event-btn')) {
                return;
            }

            // Prüfe ob auf dem Resize-Handle geklickt wurde
            const resizeHandle = e.target.closest('.event-resize-handle');

            if (resizeHandle) {
                // Resize-Mode - nur wenn auf dem Handle geklickt
                dragMode = 'resize';
            } else if (e.target.closest('.timeline-event')) {
                // Move-Mode - überall sonst auf dem Event
                dragMode = 'move';
            } else {
                return;
            }

            const eventEl = e.currentTarget;
            console.log('Mouse down on event:', { dragMode, eventEl });

            const eventIndex = parseInt(eventEl.getAttribute('data-event-index'));

            draggedEventIndex = eventIndex;
            dragStartY = e.clientY;
            dragStartTime = calendarEvents[eventIndex].time;
            originalDuration = calendarEvents[eventIndex].duration || 1;

            eventEl.style.opacity = '0.7';
            eventEl.style.cursor = dragMode === 'resize' ? 'ns-resize' : 'grabbing';

            document.addEventListener('mousemove', handleTimelineEventDragMove);
            document.addEventListener('mouseup', handleTimelineEventDragEnd);

            e.preventDefault();
        }

        function handleTimelineEventDragMove(e) {
            if (draggedEventIndex === null) return;

            const event = calendarEvents[draggedEventIndex];
            const timelineSlots = document.querySelectorAll('.time-slot');

            if (timelineSlots.length === 0) return;

            const slotHeight = timelineSlots[0].offsetHeight;
            const deltaY = e.clientY - dragStartY;
            const hourChange = Math.round(deltaY / slotHeight);

            console.log('Dragging:', { dragStartY, clientY: e.clientY, deltaY, slotHeight, hourChange, dragMode });

            if (dragMode === 'move') {
                const [hours, minutes] = dragStartTime.split(':');
                let newHour = parseInt(hours) + hourChange;

                console.log('Time change:', { dragStartTime, newHour, oldHour: parseInt(hours) });

                if (newHour >= 0 && newHour < 24) {
                    event.time = `${String(newHour).padStart(2, '0')}:${minutes}`;
                    console.log('New time set:', event.time);
                }
            } else if (dragMode === 'resize') {
                const newDuration = Math.max(0.5, originalDuration + (deltaY / (slotHeight / 2)));
                event.duration = newDuration;
                console.log('New duration:', newDuration);
            }

            // Update visual position in Echtzeit
            const eventEl = document.querySelector(`[data-event-index="${draggedEventIndex}"]`);
            if (eventEl) {
                if (dragMode === 'move') {
                    // Berechne die neue Top-Position
                    const [hours, minutes] = dragStartTime.split(':');
                    const startHour = parseInt(hours);
                    const newTopPx = (startHour + Math.round(deltaY / slotHeight)) * 80;
                    eventEl.style.top = newTopPx + 'px';
                } else if (dragMode === 'resize') {
                    // Berechne neue Höhe
                    const newHeight = Math.max(40, (event.duration || 1) * 80);
                    eventEl.style.height = newHeight + 'px';
                }
            }
        }

        function handleTimelineEventDragEnd(e) {
            document.removeEventListener('mousemove', handleTimelineEventDragMove);
            document.removeEventListener('mouseup', handleTimelineEventDragEnd);

            if (draggedEventIndex !== null) {
                const target = document.querySelector(`[data-event-index="${draggedEventIndex}"]`);
                if (target) {
                    target.style.opacity = '1';
                    target.style.cursor = 'grab';
                    target.style.top = '';
                    target.style.height = '';
                }

                saveEventsToStorage();
                renderCalendar();
            }

            draggedEventIndex = null;
            dragStartTime = null;
            dragStartY = null;
            dragMode = null;
            originalDuration = null;
        }

        function renderCalendar() {
            console.log('renderCalendar aufgerufen');
            const container = document.getElementById('calendarContainer');
            console.log('Container gefunden:', container);
            if (!container) return;

            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="previousPeriod()">‹</button>
                    <div class="calendar-title" id="calendarTitle">Januar 2026</div>
                    <button class="calendar-nav-btn" onclick="nextPeriod()">›</button>
                    <div style="margin-left: auto; display: flex; gap: 8px;">
                        <button class="view-btn" onclick="switchView('day')">Tag</button>
                        <button class="view-btn" onclick="switchView('week')">Woche</button>
                        <button class="view-btn" onclick="switchView('month')">Monat</button>
                        <button class="view-btn" onclick="switchView('year')">Jahr</button>
                    </div>
                </div>
            `;

            if (calendarView === 'day') {
                html += renderDayView();
            } else if (calendarView === 'week') {
                html += renderWeekView();
            } else if (calendarView === 'month') {
                html += renderMonthView();
            } else if (calendarView === 'year') {
                html += renderYearView();
            }

            html += `
                <div class="events-container" id="eventsContainer">
                    <h2 style="font-size: 18px; margin-bottom: 15px;">Termine</h2>
                    <div id="eventsList"></div>
                </div>
            `;

            container.innerHTML = html;
            updateTitle();
            renderEvents();

            if (calendarView === 'day') {
                setupDragListeners();
            }
        }

        function switchView(view) {
            calendarView = view;
            renderCalendar();
        }

        function previousPeriod() {
            if (calendarView === 'day') {
                currentDate.setDate(currentDate.getDate() - 1);
            } else if (calendarView === 'week') {
                currentDate.setDate(currentDate.getDate() - 7);
            } else if (calendarView === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else if (calendarView === 'year') {
                currentDate.setFullYear(currentDate.getFullYear() - 1);
            }
            renderCalendar();
        }

        function nextPeriod() {
            if (calendarView === 'day') {
                currentDate.setDate(currentDate.getDate() + 1);
            } else if (calendarView === 'week') {
                currentDate.setDate(currentDate.getDate() + 7);
            } else if (calendarView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else if (calendarView === 'year') {
                currentDate.setFullYear(currentDate.getFullYear() + 1);
            }
            renderCalendar();
        }

        function selectDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            currentDate = new Date(year, month - 1, day);
            calendarView = 'day';
            renderCalendar();
        }

        function switchToMonth(year, monthNum) {
            currentDate = new Date(year, monthNum - 1, 1);
            calendarView = 'month';
            renderCalendar();
        }

        window.addEventListener('load', async function () {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }

            // Lade Berechtigungen zuerst
            await loadUserPermissions();


            renderSidebar();
            renderHomeGrid();
            initializeCalendar();
            populateKaderTeamSelect();
            renderCharts();
            renderTeamsList();
            loadMessengerData();
            setTimeout(() => {
                renderDashboardStats();
            }, 100);
        });

        // ONBOARDING CHECK - SECURITY: NICHT aus localStorage laden, IMMER vom Server!
        let registeredClub = null;
        let registeredUser = null;

        // Load user profile from server - SECURITY: Immer frische Daten laden
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/profile');
                if (response.status === 401) {
                    // Nicht eingeloggt - zur Login-Seite
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                if (!data.error) {
                    registeredClub = data.teamname ? { name: data.teamname, id: 1 } : null;
                    registeredUser = data.vorname || data.email;

                    // Update sidebar logo
                    const logo = document.querySelector('.logo');
                    if (logo && registeredClub?.name) {
                        logo.innerHTML = `⚽ ${escapeHtml(registeredClub.name)}`;
                    }
                }
            } catch (e) {
                console.log('Could not load profile from server');
            }
        }
        loadUserProfile();


        function updateAppLogo() {
            const logo = document.getElementById('appLogo');
            if (registeredClub && logo) {
                logo.innerHTML = `⚽ ${escapeHtml(registeredClub.name)}`;
            }
        }

        // ========== TEAM MANAGEMENT ==========
        let userHasTeam = false;

        async function checkTeamStatus() {
            try {
                const response = await fetch('/api/team/status');
                if (response.ok) {
                    const data = await response.json();
                    userHasTeam = data.has_team;

                    const noTeamNotice = document.getElementById('noTeamNotice');
                    const dashboardGrid = document.querySelector('.dashboard-grid');
                    const addMannschaftSection = document.getElementById('addMannschaftSection');

                    if (!userHasTeam) {
                        noTeamNotice.style.display = 'block';
                        if (dashboardGrid) dashboardGrid.style.opacity = '0.5';
                        if (addMannschaftSection) addMannschaftSection.style.display = 'none';
                    } else {
                        noTeamNotice.style.display = 'none';
                        if (dashboardGrid) dashboardGrid.style.opacity = '1';
                        // Zeige "Mannschaft hinzufügen" Button wenn User bereits ein Team hat
                        if (addMannschaftSection) addMannschaftSection.style.display = 'block';

                        // Team-Name im Logo anzeigen
                        if (data.team) {
                            const logo = document.getElementById('appLogo');
                            if (logo) {
                                logo.innerHTML = `⚽ ${escapeHtml(data.team.verein)}`;
                            }
                        }
                    }
                }
            } catch (e) {
                console.log('Team status check failed:', e);
            }
        }

        function showCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'flex';
            document.getElementById('createTeamVerein').focus();
        }

        function hideCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'none';
            document.getElementById('createTeamVerein').value = '';
            document.getElementById('createTeamMannschaft').value = '';
            document.getElementById('createTeamError').style.display = 'none';
        }

        async function submitCreateTeam() {
            const verein = document.getElementById('createTeamVerein').value.trim();
            const mannschaft = document.getElementById('createTeamMannschaft').value.trim();
            const errorDiv = document.getElementById('createTeamError');

            if (!verein || !mannschaft) {
                errorDiv.textContent = 'Bitte fülle beide Felder aus.';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/team/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ verein, mannschaft })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    hideCreateTeamModal();
                    userHasTeam = true;

                    // UI aktualisieren
                    document.getElementById('noTeamNotice').style.display = 'none';
                    document.querySelector('.dashboard-grid').style.opacity = '1';

                    // Logo aktualisieren
                    const logo = document.getElementById('appLogo');
                    if (logo) {
                        logo.innerHTML = `⚽ ${escapeHtml(verein)}`;
                    }

                    // Seite neu laden für vollständige Aktualisierung
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Fehler beim Erstellen des Teams.';
                    errorDiv.style.display = 'block';
                }
            } catch (e) {
                errorDiv.textContent = 'Netzwerkfehler. Bitte versuche es erneut.';
                errorDiv.style.display = 'block';
            }
        }

        // Modal schließen bei Klick außerhalb
        document.getElementById('createTeamModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                hideCreateTeamModal();
            }
        });

        // Add Mannschaft Modal Functions
        function showAddMannschaftModal() {
            document.getElementById('addMannschaftModal').style.display = 'flex';
        }

        function hideAddMannschaftModal() {
            document.getElementById('addMannschaftModal').style.display = 'none';
        }

        function startProUpgrade() {
            // Hier später Payment Integration
            alert('Die Zahlungsintegration wird in Kürze verfügbar sein. Kontaktiere uns unter support@pitchinsights.de für Early Access!');
            hideAddMannschaftModal();
        }

        // Modal schließen bei Klick außerhalb
        document.getElementById('addMannschaftModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                hideAddMannschaftModal();
            }
        });

        // Beim Laden prüfen
        document.addEventListener('DOMContentLoaded', function () {
            // Einmalig: Alte appConfig ohne 'kasse' zurücksetzen
            const configCheck = localStorage.getItem('appConfig');
            if (configCheck && !configCheck.includes('"kasse"')) {
                console.log('Resetting appConfig to include new apps');
                localStorage.removeItem('appConfig');
            }

            checkTeamStatus(); // Team-Status prüfen
            if (registeredClub) {
                updateAppLogo();
            }
            // App Store Initialisierung
            renderSidebar();
            renderHomeGrid();

            // Widget-Daten und Dashboard Stats laden
            setTimeout(() => {
                updateAllWidgetData();
                renderDashboardStats();
            }, 500);
        });

        let kaderPlayers = [];
        let teamMembersCache = [];
        let kaderTeams = JSON.parse(localStorage.getItem('kaderTeams') || '[]');
        let selectedTeamFilter = 'all';
        let statusChart = null;
        let positionChart = null;

        // Lade Spieler von API oder localStorage
        async function initKaderData() {
            try {
                const response = await fetch('/api/players');
                if (response.ok) {
                    const data = await response.json();
                    if (data.players && data.players.length > 0) {
                        kaderPlayers = data.players.map(p => ({
                            id: p.id,
                            firstname: p.name.split(' ')[0] || p.name,
                            lastname: p.name.split(' ').slice(1).join(' ') || '',
                            position: p.position || 'mittelfeld',
                            jersey: p.trikotnummer || 0,
                            status: (p.status || 'Fit').toLowerCase(),
                            email: p.email || '',
                            phone: p.telefon || '',
                            notes: p.notizen || '',
                            user_id: p.user_id || null
                        }));
                        return;
                    }
                }

                // Keine Spieler in der DB
                kaderPlayers = [];
                return;
            } catch (e) {
                console.log('API nicht verfügbar, nutze localStorage');
            }

            // Fallback: localStorage
            kaderPlayers = JSON.parse(localStorage.getItem('kaderPlayers') || '[]');
        }

        // Initialisierung beim Laden
        initKaderData().then(async () => {
            await populateKaderTeamSelect();
            if (document.getElementById('statusChart')) {
                renderCharts();
            }
            // Dashboard Stats nach Kader-Init aktualisieren
            renderDashboardStats();
        });

        let userTeamInfo = null;

        async function populateKaderTeamSelect() {
            const select = document.getElementById('kaderTeamSelect');
            if (!select) return;

            const isDark = document.body.classList.contains('dark-mode');
            select.style.background = isDark ? 'var(--card-dark)' : 'var(--card-light)';
            select.style.color = isDark ? 'var(--text-dark)' : 'var(--text-light)';
            select.style.borderColor = isDark ? 'var(--border-dark)' : 'var(--border-light)';

            // Lade Team-Info vom Backend wenn noch nicht geladen
            if (!userTeamInfo) {
                try {
                    const response = await fetch('/api/team/info');
                    if (response.ok) {
                        userTeamInfo = await response.json();
                    }
                } catch (e) {
                    console.log('Fehler beim Laden der Team-Info:', e);
                }
            }

            // Speichere aktuelle Auswahl
            const currentValue = select.value || 'all';

            // Leere und fülle neu
            select.innerHTML = '';

            if (userTeamInfo && userTeamInfo.has_team) {
                // Zeige das echte Team des Benutzers
                const teamDisplayName = userTeamInfo.mannschaft || userTeamInfo.team_name || 'Mein Team';
                const vereinName = userTeamInfo.verein ? `${userTeamInfo.verein} - ` : '';

                if (kaderTeams.length === 0) {
                    kaderTeams = [{
                        id: userTeamInfo.team_id || 'team',
                        name: teamDisplayName
                    }];
                    localStorage.setItem('kaderTeams', JSON.stringify(kaderTeams));
                }

                const teamOption = document.createElement('option');
                teamOption.value = 'team';
                teamOption.textContent = `${vereinName}${teamDisplayName}`;
                teamOption.selected = true;
                select.appendChild(teamOption);

                selectedTeamFilter = 'team';
            } else {
                // Kein Team - Hinweis anzeigen
                const noTeamOption = document.createElement('option');
                noTeamOption.value = 'none';
                noTeamOption.textContent = 'Kein Team erstellt';
                noTeamOption.disabled = true;
                noTeamOption.selected = true;
                select.appendChild(noTeamOption);

                selectedTeamFilter = 'none';
            }

            updatePlayerCount();
        }

        function filterPlayersByTeam() {
            const select = document.getElementById('kaderTeamSelect');
            selectedTeamFilter = select.value;
            renderCharts();
            updatePlayerCount();
        }

        function getFilteredPlayers() {
            // Alle Spieler gehören zum Team des Benutzers
            // (Backend filtert bereits nach team_id)
            return kaderPlayers;
        }

        async function loadTeamMembersForKader() {
            try {
                const response = await fetch('/api/team/members');
                if (!response.ok) {
                    teamMembersCache = [];
                    return;
                }
                const data = await response.json();
                teamMembersCache = (data.members || []).filter(m => {
                    return (m.role_name || '').toLowerCase() === 'spieler';
                });
            } catch (e) {
                teamMembersCache = [];
            }
        }

        function buildKaderMemberOptions(currentUserId) {
            const select = document.getElementById('editPlayerUser');
            if (!select) return;

            const linkedUserIds = new Set(
                kaderPlayers.filter(p => p.user_id).map(p => parseInt(p.user_id, 10))
            );
            const options = teamMembersCache.filter(m => {
                return !linkedUserIds.has(parseInt(m.id, 10)) || parseInt(m.id, 10) === parseInt(currentUserId || 0, 10);
            });

            select.innerHTML = `
                <option value="">Kein Account verknüpft</option>
                ${options.map(m => {
                    const name = `${m.vorname || ''} ${m.nachname || ''}`.trim() || m.email;
                    return `<option value="${parseInt(m.id, 10)}">${escapeHtml(name)} (${escapeHtml(m.email)})</option>`;
                }).join('')}
            `;
            if (currentUserId) {
                select.value = String(currentUserId);
            }
        }

        function updatePlayerCount() {
            const countEl = document.getElementById('kaderPlayerCount');
            if (countEl) {
                const filtered = getFilteredPlayers();
                countEl.textContent = `${filtered.length} Spieler`;
            }
        }

        function renderCharts() {
            if (!window.Chart) {
                console.error('Chart.js nicht geladen');
                return;
            }

            const isDark = document.body.classList.contains('dark-mode');
            const filteredPlayers = getFilteredPlayers();

            // Status Counts
            const stat = {
                fit: filteredPlayers.filter(p => p.status === 'fit').length,
                training: filteredPlayers.filter(p => p.status === 'training').length,
                reha: filteredPlayers.filter(p => p.status === 'reha').length,
                ausfall: filteredPlayers.filter(p => p.status === 'ausfall').length
            };

            // Position Counts
            const pos = {
                torwart: filteredPlayers.filter(p => p.position === 'torwart').length,
                abwehr: filteredPlayers.filter(p => p.position === 'abwehr').length,
                mittelfeld: filteredPlayers.filter(p => p.position === 'mittelfeld').length,
                sturm: filteredPlayers.filter(p => p.position === 'sturm').length
            };

            // Update HTML
            document.getElementById('stat-fit').textContent = stat.fit;
            document.getElementById('stat-training').textContent = stat.training;
            document.getElementById('stat-reha').textContent = stat.reha;
            document.getElementById('stat-ausfall').textContent = stat.ausfall;

            document.getElementById('pos-torwart').textContent = pos.torwart;
            document.getElementById('pos-abwehr').textContent = pos.abwehr;
            document.getElementById('pos-mittelfeld').textContent = pos.mittelfeld;
            document.getElementById('pos-sturm').textContent = pos.sturm;

            // Status Chart
            const statusEl = document.getElementById('statusChart');
            if (statusEl) {
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(statusEl.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Fit', 'Training', 'Reha', 'Ausfall'],
                        datasets: [{
                            data: [stat.fit, stat.training, stat.reha, stat.ausfall],
                            backgroundColor: ['#22c55e', '#f59e0b', '#06b6d4', '#ef4444'],
                            borderColor: isDark ? '#1c1c1e' : '#fff',
                            borderWidth: 2,
                            spacing: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        rotation: -90,
                        circumference: 360,
                        animation: {
                            animateRotate: true,
                            animateScale: false,
                            duration: 1500
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: isDark ? 'rgba(50, 50, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                                titleColor: isDark ? '#fff' : '#1d1d1f',
                                bodyColor: isDark ? '#fff' : '#1d1d1f',
                                borderColor: isDark ? '#444' : '#e5e5ea',
                                borderWidth: 1,
                                cornerRadius: 8,
                                padding: 12,
                                displayColors: true,
                                boxWidth: 12,
                                boxHeight: 12,
                                boxPadding: 4,
                                titleFont: { size: 14, weight: '600' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                        return ` ${context.label}: ${context.raw} Spieler (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Position Chart
            const posEl = document.getElementById('positionChart');
            if (posEl) {
                if (positionChart) positionChart.destroy();
                positionChart = new Chart(posEl.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Torwart', 'Abwehr', 'Mittelfeld', 'Sturm'],
                        datasets: [{
                            data: [pos.torwart, pos.abwehr, pos.mittelfeld, pos.sturm],
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f97316'],
                            borderColor: isDark ? '#1c1c1e' : '#fff',
                            borderWidth: 2,
                            spacing: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        rotation: -90,
                        circumference: 360,
                        animation: {
                            animateRotate: true,
                            animateScale: false,
                            duration: 1500
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: isDark ? 'rgba(50, 50, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                                titleColor: isDark ? '#fff' : '#1d1d1f',
                                bodyColor: isDark ? '#fff' : '#1d1d1f',
                                borderColor: isDark ? '#444' : '#e5e5ea',
                                borderWidth: 1,
                                cornerRadius: 8,
                                padding: 12,
                                displayColors: true,
                                boxWidth: 12,
                                boxHeight: 12,
                                boxPadding: 4,
                                titleFont: { size: 14, weight: '600' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                        return ` ${context.label}: ${context.raw} Spieler (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Player List (gefiltert nach Team)
            const list = document.getElementById('kader-list');
            if (filteredPlayers.length === 0) {
                list.innerHTML = '<div class="list-item"><span>Keine Spieler in dieser Mannschaft</span><span>--</span></div>';
            } else {
                list.innerHTML = filteredPlayers.map(p => {
                    // Team-Farbe finden
                    const team = kaderTeams.find(t => t.name === p.team);
                    const teamColor = team ? team.color : '#6b7280';
                    return `<div class="list-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span>${p.firstname} ${p.lastname}</span>
                            <span style="opacity: 0.7; margin-left: 10px;">#${p.jersey} - ${p.position}</span>
                            <span style="opacity: 0.6; margin-left: 10px; font-size: 12px;">${p.status}</span>
                            ${p.team ? `<span style="margin-left: 10px; font-size: 11px; background: ${teamColor}; color: white; padding: 3px 8px; border-radius: 4px; font-weight: 500;">${p.team}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="openEditPlayerModal(${p.id})" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Bearbeiten</button>
                            <button onclick="deletePlayer(${p.id})" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Löschen</button>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        async function addNewPlayer() {
            // Prüfen ob Teams existieren
            if (kaderTeams.length === 0) {
                alert('Bitte erstelle erst eine Mannschaft bevor du einen Spieler anlegst');
                return;
            }

            const firstname = document.getElementById('playerFirstname').value.trim();
            const lastname = document.getElementById('playerLastname').value.trim();
            const jersey = parseInt(document.getElementById('playerJersey').value);
            const status = document.getElementById('playerStatus').value.toLowerCase();
            const birthdate = document.getElementById('playerBirthdate').value;
            const country = document.getElementById('playerCountry').value;
            const team = document.getElementById('playerTeam').value;
            const height = document.getElementById('playerHeight').value;
            const weight = document.getElementById('playerWeight').value;

            // Positionen sammeln (Checkboxen)
            const positionCheckboxes = document.querySelectorAll('input[name="positions"]:checked');
            const positions = Array.from(positionCheckboxes).map(cb => cb.value);

            if (!firstname || !lastname || !jersey) {
                alert('Bitte füll Vorname, Nachname und Nummer aus');
                return;
            }

            if (positions.length === 0) {
                alert('Bitte wähle mindestens eine Position');
                return;
            }

            // Alter berechnen
            let age = null;
            if (birthdate) {
                const birth = new Date(birthdate);
                const today = new Date();
                age = today.getFullYear() - birth.getFullYear();
                const m = today.getMonth() - birth.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
            }

            // Position-Kategorie für Charts bestimmen
            let positionCategory = 'mittelfeld';
            if (positions.includes('TW')) positionCategory = 'torwart';
            else if (positions.some(p => ['IV', 'LV', 'RV'].includes(p))) positionCategory = 'abwehr';
            else if (positions.some(p => ['ST', 'LF', 'RF'].includes(p))) positionCategory = 'sturm';

            const newPlayer = {
                id: Date.now(),
                firstname,
                lastname,
                jersey,
                positions,
                position: positionCategory,
                status,
                birthdate,
                age,
                country,
                team,
                height: height ? parseInt(height) : null,
                weight: weight ? parseInt(weight) : null
            };

            // Speichere in API und localStorage
            try {
                const apiPlayer = {
                    name: `${firstname} ${lastname}`.trim(),
                    position: positionCategory,
                    trikotnummer: jersey,
                    status: status.charAt(0).toUpperCase() + status.slice(1).toLowerCase(),
                    notizen: `Team: ${team}`
                };
                const response = await fetch('/api/players', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(apiPlayer)
                });
                if (response.ok) {
                    const result = await response.json();
                    newPlayer.id = result.id;
                }
            } catch (e) {
                console.log('API nicht verfügbar, speichere lokal');
            }

            kaderPlayers.push(newPlayer);
            localStorage.setItem('kaderPlayers', JSON.stringify(kaderPlayers));

            // Clear form
            document.getElementById('playerFirstname').value = '';
            document.getElementById('playerLastname').value = '';
            document.getElementById('playerJersey').value = '';
            document.getElementById('playerBirthdate').value = '';
            document.getElementById('playerCountry').value = 'DE';
            if (kaderTeams.length > 0) {
                document.getElementById('playerTeam').value = kaderTeams[0].name;
            }
            document.getElementById('playerStatus').value = 'Fit';
            document.getElementById('playerHeight').value = '';
            document.getElementById('playerWeight').value = '';
            document.querySelectorAll('input[name="positions"]').forEach(cb => cb.checked = false);

            closeAddPlayerModal();
            renderCharts();
            renderDashboardStats();
        }

        function openAddPlayerModal() {
            // Prüfen ob Teams existieren
            if (kaderTeams.length === 0) {
                document.getElementById('noTeamsWarning').style.display = 'block';
                document.getElementById('playerTeam').style.display = 'none';
            } else {
                document.getElementById('noTeamsWarning').style.display = 'none';
                document.getElementById('playerTeam').style.display = 'block';
                populateTeamDropdown();
            }
            document.getElementById('addPlayerModal').classList.add('active');
        }

        function populateTeamDropdown() {
            const select = document.getElementById('playerTeam');
            select.innerHTML = '';
            kaderTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.name;
                option.textContent = team.name;
                select.appendChild(option);
            });
        }

        function closeAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.remove('active');
        }

        // EDIT PLAYER FUNKTIONEN
        async function openEditPlayerModal(id) {
            const player = kaderPlayers.find(p => p.id === id);
            if (!player) return;

            // ID speichern
            document.getElementById('editPlayerId').value = id;

            // Felder befüllen
            document.getElementById('editPlayerFirstname').value = player.firstname || '';
            document.getElementById('editPlayerLastname').value = player.lastname || '';
            document.getElementById('editPlayerBirthdate').value = player.birthdate || '';
            document.getElementById('editPlayerCountry').value = player.country || 'DE';
            document.getElementById('editPlayerJersey').value = player.jersey || '';
            document.getElementById('editPlayerStatus').value = player.status ? player.status.charAt(0).toUpperCase() + player.status.slice(1) : 'Fit';
            document.getElementById('editPlayerHeight').value = player.height || '';
            document.getElementById('editPlayerWeight').value = player.weight || '';

            // Mannschaft Dropdown befüllen
            const teamSelect = document.getElementById('editPlayerTeam');
            teamSelect.innerHTML = '';
            kaderTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.name;
                option.textContent = team.name;
                if (player.team === team.name) option.selected = true;
                teamSelect.appendChild(option);
            });

            // Positionen-Checkboxen zurücksetzen und setzen
            document.querySelectorAll('input[name="editPositions"]').forEach(cb => {
                cb.checked = player.positions && player.positions.includes(cb.value);
            });

            if (!teamMembersCache || teamMembersCache.length === 0) {
                await loadTeamMembersForKader();
            }
            buildKaderMemberOptions(player.user_id);

            document.getElementById('editPlayerModal').classList.add('active');
        }

        function closeEditPlayerModal() {
            document.getElementById('editPlayerModal').classList.remove('active');
        }

        async function saveEditPlayer() {
            const id = parseInt(document.getElementById('editPlayerId').value);
            const playerIndex = kaderPlayers.findIndex(p => p.id === id);

            console.log('Saving player - ID:', id, 'PlayerIndex:', playerIndex);

            if (playerIndex === -1) {
                console.error('Player not found in kaderPlayers array');
                alert('Spieler nicht gefunden');
                return;
            }

            const firstname = document.getElementById('editPlayerFirstname').value.trim();
            const lastname = document.getElementById('editPlayerLastname').value.trim();
            const jersey = parseInt(document.getElementById('editPlayerJersey').value);
            const status = document.getElementById('editPlayerStatus').value; // Fit, Training, Reha, Ausfall
            const birthdate = document.getElementById('editPlayerBirthdate').value;
            const country = document.getElementById('editPlayerCountry').value;
            const team = document.getElementById('editPlayerTeam').value;
            const height = document.getElementById('editPlayerHeight').value;
            const weight = document.getElementById('editPlayerWeight').value;
            const userIdValue = document.getElementById('editPlayerUser')?.value || '';
            const linkedUserId = userIdValue ? parseInt(userIdValue, 10) : null;

            // Positionen sammeln
            const positionCheckboxes = document.querySelectorAll('input[name="editPositions"]:checked');
            const positions = Array.from(positionCheckboxes).map(cb => cb.value);

            if (!firstname || !lastname || !jersey) {
                alert('Bitte füll Vorname, Nachname und Nummer aus');
                return;
            }

            if (positions.length === 0) {
                alert('Bitte wähle mindestens eine Position');
                return;
            }

            // Alter berechnen
            let age = null;
            if (birthdate) {
                const birth = new Date(birthdate);
                const today = new Date();
                age = today.getFullYear() - birth.getFullYear();
                const m = today.getMonth() - birth.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
            }

            // Positions-Kategorie bestimmen
            let positionCategory = 'feldspieler';
            if (positions.includes('TW')) {
                positionCategory = 'torwart';
            } else if (positions.some(p => ['IV', 'LV', 'RV'].includes(p))) {
                positionCategory = 'abwehr';
            } else if (positions.some(p => ['DM', 'ZM', 'LM', 'RM', 'OM'].includes(p))) {
                positionCategory = 'mittelfeld';
            } else if (positions.some(p => ['LF', 'RF', 'ST'].includes(p))) {
                positionCategory = 'sturm';
            }

            // An Server senden
            try {
                console.log('Saving player:', { id, firstname, lastname, jersey, status, positions });

                const response = await fetch(`/api/players/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: `${firstname} ${lastname}`,
                        position: positions.join(', '),
                        trikotnummer: jersey,
                        status: status,
                        user_id: linkedUserId
                    })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const err = await response.json();
                    console.error('API Error:', err);
                    alert(err.error || 'Fehler beim Speichern');
                    return;
                }

                // Lokal aktualisieren
                kaderPlayers[playerIndex] = {
                    ...kaderPlayers[playerIndex],
                    firstname,
                    lastname,
                    name: `${firstname} ${lastname}`,
                    jersey,
                    positions,
                    position: positionCategory,
                    status,
                    birthdate,
                    age,
                    country,
                    team,
                    height,
                    weight,
                    user_id: linkedUserId || null
                };

                closeEditPlayerModal();
                await initKaderData(); // Neu laden von Server
                renderPlayerList();
                renderCharts();
                renderDashboardStats();
            } catch (e) {
                console.error('Fehler beim Speichern:', e);
                alert('Netzwerkfehler beim Speichern. Bitte erneut versuchen.');
            }
        }

        // TEAM FUNKTIONEN
        function openAddTeamModal() {
            document.getElementById('addTeamModal').style.display = 'flex';
        }

        function closeAddTeamModal() {
            document.getElementById('addTeamModal').style.display = 'none';
            document.getElementById('teamName').value = '';
            document.getElementById('teamColor').value = '#10b981';
        }

        function addNewTeam() {
            const name = document.getElementById('teamName').value.trim();
            const category = document.getElementById('teamCategory').value;
            const color = document.getElementById('teamColor').value;

            if (!name) {
                alert('Bitte gib einen Mannschaftsnamen ein');
                return;
            }

            // Prüfen ob Name schon existiert
            if (kaderTeams.some(t => t.name.toLowerCase() === name.toLowerCase())) {
                alert('Eine Mannschaft mit diesem Namen existiert bereits');
                return;
            }

            const newTeam = {
                id: Date.now(),
                name,
                category,
                color
            };

            kaderTeams.push(newTeam);
            localStorage.setItem('kaderTeams', JSON.stringify(kaderTeams));
            closeAddTeamModal();
            renderTeamsList();
            populateKaderTeamSelect();
        }

        function deleteTeam(id) {
            const team = kaderTeams.find(t => t.id === id);
            if (!team) return;

            // Prüfen ob Spieler dieser Mannschaft zugeordnet sind
            const playersInTeam = kaderPlayers.filter(p => p.team === team.name);
            if (playersInTeam.length > 0) {
                if (!confirm(`${playersInTeam.length} Spieler sind dieser Mannschaft zugeordnet. Trotzdem löschen?`)) {
                    return;
                }
            }

            if (confirm(`Mannschaft "${team.name}" wirklich löschen?`)) {
                kaderTeams = kaderTeams.filter(t => t.id !== id);
                localStorage.setItem('kaderTeams', JSON.stringify(kaderTeams));
                renderTeamsList();
                populateKaderTeamSelect();
            }
        }

        function renderTeamsList() {
            const isDark = document.body.classList.contains('dark-mode');
            const cardBg = isDark ? 'var(--card-dark)' : 'var(--card-light)';
            const textColor = isDark ? 'var(--text-dark)' : 'var(--text-light)';
            const borderColor = isDark ? 'var(--border-dark)' : 'var(--border-light)';

            // Dashboard Teams List
            const dashboardContainer = document.getElementById('dashboardTeamsList');
            if (dashboardContainer) {
                if (kaderTeams.length === 0) {
                    dashboardContainer.innerHTML = `<div style="color: ${textColor}; opacity: 0.6; font-size: 14px; padding: 20px; background: ${cardBg}; border-radius: 12px; border: 1px solid ${borderColor};">Noch keine Mannschaften erstellt. Erstelle deine erste Mannschaft!</div>`;
                } else {
                    dashboardContainer.innerHTML = kaderTeams.map(team => `
                        <div style="display: flex; align-items: center; gap: 12px; background: ${cardBg}; padding: 16px 20px; border-radius: 12px; border: 1px solid ${borderColor}; min-width: 200px;">
                            <div style="width: 40px; height: 40px; background: ${team.color || '#10b981'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">⚽</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${textColor};">${team.name}</div>
                                <div style="font-size: 12px; color: ${textColor}; opacity: 0.6;">${team.category}</div>
                            </div>
                            <button onclick="deleteTeam(${team.id})" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    `).join('');
                }
            }

            // Kader Teams List (alte Version)
            const container = document.getElementById('teamsList');
            if (container) {
                if (kaderTeams.length === 0) {
                    container.innerHTML = `<span style="color: ${textColor}; opacity: 0.6; font-size: 14px;">Noch keine Mannschaften erstellt</span>`;
                } else {
                    container.innerHTML = kaderTeams.map(team => `
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: ${cardBg}; padding: 8px 12px; border-radius: 8px; border: 1px solid ${borderColor};">
                            <span style="font-weight: 500; color: ${textColor};">${team.name}</span>
                            <span style="font-size: 11px; color: ${textColor}; opacity: 0.6;">(${team.category})</span>
                            <button onclick="deleteTeam(${team.id})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">×</button>
                        </div>
                    `).join('');
                }
            }
        }

        function deletePlayer(id) {
            if (confirm('Spieler wirklich löschen?')) {
                kaderPlayers = kaderPlayers.filter(p => p.id !== id);
                localStorage.setItem('kaderPlayers', JSON.stringify(kaderPlayers));
                renderCharts();
                renderDashboardStats();
            }
        }

        // MESSENGER FUNKTIONEN
        let currentChat = null;
        let currentAttachment = null;

        function loadMessengerData() {
            const container = document.getElementById('messengerContacts');
            let html = '';

            // Team-Chat
            const teamConv = JSON.parse(localStorage.getItem('team_chat') || '{"messages":[]}');
            const teamLastMsg = teamConv.messages[teamConv.messages.length - 1]?.text || 'Keine Nachrichten';
            const teamUnread = teamConv.unread || 0;
            const isTeamActive = currentChat === 'team_chat' ? 'background: var(--primary-green); color: white;' : '';

            html += `<div onclick="selectChat('team_chat', '👥 Team')" style="padding: 12px; border-bottom: 1px solid var(--border-light); cursor: pointer; ${isTeamActive}">
                <div style="font-weight: 600; font-size: 13px;">👥 Team Chat</div>
                <div style="font-size: 12px; opacity: 0.7; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${teamLastMsg.substring(0, 30)}</div>
                ${teamUnread > 0 ? `<div style="margin-top: 4px; display: inline-block; background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">${teamUnread}</div>` : ''}
            </div>`;

            // Spieler-Chats
            if (kaderPlayers && kaderPlayers.length > 0) {
                html += '<div style="font-size: 12px; font-weight: 600; opacity: 0.6; padding: 12px 12px 4px 12px; margin-top: 8px;">SPIELER</div>';
                kaderPlayers.forEach(player => {
                    const playerName = player.name || `${player.firstname} ${player.lastname}`;
                    const convKey = `chat_${player.id}`;
                    const conv = JSON.parse(localStorage.getItem(convKey) || '{"messages":[]}');
                    const lastMsg = conv.messages[conv.messages.length - 1]?.text || 'Keine Nachrichten';
                    const unread = conv.unread || 0;
                    const isActive = currentChat === convKey ? 'background: var(--primary-green); color: white;' : '';

                    html += `<div onclick="selectChat('${convKey}', '${playerName}')" style="padding: 12px; border-bottom: 1px solid var(--border-light); cursor: pointer; ${isActive}">
                        <div style="font-weight: 600; font-size: 13px;">${playerName}</div>
                        <div style="font-size: 12px; opacity: 0.7; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lastMsg.substring(0, 30)}</div>
                        ${unread > 0 ? `<div style="margin-top: 4px; display: inline-block; background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">${unread}</div>` : ''}
                    </div>`;
                });
            }

            // Gruppen
            const groups = JSON.parse(localStorage.getItem('messengerGroups') || '[]');
            if (groups.length > 0) {
                html += '<div style="font-size: 12px; font-weight: 600; opacity: 0.6; padding: 12px 12px 4px 12px; margin-top: 8px;">GRUPPEN</div>';
                groups.forEach(group => {
                    const convKey = `group_${group.id}`;
                    const conv = JSON.parse(localStorage.getItem(convKey) || '{"messages":[]}');
                    const lastMsg = conv.messages[conv.messages.length - 1]?.text || 'Keine Nachrichten';
                    const unread = conv.unread || 0;
                    const isActive = currentChat === convKey ? 'background: var(--primary-green); color: white;' : '';

                    html += `<div onclick="selectChat('${convKey}', '${group.name}')" style="padding: 12px; border-bottom: 1px solid var(--border-light); cursor: pointer; ${isActive}">
                        <div style="font-weight: 600; font-size: 13px;">👥 ${group.name}</div>
                        <div style="font-size: 12px; opacity: 0.7; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lastMsg.substring(0, 30)}</div>
                        ${unread > 0 ? `<div style="margin-top: 4px; display: inline-block; background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">${unread}</div>` : ''}
                    </div>`;
                });
            }

            container.innerHTML = html || '<div style="padding: 12px; text-align: center; opacity: 0.5; font-size: 12px;">Keine Kontakte</div>';
        }

        function selectChat(convKey, contactName) {
            currentChat = convKey;
            const conv = JSON.parse(localStorage.getItem(convKey) || '{"messages":[]}');
            conv.unread = 0;
            localStorage.setItem(convKey, JSON.stringify(conv));

            document.getElementById('messengerHeader').innerHTML = `<span>${contactName}</span><button id="deleteConvBtn" onclick="deleteConversation()" style="padding: 6px 12px; background: #ff4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Löschen</button>`;
            document.getElementById('messengerInput').disabled = false;

            renderMessages();
            loadMessengerData();
        }

        function renderMessages() {
            const chatArea = document.getElementById('messengerChat');
            const conv = JSON.parse(localStorage.getItem(currentChat) || '{"messages":[]}');

            if (!conv.messages || conv.messages.length === 0) {
                chatArea.innerHTML = '<div style="text-align: center; opacity: 0.5; margin: auto;">Keine Nachrichten noch</div>';
                return;
            }

            chatArea.innerHTML = '';
            conv.messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                const isOwn = msg.own === true;
                const alignment = isOwn ? 'flex-end' : 'flex-start';
                const bgColor = isOwn ? 'var(--primary-green)' : '#e0e0e0';
                const textColor = isOwn ? 'white' : 'black';

                let content = escapeHtml(msg.text);
                if (msg.attachment) {
                    const ext = msg.attachment.name.split('.').pop().toLowerCase();
                    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                        content = `<img src="${msg.attachment.data}" style="max-width: 200px; border-radius: 8px; margin-bottom: 4px;">`;
                    } else if (ext === 'pdf') {
                        content = `<div style="background: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 4px;">📄 ${escapeHtml(msg.attachment.name)}</div>`;
                    } else {
                        content = `<div style="background: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 4px;">📎 ${escapeHtml(msg.attachment.name)}</div>`;
                    }
                    if (msg.text) content += '<div style="margin-top: 4px;">' + escapeHtml(msg.text) + '</div>';
                }

                msgDiv.innerHTML = `<div style="align-self: ${alignment}; background: ${bgColor}; color: ${textColor}; padding: 12px 16px; border-radius: 12px; max-width: 60%; word-wrap: break-word;">${content}<div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">${new Date(msg.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}</div></div>`;
                chatArea.appendChild(msgDiv);
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function attachFile() {
            const fileInput = document.getElementById('messengerFileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                currentAttachment = {
                    name: file.name,
                    data: e.target.result,
                    type: file.type
                };
                document.getElementById('attachmentName').textContent = '📎 ' + file.name;
                document.getElementById('attachmentPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearAttachment() {
            currentAttachment = null;
            document.getElementById('attachmentPreview').style.display = 'none';
            document.getElementById('messengerFileInput').value = '';
        }

        function sendMessage() {
            if (!currentChat) return;
            const input = document.getElementById('messengerInput');
            if (!input.value.trim() && !currentAttachment) return;

            const conv = JSON.parse(localStorage.getItem(currentChat) || '{"messages":[]}');
            const msg = {
                text: input.value.trim(),
                own: true,
                timestamp: new Date().toISOString(),
                attachment: currentAttachment
            };

            if (!conv.messages) conv.messages = [];
            conv.messages.push(msg);
            localStorage.setItem(currentChat, JSON.stringify(conv));

            input.value = '';
            clearAttachment();
            renderMessages();
        }

        function deleteConversation() {
            if (!currentChat || !confirm('Chat wirklich löschen?')) return;
            localStorage.removeItem(currentChat);
            currentChat = null;
            document.getElementById('messengerHeader').innerHTML = '<span>Wähle einen Kontakt</span>';
            document.getElementById('messengerInput').disabled = true;
            document.getElementById('messengerChat').innerHTML = '<div style="text-align: center; opacity: 0.5; margin: auto;">Wähle einen Chat</div>';
            loadMessengerData();
        }

        function filterContacts() {
            const search = document.getElementById('contactSearch').value.toLowerCase();
            const items = document.querySelectorAll('#messengerContacts > div');
            items.forEach(item => {
                const name = item.innerText.toLowerCase();
                item.style.display = name.includes(search) ? 'block' : 'none';
            });
        }

        function showCreateGroupModal() {
            const modal = document.getElementById('createGroupModal');
            const membersList = document.getElementById('groupMembersList');
            let html = '';

            if (kaderPlayers && kaderPlayers.length > 0) {
                kaderPlayers.forEach(player => {
                    const playerName = player.name || `${player.firstname} ${player.lastname}`;
                    html += `<label style="display: block; padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer;">
                        <input type="checkbox" name="groupMember" value="${player.id}" style="margin-right: 8px;">
                        ${playerName}
                    </label>`;
                });
            }

            membersList.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
            document.getElementById('groupNameInput').value = '';
        }

        function createGroup() {
            const name = document.getElementById('groupNameInput').value.trim();
            if (!name) {
                alert('Bitte Gruppennamen eingeben');
                return;
            }

            const checkboxes = document.querySelectorAll('input[name="groupMember"]:checked');
            if (checkboxes.length === 0) {
                alert('Bitte mindestens ein Mitglied wählen');
                return;
            }

            const groupId = Date.now().toString();
            const members = Array.from(checkboxes).map(cb => cb.value);

            let groups = JSON.parse(localStorage.getItem('messengerGroups') || '[]');
            groups.push({ id: groupId, name, members });
            localStorage.setItem('messengerGroups', JSON.stringify(groups));
            localStorage.setItem(`group_${groupId}`, JSON.stringify({ messages: [] }));

            closeCreateGroupModal();
            loadMessengerData();
        }

        window.addEventListener('load', async function () {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }

            // Lade Berechtigungen zuerst
            await loadUserPermissions();


            renderSidebar();
            renderHomeGrid();
            initializeCalendar();
            populateKaderTeamSelect();
            renderCharts();
            renderTeamsList();
            loadMessengerData();
            setTimeout(() => {
                renderDashboardStats();
            }, 100);
        });

        new MutationObserver(function () {
            renderCharts();
            populateKaderTeamSelect();
        }).observe(document.body, { attributes: true });

        // ========== TAKTIK-TAFEL FUNKTIONEN ==========
        const taktikState = {
            displayMode: 'numbers',
            opponentVisible: false,
            drawMode: false,
            currentDrawTool: 'pen',
            currentColor: '#ef4444',
            currentSize: 4,
            isDrawing: false,
            drawHistory: [],
            actionHistory: [],
            currentPath: [],
            shapeStart: null,
            ownPlayers: [],
            opponentPlayers: [],
            draggedPlayer: null,
            dragStart: null,
            kaderData: [],
            initialized: false
        };

        function initTaktik() {
            const fieldCanvas = document.getElementById('fieldCanvas');
            const drawCanvas = document.getElementById('drawCanvas');
            const canvasWrapper = document.getElementById('canvasWrapper');

            if (!fieldCanvas || !drawCanvas || !canvasWrapper) return;

            if (!taktikState.initialized) {
                taktikState.fieldCanvas = fieldCanvas;
                taktikState.drawCanvas = drawCanvas;
                taktikState.canvasWrapper = canvasWrapper;
                taktikState.fieldCtx = fieldCanvas.getContext('2d');
                taktikState.drawCtx = drawCanvas.getContext('2d');
                taktikState.drawToolbar = document.getElementById('drawToolbar');
                taktikState.drawToggleBtn = document.getElementById('drawToggleBtn');

                loadTaktikKaderData();
                setupTaktikCanvases();
                createTaktikPlayers();
                setupTaktikEventListeners();
                taktikState.initialized = true;
            }

            // Always refresh the field when switching to this view
            setTimeout(function () {
                const rect = canvasWrapper.getBoundingClientRect();
                if (rect.width > 0 && rect.height > 0) {
                    const dpr = window.devicePixelRatio || 1;
                    [taktikState.fieldCanvas, taktikState.drawCanvas].forEach(function (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.setTransform(1, 0, 0, 1, 0, 0);
                        canvas.width = rect.width * dpr;
                        canvas.height = rect.height * dpr;
                        canvas.style.width = rect.width + 'px';
                        canvas.style.height = rect.height + 'px';
                        ctx.scale(dpr, dpr);
                    });
                    drawTaktikField();
                    redrawTaktikAll();
                    repositionTaktikPlayers();
                }
            }, 50);
        }

        function loadTaktikKaderData() {
            try {
                const kader = JSON.parse(localStorage.getItem('kaderPlayers') || '[]');
                taktikState.kaderData = kader.slice(0, 11);
            } catch (e) {
                taktikState.kaderData = [];
            }
        }

        function setupTaktikCanvases() {
            const resize = function () {
                const rect = taktikState.canvasWrapper.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;

                // Skip if element is not visible yet
                if (rect.width === 0 || rect.height === 0) return;

                [taktikState.fieldCanvas, taktikState.drawCanvas].forEach(function (canvas) {
                    const ctx = canvas.getContext('2d');
                    // Reset transform before resizing to prevent scale accumulation
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    canvas.style.width = rect.width + 'px';
                    canvas.style.height = rect.height + 'px';
                    ctx.scale(dpr, dpr);
                });

                drawTaktikField();
                redrawTaktikAll();
                repositionTaktikPlayers();
            };

            resize();
            window.addEventListener('resize', resize);
        }

        function drawTaktikField() {
            const fieldCanvas = taktikState.fieldCanvas;
            const fieldCtx = taktikState.fieldCtx;
            if (!fieldCanvas || !fieldCtx) return;

            const w = fieldCanvas.width / (window.devicePixelRatio || 1);
            const h = fieldCanvas.height / (window.devicePixelRatio || 1);

            fieldCtx.clearRect(0, 0, w, h);

            const gradient = fieldCtx.createLinearGradient(0, 0, w, h);
            gradient.addColorStop(0, '#4a9d4a');
            gradient.addColorStop(1, '#3d8b3d');
            fieldCtx.fillStyle = gradient;
            fieldCtx.fillRect(0, 0, w, h);

            fieldCtx.strokeStyle = 'rgba(255,255,255,0.85)';
            fieldCtx.lineWidth = 2;

            const padding = 25;
            const fieldW = w - padding * 2;
            const fieldH = h - padding * 2;
            const centerX = w / 2;
            const centerY = h / 2;

            fieldCtx.strokeRect(padding, padding, fieldW, fieldH);

            fieldCtx.beginPath();
            fieldCtx.moveTo(centerX, padding);
            fieldCtx.lineTo(centerX, h - padding);
            fieldCtx.stroke();

            const circleRadius = Math.min(fieldW, fieldH) * 0.12;
            fieldCtx.beginPath();
            fieldCtx.arc(centerX, centerY, circleRadius, 0, Math.PI * 2);
            fieldCtx.stroke();

            fieldCtx.fillStyle = 'rgba(255,255,255,0.85)';
            fieldCtx.beginPath();
            fieldCtx.arc(centerX, centerY, 4, 0, Math.PI * 2);
            fieldCtx.fill();

            const penaltyW = fieldW * 0.16;
            const penaltyH = fieldH * 0.44;
            const penaltyY = (h - penaltyH) / 2;
            fieldCtx.strokeRect(padding, penaltyY, penaltyW, penaltyH);
            fieldCtx.strokeRect(w - padding - penaltyW, penaltyY, penaltyW, penaltyH);

            const goalW = fieldW * 0.06;
            const goalH = fieldH * 0.2;
            const goalY = (h - goalH) / 2;
            fieldCtx.strokeRect(padding, goalY, goalW, goalH);
            fieldCtx.strokeRect(w - padding - goalW, goalY, goalW, goalH);
        }

        function createTaktikPlayers() {
            document.querySelectorAll('.player-marker').forEach(function (el) { el.remove(); });

            const formation = [
                { x: 0.08, y: 0.5 },
                { x: 0.22, y: 0.15 }, { x: 0.22, y: 0.38 }, { x: 0.22, y: 0.62 }, { x: 0.22, y: 0.85 },
                { x: 0.42, y: 0.15 }, { x: 0.42, y: 0.38 }, { x: 0.42, y: 0.62 }, { x: 0.42, y: 0.85 },
                { x: 0.60, y: 0.35 }, { x: 0.60, y: 0.65 }
            ];

            taktikState.ownPlayers = formation.map(function (pos, i) {
                return {
                    id: 'own-' + i, number: i + 1, x: pos.x, y: pos.y, team: 'own',
                    name: taktikState.kaderData[i] ? taktikState.kaderData[i].name : ''
                };
            });

            taktikState.opponentPlayers = formation.map(function (pos, i) {
                return { id: 'opp-' + i, number: i + 1, x: 1 - pos.x, y: pos.y, team: 'opponent', name: '' };
            });

            renderTaktikPlayers();
        }

        function findTaktikPlayerById(id) {
            if (!id) return null;
            if (id.startsWith('own')) {
                return taktikState.ownPlayers.find(function (p) { return p.id === id; }) || null;
            }
            return taktikState.opponentPlayers.find(function (p) { return p.id === id; }) || null;
        }

        function renderTaktikPlayers() {
            document.querySelectorAll('.player-marker').forEach(function (el) { el.remove(); });

            const w = taktikState.canvasWrapper.offsetWidth;
            const h = taktikState.canvasWrapper.offsetHeight;

            taktikState.ownPlayers.forEach(function (p) { createTaktikPlayerElement(p, w, h); });
            if (taktikState.opponentVisible) {
                taktikState.opponentPlayers.forEach(function (p) { createTaktikPlayerElement(p, w, h); });
            }
        }

        function createTaktikPlayerElement(player, containerW, containerH) {
            const el = document.createElement('div');
            el.className = 'player-marker ' + (player.team === 'own' ? 'own-team' : 'opponent-team');
            el.dataset.id = player.id;

            el.style.left = (player.x * containerW - 19) + 'px';
            el.style.top = (player.y * containerH - 19) + 'px';

            if (taktikState.displayMode === 'neutral') {
                el.textContent = '';
            } else if (taktikState.displayMode === 'kader' && player.team === 'own' && player.name) {
                el.textContent = player.number;
                const nameLabel = document.createElement('span');
                nameLabel.className = 'player-name';
                nameLabel.textContent = player.name.split(' ').pop();
                el.appendChild(nameLabel);
            } else {
                el.textContent = player.number;
            }

            el.addEventListener('mousedown', startTaktikDrag);
            el.addEventListener('touchstart', startTaktikDrag, { passive: false });

            taktikState.canvasWrapper.appendChild(el);
        }

        function repositionTaktikPlayers() {
            const w = taktikState.canvasWrapper.offsetWidth;
            const h = taktikState.canvasWrapper.offsetHeight;

            const players = taktikState.opponentVisible
                ? taktikState.ownPlayers.concat(taktikState.opponentPlayers)
                : taktikState.ownPlayers;

            players.forEach(function (p) {
                const el = document.querySelector('[data-id="' + p.id + '"]');
                if (el) {
                    el.style.left = (p.x * w - 19) + 'px';
                    el.style.top = (p.y * h - 19) + 'px';
                }
            });
        }

        function startTaktikDrag(e) {
            if (taktikState.drawMode) return;
            e.preventDefault();

            const el = e.target.closest('.player-marker');
            if (!el) return;

            const player = findTaktikPlayerById(el.dataset.id);
            taktikState.draggedPlayer = { element: el, id: el.dataset.id };
            if (player) {
                taktikState.dragStart = { id: player.id, x: player.x, y: player.y };
            }
            el.classList.add('dragging');

            document.addEventListener('mousemove', onTaktikDrag);
            document.addEventListener('mouseup', endTaktikDrag);
            document.addEventListener('touchmove', onTaktikDrag, { passive: false });
            document.addEventListener('touchend', endTaktikDrag);
        }

        function onTaktikDrag(e) {
            if (!taktikState.draggedPlayer) return;
            e.preventDefault();

            const rect = taktikState.canvasWrapper.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            var x = Math.max(19, Math.min(rect.width - 19, clientX - rect.left));
            var y = Math.max(19, Math.min(rect.height - 19, clientY - rect.top));

            taktikState.draggedPlayer.element.style.left = (x - 19) + 'px';
            taktikState.draggedPlayer.element.style.top = (y - 19) + 'px';

            const players = taktikState.draggedPlayer.id.startsWith('own') ? taktikState.ownPlayers : taktikState.opponentPlayers;
            const player = players.find(function (p) { return p.id === taktikState.draggedPlayer.id; });
            if (player) {
                player.x = x / rect.width;
                player.y = y / rect.height;
            }
        }

        function endTaktikDrag() {
            if (taktikState.draggedPlayer) {
                const player = findTaktikPlayerById(taktikState.draggedPlayer.id);
                if (player && taktikState.dragStart) {
                    const moved = Math.abs(player.x - taktikState.dragStart.x) > 0.0001 ||
                        Math.abs(player.y - taktikState.dragStart.y) > 0.0001;
                    if (moved) {
                        taktikState.actionHistory.push({
                            type: 'move',
                            id: player.id,
                            from: { x: taktikState.dragStart.x, y: taktikState.dragStart.y },
                            to: { x: player.x, y: player.y }
                        });
                    }
                }
                taktikState.draggedPlayer.element.classList.remove('dragging');
                taktikState.draggedPlayer = null;
            }
            taktikState.dragStart = null;
            document.removeEventListener('mousemove', onTaktikDrag);
            document.removeEventListener('mouseup', endTaktikDrag);
            document.removeEventListener('touchmove', onTaktikDrag);
            document.removeEventListener('touchend', endTaktikDrag);
        }

        function toggleTaktikDrawMode() {
            taktikState.drawMode = !taktikState.drawMode;

            taktikState.drawToggleBtn.classList.toggle('active', taktikState.drawMode);
            taktikState.drawToolbar.classList.toggle('visible', taktikState.drawMode);
            taktikState.drawCanvas.style.pointerEvents = taktikState.drawMode ? 'auto' : 'none';
            taktikState.drawCanvas.style.cursor = taktikState.drawMode ? 'crosshair' : 'default';

            document.querySelectorAll('.player-marker').forEach(function (p) {
                p.style.pointerEvents = taktikState.drawMode ? 'none' : 'auto';
            });
        }

        function startTaktikDrawing(e) {
            if (!taktikState.drawMode) return;
            taktikState.isDrawing = true;

            const rect = taktikState.drawCanvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

            if (taktikState.currentDrawTool === 'arrow' || taktikState.currentDrawTool === 'line') {
                taktikState.shapeStart = { x: x, y: y };
            } else {
                taktikState.currentPath = [{ x: x, y: y }];
                taktikState.drawCtx.beginPath();
                taktikState.drawCtx.moveTo(x, y);
                taktikState.drawCtx.lineCap = 'round';
                taktikState.drawCtx.lineJoin = 'round';

                if (taktikState.currentDrawTool === 'eraser') {
                    taktikState.drawCtx.globalCompositeOperation = 'destination-out';
                    taktikState.drawCtx.lineWidth = 30;
                } else if (taktikState.currentDrawTool === 'highlight') {
                    taktikState.drawCtx.globalCompositeOperation = 'source-over';
                    taktikState.drawCtx.strokeStyle = taktikState.currentColor + '60';
                    taktikState.drawCtx.lineWidth = taktikState.currentSize * 4;
                } else {
                    taktikState.drawCtx.globalCompositeOperation = 'source-over';
                    taktikState.drawCtx.strokeStyle = taktikState.currentColor;
                    taktikState.drawCtx.lineWidth = taktikState.currentSize;
                }
            }
        }

        function taktikDraw(e) {
            if (!taktikState.isDrawing) return;
            e.preventDefault();

            const rect = taktikState.drawCanvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

            if (taktikState.currentDrawTool === 'arrow' || taktikState.currentDrawTool === 'line') {
                redrawTaktikAll();
                taktikState.drawCtx.strokeStyle = taktikState.currentColor;
                taktikState.drawCtx.lineWidth = taktikState.currentSize;
                taktikState.drawCtx.lineCap = 'round';
                taktikState.drawCtx.beginPath();
                taktikState.drawCtx.moveTo(taktikState.shapeStart.x, taktikState.shapeStart.y);
                taktikState.drawCtx.lineTo(x, y);
                taktikState.drawCtx.stroke();

                if (taktikState.currentDrawTool === 'arrow') {
                    const angle = Math.atan2(y - taktikState.shapeStart.y, x - taktikState.shapeStart.x);
                    const headLen = 15;
                    taktikState.drawCtx.beginPath();
                    taktikState.drawCtx.moveTo(x, y);
                    taktikState.drawCtx.lineTo(x - headLen * Math.cos(angle - Math.PI / 6), y - headLen * Math.sin(angle - Math.PI / 6));
                    taktikState.drawCtx.moveTo(x, y);
                    taktikState.drawCtx.lineTo(x - headLen * Math.cos(angle + Math.PI / 6), y - headLen * Math.sin(angle + Math.PI / 6));
                    taktikState.drawCtx.stroke();
                }
            } else {
                taktikState.currentPath.push({ x: x, y: y });
                taktikState.drawCtx.lineTo(x, y);
                taktikState.drawCtx.stroke();
            }
        }

        function stopTaktikDrawing(e) {
            if (!taktikState.isDrawing) return;
            taktikState.isDrawing = false;

            if ((taktikState.currentDrawTool === 'arrow' || taktikState.currentDrawTool === 'line') && taktikState.shapeStart) {
                const rect = taktikState.drawCanvas.getBoundingClientRect();
                const x = (e.touches ? e.changedTouches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.changedTouches[0].clientY : e.clientY) - rect.top;

                taktikState.drawHistory.push({
                    tool: taktikState.currentDrawTool,
                    color: taktikState.currentColor,
                    size: taktikState.currentSize,
                    start: taktikState.shapeStart,
                    end: { x: x, y: y }
                });
                taktikState.shapeStart = null;
                taktikState.actionHistory.push({ type: 'draw' });
            } else if (taktikState.currentPath.length > 0) {
                taktikState.drawHistory.push({
                    tool: taktikState.currentDrawTool,
                    color: taktikState.currentColor,
                    size: taktikState.currentSize,
                    path: taktikState.currentPath.slice()
                });
                taktikState.actionHistory.push({ type: 'draw' });
            }

            taktikState.drawCtx.globalCompositeOperation = 'source-over';
            redrawTaktikAll();
        }

        function redrawTaktikAll() {
            const drawCanvas = taktikState.drawCanvas;
            const drawCtx = taktikState.drawCtx;
            if (!drawCanvas || !drawCtx) return;

            const w = drawCanvas.width / (window.devicePixelRatio || 1);
            const h = drawCanvas.height / (window.devicePixelRatio || 1);
            drawCtx.clearRect(0, 0, w, h);

            taktikState.drawHistory.forEach(function (stroke) {
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';

                if (stroke.tool === 'eraser') return;

                if (stroke.tool === 'arrow' || stroke.tool === 'line') {
                    drawCtx.strokeStyle = stroke.color;
                    drawCtx.lineWidth = stroke.size;
                    drawCtx.beginPath();
                    drawCtx.moveTo(stroke.start.x, stroke.start.y);
                    drawCtx.lineTo(stroke.end.x, stroke.end.y);
                    drawCtx.stroke();

                    if (stroke.tool === 'arrow') {
                        const angle = Math.atan2(stroke.end.y - stroke.start.y, stroke.end.x - stroke.start.x);
                        const headLen = 15;
                        drawCtx.beginPath();
                        drawCtx.moveTo(stroke.end.x, stroke.end.y);
                        drawCtx.lineTo(stroke.end.x - headLen * Math.cos(angle - Math.PI / 6), stroke.end.y - headLen * Math.sin(angle - Math.PI / 6));
                        drawCtx.moveTo(stroke.end.x, stroke.end.y);
                        drawCtx.lineTo(stroke.end.x - headLen * Math.cos(angle + Math.PI / 6), stroke.end.y - headLen * Math.sin(angle + Math.PI / 6));
                        drawCtx.stroke();
                    }
                } else if (stroke.path && stroke.path.length > 1) {
                    if (stroke.tool === 'highlight') {
                        drawCtx.strokeStyle = stroke.color + '60';
                        drawCtx.lineWidth = stroke.size * 4;
                    } else {
                        drawCtx.strokeStyle = stroke.color;
                        drawCtx.lineWidth = stroke.size;
                    }

                    drawCtx.beginPath();
                    drawCtx.moveTo(stroke.path[0].x, stroke.path[0].y);
                    stroke.path.forEach(function (point) { drawCtx.lineTo(point.x, point.y); });
                    drawCtx.stroke();
                }
            });
        }

        function taktikUndo() {
            if (taktikState.actionHistory.length === 0) return;
            const lastAction = taktikState.actionHistory.pop();
            if (lastAction.type === 'draw') {
                if (taktikState.drawHistory.length > 0) {
                    taktikState.drawHistory.pop();
                    redrawTaktikAll();
                }
                return;
            }
            if (lastAction.type === 'move') {
                const player = findTaktikPlayerById(lastAction.id);
                if (player) {
                    player.x = lastAction.from.x;
                    player.y = lastAction.from.y;
                    repositionTaktikPlayers();
                }
            }
        }

        function taktikClearAll() {
            if (confirm('Alle Zeichnungen löschen?')) {
                taktikState.drawHistory = [];
                taktikState.actionHistory = [];
                createTaktikPlayers();
                redrawTaktikAll();
            }
        }

        function setupTaktikEventListeners() {
            const opponentToggle = document.getElementById('taktikOpponentToggle');
            if (opponentToggle) {
                opponentToggle.addEventListener('change', function (e) {
                    taktikState.opponentVisible = e.target.checked;
                    renderTaktikPlayers();
                });
            }

            document.querySelectorAll('[data-taktik-mode]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('[data-taktik-mode]').forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    taktikState.displayMode = this.dataset.taktikMode;
                    renderTaktikPlayers();
                });
            });

            if (taktikState.drawToggleBtn) {
                taktikState.drawToggleBtn.addEventListener('click', toggleTaktikDrawMode);
            }

            const closeBtn = document.getElementById('closeDrawToolbar');
            if (closeBtn) {
                closeBtn.addEventListener('click', toggleTaktikDrawMode);
            }

            document.querySelectorAll('[data-draw-tool]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('[data-draw-tool]').forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    taktikState.currentDrawTool = this.dataset.drawTool;
                });
            });

            document.querySelectorAll('[data-color]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('[data-color]').forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    taktikState.currentColor = this.dataset.color;
                });
            });

            document.querySelectorAll('[data-size]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('[data-size]').forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    taktikState.currentSize = parseInt(this.dataset.size);
                });
            });

            if (taktikState.drawCanvas) {
                taktikState.drawCanvas.addEventListener('mousedown', startTaktikDrawing);
                taktikState.drawCanvas.addEventListener('mousemove', taktikDraw);
                taktikState.drawCanvas.addEventListener('mouseup', stopTaktikDrawing);
                taktikState.drawCanvas.addEventListener('mouseleave', stopTaktikDrawing);
                taktikState.drawCanvas.addEventListener('touchstart', startTaktikDrawing, { passive: false });
                taktikState.drawCanvas.addEventListener('touchmove', taktikDraw, { passive: false });
                taktikState.drawCanvas.addEventListener('touchend', stopTaktikDrawing);
            }

            const undoBtn = document.getElementById('taktikUndoBtn');
            const clearBtn = document.getElementById('taktikClearBtn');
            if (undoBtn) undoBtn.addEventListener('click', taktikUndo);
            if (clearBtn) clearBtn.addEventListener('click', taktikClearAll);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Video Player Modal - Fullscreen-capable layout -->
    <div id="videoPlayerModal"
        style="display: none; position: fixed; top: 0; left: 280px; right: 0; bottom: 0; background: #000; z-index: 9999;">

        <!-- Video Container (takes full space, will go fullscreen) -->
        <div id="videoPlayerContainer"
            style="position: absolute; top: 0; left: 0; right: 280px; bottom: 0; display: flex; flex-direction: column;">

            <!-- Video Wrapper -->
            <div id="videoWrapper"
                style="flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden;">
                <video id="modalVideo" style="max-width: 100%; max-height: 100%;" controls playsinline></video>
                <canvas id="modalDrawCanvas"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>

                <!-- Floating Toolbar (top right) -->
                <div id="videoToolbar"
                    style="position: absolute; top: 16px; right: 16px; display: flex; gap: 8px; z-index: 100;">
                    <button onclick="addVideoMarker()" id="addMarkerBtn" type="button" title="Marker setzen"
                        style="width: 44px; height: 44px; background: rgba(245,158,11,0.9); border: none; border-radius: 12px; cursor: pointer; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        📍
                    </button>
                    <button onclick="toggleDrawMode()" id="drawModeBtn" type="button" title="Zeichnen"
                        style="width: 44px; height: 44px; background: rgba(0,0,0,0.6); border: none; border-radius: 12px; cursor: pointer; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        ✏️
                    </button>
                    <button onclick="clearVideoDrawing()" type="button" title="Zeichnung löschen"
                        style="width: 44px; height: 44px; background: rgba(0,0,0,0.6); border: none; border-radius: 12px; cursor: pointer; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        🧹
                    </button>
                    <button onclick="toggleVideoFadeMode()" id="fadeModeBtn" type="button" title="Auto-Fade (AN)"
                        style="width: 44px; height: 44px; background: rgba(139,92,246,0.9); border: none; border-radius: 12px; cursor: pointer; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        ⏱️
                    </button>
                    <button onclick="toggleVideoFullscreen()" id="fullscreenBtn" type="button" title="Vollbild"
                        style="width: 44px; height: 44px; background: rgba(0,0,0,0.6); border: none; border-radius: 12px; cursor: pointer; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        ⛶
                    </button>
                </div>

                <!-- Title & Close (top left) -->
                <div
                    style="position: absolute; top: 16px; left: 16px; display: flex; align-items: center; gap: 12px; z-index: 100;">
                    <button onclick="closeVideoPlayer()" type="button" title="Schließen"
                        style="width: 44px; height: 44px; background: rgba(0,0,0,0.6); border: none; border-radius: 12px; cursor: pointer; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        ✕
                    </button>
                    <h2 id="playerVideoTitle"
                        style="margin: 0; font-size: 14px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    </h2>
                </div>

                <!-- Delete Button (top right corner) -->
                <button onclick="deleteCurrentVideo()" type="button" title="Video löschen"
                    style="position: absolute; top: 16px; right: 300px; width: 44px; height: 44px; background: rgba(220,38,38,0.9); border: none; border-radius: 12px; cursor: pointer; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); z-index: 100;">
                    🗑️
                </button>
            </div>

            <!-- Clip Creation Bar (bottom, always visible) -->
            <div id="clipCreationBar"
                style="background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); padding: 12px 20px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <button onclick="setClipStart()"
                    style="padding: 8px 14px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                    ▶ Start
                </button>
                <span id="clipStartTime"
                    style="font-family: monospace; color: #10b981; min-width: 50px; font-size: 14px;">--:--</span>
                <button onclick="setClipEnd()"
                    style="padding: 8px 14px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                    ⏹ Ende
                </button>
                <span id="clipEndTime"
                    style="font-family: monospace; color: #ef4444; min-width: 50px; font-size: 14px;">--:--</span>
                <input type="text" id="clipNote" placeholder="Notiz (optional)"
                    style="flex: 1; min-width: 120px; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 13px;">
                <button onclick="saveVideoClip()" id="saveClipBtn" type="button" disabled
                    style="padding: 8px 18px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; opacity: 0.5; font-size: 13px;">
                    💾 Clip speichern
                </button>
            </div>
        </div>

        <!-- Sidebar (outside fullscreen container) -->
        <div id="videoSidebar"
            style="position: absolute; top: 0; right: 0; width: 280px; height: 100%; background: var(--card-light); border-left: 1px solid var(--border-light); display: flex; flex-direction: column; overflow: hidden; z-index: 50;">

            <!-- Markers Section -->
            <div style="border-bottom: 1px solid var(--border-light);">
                <div style="padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: var(--text-light); font-size: 14px;">📍 Marker</h3>
                    <span id="markerCount" style="color: var(--text-light); opacity: 0.5; font-size: 12px;">0</span>
                </div>
                <div id="videoMarkersList" style="max-height: 180px; overflow-y: auto; padding: 0 12px 12px;">
                    <p
                        style="color: var(--text-light); opacity: 0.4; font-size: 12px; text-align: center; padding: 8px;">
                        Keine Marker</p>
                </div>
            </div>

            <!-- Clips Section -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div
                    style="padding: 12px 16px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: var(--text-light); font-size: 14px;">📎 Clips</h3>
                    <span id="clipCount" style="color: var(--text-light); opacity: 0.5; font-size: 12px;">0</span>
                </div>
                <div id="videoClipsList" style="flex: 1; overflow-y: auto; padding: 12px;">
                    <p style="color: var(--text-light); opacity: 0.4; font-size: 12px; text-align: center;">Keine Clips
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Clip Modal -->
    <div id="shareClipModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; justify-content: center; align-items: center;">
        <div
            style="background: var(--card-light); border: 1px solid var(--border-light); border-radius: 16px; padding: 24px; max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 18px; color: var(--text-light);">📤 Clip teilen</h2>
                <button onclick="closeShareModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); opacity: 0.6;">✕</button>
            </div>
            <p style="color: var(--text-light); opacity: 0.7; margin-bottom: 16px;">Wähle Spieler aus deinem Team:</p>
            <div id="sharePlayersList"
                style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
            </div>
            <input type="text" id="shareMessage" placeholder="Nachricht hinzufügen (optional)"
                style="width: 100%; margin-top: 16px; padding: 12px; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-light);">
            <button onclick="sendClipToPlayers()"
                style="width: 100%; margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #007AFF, #00C7BE); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                📤 An ausgewählte Spieler senden
            </button>
        </div>
    </div>

    <!-- FLOATING ADD WIDGET BUTTON - Home only -->
    <button id="floatingAddWidget" class="add-widget-btn" onclick="openWidgetModal()"
        title="Widget hinzufügen">+</button>

</body>

</html>
